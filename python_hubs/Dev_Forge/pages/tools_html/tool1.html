<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PBIS Ticket Maker (B/W Spine)</title>
<style>
:root{
  --bg:#f3f3f3; --card:#fff; --ink:#111; --muted:#444; --line:#cfcfcf; --r:14px;
  --blue:#0b2a5b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Arial;
  background:var(--bg);
  color:var(--ink);
  overflow:hidden; /* NO SCROLL */
}
.top{
  height:64px; background:#000; color:#fff;
  display:flex; align-items:center; gap:10px; padding:0 14px;
}
.badge{
  width:34px; height:34px; border-radius:999px;
  border:2px solid #fff; display:grid; place-items:center; font-weight:900;
}
.wrap{
  height:calc(100vh - 64px);
  padding:12px;
  display:flex;
  justify-content:center;
}
.card{
  width:min(1100px,100%);
  background:var(--card);
  border:2px solid var(--line);
  border-radius:var(--r);
  padding:12px;
  display:flex;
  flex-direction:column;
  min-height:0;
}
.grid{
  display:flex;
  gap:12px;
  min-height:0;
  flex:1;
}
.col{
  flex:1;
  min-width:0;
  border:2px dotted var(--line);
  border-radius:12px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0;
}
.row{display:flex; gap:10px; min-width:0}
.row.wrap{
  flex-wrap:wrap;
  height:auto;
  padding:0;
  justify-content:flex-start;
}
.btn{
  flex:1; min-width:0;
  border:2px solid #000;
  background:#fff;
  color:#000;
  border-radius:12px;
  padding:12px;
  font-weight:900;
  cursor:pointer;
  user-select:none;
  white-space:nowrap;
}
.btn.on{background:#000;color:#fff}
.small{
  flex:0 0 auto;
  border:2px solid #000;
  background:#fff;
  border-radius:12px;
  padding:10px 12px;
  font-weight:900;
  cursor:pointer;
  user-select:none;
  white-space:nowrap;
}
.small.primary{background:#000;color:#fff}
.small.danger{border-color:#000;background:#fff;color:#000}
input,textarea{
  width:100%;
  border:2px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
  font-size:16px;
}
textarea{
  resize:none;
  height:48px; /* tighter to prevent scroll */
}
.h{margin:0;font-weight:900}
.m{margin:0;color:var(--muted);font-weight:700}
.foot{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
  margin-top:auto; /* pins buttons to bottom */
}

/* PBIS checks block (compact, no scroll) */
.checks{
  border:2px solid var(--line);
  border-radius:12px;
  padding:8px 10px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px 10px;
}
.check{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:900;
  color:#000;
  font-size:0.92rem;
  line-height:1.1;
  min-width:0;
}
.check input{ width:18px; height:18px; accent-color:#000; }

/* PREVIEW COLUMN: canvas always owns the space */
.previewStage{
  position:relative;
  flex:1;
  min-height:0;
  border:2px solid #000;
  border-radius:12px;
  overflow:hidden;
  background:#fff;
}
canvas{width:100%;height:100%;display:block}

/* JPEG overlay (does NOT consume layout height) */
.jpegOverlay{
  position:absolute;
  inset:10px;
  border-radius:12px;
  border:2px solid var(--line);
  background:rgba(255,255,255,0.88); /* slightly more transparent */
  display:none;
  padding:10px;
  overflow:hidden;
}
.jpegOverlay .bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:8px;
}
.jpegOverlay .hint{
  margin:0;
  font-weight:800;
  color:var(--muted);
  font-size:.92rem;
}
.jpegOverlay .close{
  border:2px solid #000;
  background:#fff;
  border-radius:10px;
  padding:8px 10px;
  font-weight:900;
  cursor:pointer;
}
.jpegOverlay img{
  width:100%;
  height:calc(100% - 44px);
  object-fit:contain;
  display:block;
  border-radius:10px;
  background:#fff;
}
</style>
</head>

<body>
<div class="top">
  <div class="badge">PB</div>
  <div>
    <div style="font-weight:900;letter-spacing:.08em">PBIS TICKET MAKER</div>
    <div style="font-weight:700;opacity:.85;font-size:.92rem">B/W Spine • Embed Safe</div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="grid">

      <!-- LEFT -->
      <div class="col" id="left">
        <p class="h" id="status">Tap an activity. Preview updates instantly.</p>

        <div class="row wrap" role="group" aria-label="Activities">
          <button class="btn" id="tCheck" type="button">CHECK IN</button>
          <button class="btn" id="tReflect" type="button">REFLECT</button>
          <button class="btn" id="tGoal" type="button">GOAL</button>
        </div>

        <div class="row">
          <div style="flex:1;min-width:0">
            <p class="m">Student</p>
            <input id="name" placeholder="Name"/>
          </div>
          <div style="flex:1;min-width:0">
            <p class="m">Group</p>
            <input id="group" placeholder="Period"/>
          </div>
        </div>

        <p class="m">PBIS Checks (5)</p>
        <div class="checks" aria-label="PBIS Checks">
          <label class="check"><input type="checkbox" id="c1"/>ENGAGE in SAFTEY</label>
          <label class="check"><input type="checkbox" id="c2"/>LEARN TO EARN</label>
          <label class="check"><input type="checkbox" id="c3"/>ALWAYS RESPECTFUL</label>
          <label class="check"><input type="checkbox" id="c4"/>DO THE RIGHT THING</label>
          <label class="check" style="grid-column:1 / -1;"><input type="checkbox" id="c5"/>MY GOAL POINT</label>
        </div>

        <p class="m">CHECK IN</p><textarea id="a1" placeholder="Today I will…"></textarea>
        <p class="m">REFLECT</p><textarea id="b1" placeholder="What happened?"></textarea>
        <p class="m">GOAL</p><textarea id="g1" placeholder="My goal point is…"></textarea>

        <div class="foot">
          <button class="small" id="preview" type="button">Preview JPEG</button>
          <button class="small primary" id="download" type="button">Download JPEG</button>
          <button class="small danger" id="clear" type="button">Clean Up</button>
        </div>

        <p class="m" id="note">If Sites blocks downloads, use Preview → long-press image → Save.</p>
      </div>

      <!-- RIGHT -->
      <div class="col" id="right">
        <p class="h">Preview</p>

        <div class="previewStage" id="stage">
          <canvas id="cv"></canvas>

          <!-- JPEG overlay (doesn't push anything) -->
          <div class="jpegOverlay" id="jpegBox">
            <div class="bar">
              <p class="hint">JPEG Preview (student)</p>
              <button class="close" id="closeJpeg" type="button">Close</button>
            </div>
            <img id="jpegImg" alt="JPEG Preview"/>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const $=(s,el=document)=>el.querySelector(s);

// state
const S={check:false,reflect:false,goal:false};
const btns={check:$("#tCheck"),reflect:$("#tReflect"),goal:$("#tGoal")};
const f={
  name:$("#name"), group:$("#group"),
  a1:$("#a1"), b1:$("#b1"), g1:$("#g1"),
  c1:$("#c1"), c2:$("#c2"), c3:$("#c3"), c4:$("#c4"), c5:$("#c5"),
};

const cv=$("#cv");
const ctx=cv.getContext("2d",{alpha:false});
let lastJpegURL=null;

// toggle activities
function toggle(k){
  S[k]=!S[k];
  btns[k].classList.toggle("on",S[k]);
  hideJpeg();
  draw("screen");
}
btns.check.onclick=()=>toggle("check");
btns.reflect.onclick=()=>toggle("reflect");
btns.goal.onclick=()=>toggle("goal");

// fit canvas to preview box
function fit(){
  const box=$("#stage").getBoundingClientRect();
  const dpr=Math.max(1,window.devicePixelRatio||1);
  cv.width=Math.floor(box.width*dpr);
  cv.height=Math.floor(box.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw("screen");
}
window.addEventListener("resize",fit);

// simple wrap by char count (stable)
function wrapLines(t,max=62){
  const w=(t||"").replace(/\r/g,"").split(/\s+/).filter(Boolean);
  let out=[], line="";
  for(const word of w){
    const test=line?line+" "+word:word;
    if(test.length>max){ if(line) out.push(line); line=word; }
    else line=test;
  }
  if(line) out.push(line);
  return out;
}

function checkedLabels(){
  const labels=[];
  if(f.c1.checked) labels.push("ENGAGE in SAFTEY");
  if(f.c2.checked) labels.push("LEARN TO EARN");
  if(f.c3.checked) labels.push("ALWAYS RESPECTFUL");
  if(f.c4.checked) labels.push("DO THE RIGHT THING");
  if(f.c5.checked) labels.push("MY GOAL POINT");
  return labels;
}

function hideJpeg(){
  $("#jpegBox").style.display="none";
  if(lastJpegURL){ lastJpegURL=null; }
}
$("#closeJpeg").onclick=hideJpeg;

["input","change"].forEach(evt=>{
  Object.values(f).forEach(el=>el.addEventListener(evt, ()=>{ hideJpeg(); draw("screen"); }));
});

function draw(mode="screen"){
  const w=cv.clientWidth, h=cv.clientHeight;
  const dateStr = new Date().toLocaleDateString();

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,w,h);

  // header: screen = black, download = blue with date
  const headerH = 54;
  if(mode === "download"){
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--blue").trim() || "#0b2a5b";
    ctx.fillRect(0,0,w,headerH);
    ctx.fillStyle="#fff";
    ctx.font="900 14px system-ui";
    ctx.textAlign="left";
    ctx.fillText("PBIS TICKET", 12, 22);
    ctx.font="700 12px system-ui";
    ctx.fillText("W.L.E.A.D.", 12, 42);

    ctx.textAlign="right";
    ctx.font="900 12px system-ui";
    ctx.fillText("Date: " + dateStr, w-12, 22);
    ctx.textAlign="left";
  }else{
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,w,headerH);
    ctx.fillStyle="#fff";
    ctx.font="900 14px system-ui";
    ctx.textAlign="left";
    ctx.fillText("PBIS TICKET", 12, 22);
    ctx.font="700 12px system-ui";
    ctx.fillText("W.L.E.A.D. • B/W Spine", 12, 42);
  }

  // meta
  ctx.fillStyle="#111";
  ctx.font="900 13px system-ui";
  ctx.fillText("Student: " + (f.name.value.trim()||"__________"), 12, 78);
  ctx.font="700 12px system-ui";
  ctx.fillText(
    "Group: " + (f.group.value.trim()||"—") + "   Date: " + dateStr,
    12, 98
  );

  // divider
  ctx.strokeStyle="#cfcfcf";
  ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(12,112); ctx.lineTo(w-12,112); ctx.stroke();

  let y=134;

  // PBIS CHECKS line(s)
  const checks = checkedLabels();
  if(checks.length){
    ctx.fillStyle="#000";
    ctx.font="900 12px system-ui";
    ctx.fillText("PBIS CHECKS:", 12, y); y+=18;

    ctx.font="700 12px system-ui";
    const joined = checks.join(" • ");
    const checkLines = wrapLines(joined, 62).slice(0,2);
    for(const ln of checkLines){ ctx.fillText(ln, 12, y); y+=16; }
    y+=10;

    // divider
    ctx.strokeStyle="#cfcfcf";
    ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(12,y); ctx.lineTo(w-12,y); ctx.stroke();
    y += 22;
  }

  // body sections
  ctx.fillStyle="#000";
  ctx.font="900 12px system-ui";

  const any = S.check || S.reflect || S.goal;

  if(S.check){
    ctx.fillText("CHECK IN:", 12, y); y+=18;
    ctx.font="700 12px system-ui";
    for(const ln of wrapLines(f.a1.value,62).slice(0,3)){ ctx.fillText(ln, 12, y); y+=16; }
    y+=10; ctx.font="900 12px system-ui";
  }
  if(S.reflect){
    ctx.fillText("REFLECT:", 12, y); y+=18;
    ctx.font="700 12px system-ui";
    for(const ln of wrapLines(f.b1.value,62).slice(0,3)){ ctx.fillText(ln, 12, y); y+=16; }
    y+=10; ctx.font="900 12px system-ui";
  }
  if(S.goal){
    ctx.fillText("GOAL:", 12, y); y+=18;
    ctx.font="700 12px system-ui";
    for(const ln of wrapLines(f.g1.value,62).slice(0,3)){ ctx.fillText(ln, 12, y); y+=16; }
    y+=10; ctx.font="900 12px system-ui";
  }

  if(!any){
    ctx.fillStyle="#111";
    ctx.font="900 13px system-ui";
    ctx.fillText("Tap CHECK IN / REFLECT / GOAL to add sections.", 12, y);
  }

  $("#status").textContent =
    ("Selected: " + (S.check?"CHECK IN ":"") + (S.reflect?"REFLECT ":"") + (S.goal?"GOAL":"")).trim()
    || "Tap an activity. Preview updates instantly.";
}

// Preview JPEG (overlay) — uses current screen styling
$("#preview").onclick=()=>{
  draw("screen");
  try{
    $("#jpegImg").src = cv.toDataURL("image/jpeg",0.92);
    $("#jpegBox").style.display="block";
  }catch(e){
    alert("Preview failed.");
  }
};

// Download JPEG — renders with BLUE banner + date at top
$("#download").onclick=()=>{
  draw("download"); // special header ONLY for download

  const base=(f.name.value.trim()||"pbis_ticket").replace(/\s+/g,"_");
  const file=base+".jpg";

  const finish = ()=> { setTimeout(()=>draw("screen"), 40); }; // restore preview look

  if(cv.toBlob){
    cv.toBlob(blob=>{
      if(!blob){ alert("Download failed."); finish(); return; }
      const url=URL.createObjectURL(blob);
      lastJpegURL=url;
      const a=document.createElement("a");
      a.href=url; a.download=file;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>{ try{URL.revokeObjectURL(url);}catch(e){} }, 1200);
      finish();
    },"image/jpeg",0.92);
  }else{
    try{
      const a=document.createElement("a");
      a.href=cv.toDataURL("image/jpeg",0.92);
      a.download=file;
      document.body.appendChild(a); a.click(); a.remove();
    }catch(e){
      alert("Download failed.");
    }
    finish();
  }
};

// Clear
$("#clear").onclick=()=>{
  f.name.value=""; f.group.value="";
  f.a1.value=""; f.b1.value=""; f.g1.value="";
  f.c1.checked=f.c2.checked=f.c3.checked=f.c4.checked=f.c5.checked=false;
  S.check=S.reflect=S.goal=false;
  Object.values(btns).forEach(b=>b.classList.remove("on"));
  hideJpeg();
  draw("screen");
};

// init
setTimeout(()=>{ fit(); draw("screen"); }, 60);
</script>
</body>
</html>
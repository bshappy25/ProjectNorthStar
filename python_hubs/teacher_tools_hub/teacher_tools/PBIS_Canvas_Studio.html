<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Landscape Lesson Export ‚Äî PBIS + 3 Images (AI-Ready)</title>

<style>
  :root{
    --bg:#f3f3f3;
    --card:#ffffff;
    --line:#cfcfcf;
    --ink:#111;
    --muted:#555;

    --blue:#0b2a5b;   /* PBIS-style export banner */
    --black:#000;

    --r:14px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    background:var(--bg);
    color:var(--ink);
    overflow:hidden; /* page does NOT scroll; left column will */
  }

  /* ===== TOP BAR ===== */
  .top{
    height:64px;
    background:var(--black);
    color:#fff;
    display:flex;
    align-items:center;
    gap:12px;
    padding:0 14px;
    user-select:none;
  }
  .badge{
    width:34px;height:34px;border-radius:999px;
    border:2px solid #fff;
    display:grid;place-items:center;
    font-weight:1000;
    letter-spacing:.06em;
  }
  .top .title{
    min-width:0;
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .top .t1{
    font-weight:1000;
    letter-spacing:.08em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .top .t2{
    font-weight:800;
    opacity:.85;
    font-size:.92rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* ===== MAIN LAYOUT ===== */
  .wrap{
    height:calc(100vh - 64px);
    padding:12px;
    display:flex;
    justify-content:center;
    align-items:stretch;
  }
  .card{
    width:min(1280px, 100%);
    background:var(--card);
    border:2px solid var(--line);
    border-radius:var(--r);
    padding:12px;
    display:flex;
    min-height:0;
    gap:12px;
  }

  /* Left scrolls */
  .left{
    flex:1 1 520px;
    min-width:340px;
    border:2px dotted var(--line);
    border-radius:12px;
    padding:12px;
    min-height:0;
    overflow:auto; /* ‚úÖ allow scrolling on LEFT */
  }

  /* Right is locked/sticky */
  .right{
    flex:0 0 520px;
    min-width:360px;
    border:2px dotted var(--line);
    border-radius:12px;
    padding:12px;
    min-height:0;
    position:relative;
  }
  .rightSticky{
    position:sticky;
    top:12px; /* ‚úÖ lock preview at top (right) */
    display:flex;
    flex-direction:column;
    gap:10px;
    min-height:0;
    height:calc(100vh - 64px - 24px - 24px); /* viewport - topbar - wrap padding - card padding-ish */
  }

  /* ===== INPUTS ===== */
  .h{margin:0;font-weight:1000}
  .m{margin:0;color:var(--muted);font-weight:800}

  label{
    display:block;
    margin:10px 0 6px;
    font-size:12px;
    font-weight:1000;
    color:#222;
    letter-spacing:.02em;
  }
  input[type="text"], textarea, select{
    width:100%;
    border:2px solid var(--line);
    border-radius:12px;
    padding:10px 12px;
    font-size:16px;
    background:#fff;
    color:var(--ink);
    outline:none;
  }
  textarea{resize:vertical; min-height:96px}

  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .row > *{flex:1; min-width:220px}

  /* PBIS checks (compact) */
  .checks{
    border:2px solid var(--line);
    border-radius:12px;
    padding:8px 10px;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px 10px;
    background:#fff;
  }
  .check{
    display:flex;
    align-items:center;
    gap:8px;
    font-weight:1000;
    color:#000;
    font-size:.92rem;
    line-height:1.1;
    min-width:0;
  }
  .check input{width:18px;height:18px;accent-color:#000}

  /* ===== CLEAN BUTTONS ===== */
  .btnRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-start;
    margin-top:12px;
  }
  .btn{
    border:2px solid #000;
    background:#fff;
    color:#000;
    border-radius:12px;
    padding:10px 12px;
    font-weight:1000;
    cursor:pointer;
    user-select:none;
    white-space:nowrap;
  }
  .btn.primary{background:#000;color:#fff}
  .btn.blue{background:var(--blue);border-color:var(--blue);color:#fff}
  .btn:active{transform:translateY(1px)}
  .mini{
    font-weight:900;
    color:var(--muted);
    font-size:.92rem;
    margin:8px 0 0;
  }

  /* ===== IMAGE LOADER (ONE chooser) ===== */
  .imgPanel{
    border:2px solid var(--line);
    border-radius:12px;
    padding:10px;
    background:#fff;
  }
  .thumbs{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .thumb{
    width:92px;
    height:68px;
    border:2px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    background:#fff;
    cursor:pointer;
    position:relative;
  }
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .thumb.sel{
    border-color:#000;
    box-shadow:0 0 0 3px rgba(0,0,0,.12);
  }
  .thumb .tag{
    position:absolute;
    left:6px;
    bottom:6px;
    background:rgba(0,0,0,.78);
    color:#fff;
    font-size:10px;
    padding:2px 7px;
    border-radius:999px;
    font-weight:1000;
    letter-spacing:.08em;
    text-transform:uppercase;
  }

  /* ===== PREVIEW STAGE ===== */
  .stage{
    flex:1 1 auto;
    min-height:0;
    border:2px solid #000;
    border-radius:12px;
    overflow:hidden;
    background:#fff;
    position:relative;
  }

  /* Live preview (HTML) */
  .preview{
    position:absolute;
    inset:0;
    display:flex;
    flex-direction:column;
    background:#fff;
  }
  .pBanner{
    height:54px;
    background:#000; /* preview stays simple (black) */
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 12px;
    gap:10px;
    border-bottom:2px solid #fff;
  }
  .pBanner .left{
    display:flex;align-items:center;gap:10px;min-width:0;
  }
  .pChip{
    border:2px solid #fff;
    border-radius:999px;
    padding:6px 10px;
    font-weight:1000;
    font-size:12px;
    letter-spacing:.08em;
    white-space:nowrap;
  }
  .pTitle{
    font-weight:1000;
    letter-spacing:.06em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .pDate{
    font-weight:900;
    opacity:.92;
    white-space:nowrap;
  }

  .pBody{
    flex:1;
    min-height:0;
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:10px;
    padding:10px;
  }

  .pText{
    border:2px solid var(--line);
    border-radius:12px;
    padding:10px;
    overflow:hidden;
  }
  .pText .k{
    font-size:11px;
    font-weight:1000;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:var(--muted);
    margin:0 0 6px;
  }
  .pText .v{
    margin:0;
    font-weight:900;
    white-space:pre-wrap;
    line-height:1.25;
    max-height:72px;
    overflow:hidden;
  }

  .pImages{
    border:2px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    display:grid;
    grid-template-rows: 1.1fr .9fr;
    gap:8px;
    padding:8px;
    background:#fff;
  }
  .slot{
    border:2px dashed var(--line);
    border-radius:12px;
    overflow:hidden;
    position:relative;
    background:#fff;
  }
  .slot img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .slot .slotLabel{
    position:absolute;
    left:8px;
    top:8px;
    background:rgba(0,0,0,.72);
    color:#fff;
    font-size:10px;
    padding:2px 7px;
    border-radius:999px;
    font-weight:1000;
    letter-spacing:.08em;
    text-transform:uppercase;
  }

  .twoSmall{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    min-height:0;
  }

  /* confirm overlay (doesn't save until confirm) */
  .confirm{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(255,255,255,.86);
    padding:10px;
  }
  .confirmBox{
    width:min(360px, 92%);
    border:2px solid #000;
    border-radius:14px;
    background:#fff;
    padding:12px;
  }
  .confirmBox p{margin:0 0 10px;font-weight:1000}
  .confirmBtns{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
  .confirmBtns .btn{min-width:120px}

  /* hidden export host */
  #exportHost{position:fixed;left:-99999px;top:0;z-index:-1}
  .exportFrame{
    width:1920px;
    height:1080px;
    background:#fff;
    overflow:hidden;
    position:relative;
    border:1px solid #e5e7eb;
  }
  .exportBanner{
    height:74px;
    background:var(--blue); /* ‚úÖ BLUE ONLY for export */
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 18px;
    border-bottom:6px solid #000;
  }
  .exportBanner .L{
    display:flex;align-items:center;gap:12px;min-width:0;
  }
  .exportBanner .B{
    width:44px;height:44px;border-radius:999px;
    border:3px solid #fff;
    display:grid;place-items:center;
    font-weight:1000;
    letter-spacing:.06em;
  }
  .exportBanner .T{
    display:flex;flex-direction:column;gap:4px;min-width:0;
  }
  .exportBanner .T1{
    font-weight:1000;
    letter-spacing:.10em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .exportBanner .T2{
    font-weight:900;
    opacity:.92;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .exportBanner .R{
    font-weight:1000;
    letter-spacing:.04em;
    white-space:nowrap;
  }
  .exportBody{
    height:calc(100% - 74px);
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:18px;
    padding:18px;
  }
  .exportTextCol{
    border-right:4px dotted #d1d5db;
    padding-right:18px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .box{
    border:2px solid #e5e7eb;
    border-radius:18px;
    padding:14px 14px;
    min-height:120px;
  }
  .box .k{
    font-size:12px;
    font-weight:1000;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:#6b7280;
    margin:0 0 10px;
  }
  .box .v{
    margin:0;
    font-weight:900;
    font-size:18px;
    line-height:1.25;
    white-space:pre-wrap;
    overflow:hidden;
    max-height:240px;
  }
  .exportImgs{
    display:grid;
    grid-template-rows: 1.2fr .8fr;
    gap:14px;
    padding-left:0;
  }
  .imgBox{
    border:2px solid #e5e7eb;
    border-radius:18px;
    overflow:hidden;
    background:#fff;
    position:relative;
  }
  .imgBox img{width:100%;height:100%;object-fit:cover;display:block}
  .imgBox .tag{
    position:absolute;left:14px;top:14px;
    background:rgba(0,0,0,.72);
    color:#fff;
    padding:6px 10px;
    border-radius:999px;
    font-weight:1000;
    letter-spacing:.10em;
    text-transform:uppercase;
    font-size:11px;
  }
  .twoRow{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:14px;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>
  <div class="top">
    <div class="badge">PB</div>
    <div class="title">
      <div class="t1">LANDSCAPE LESSON EXPORT</div>
      <div class="t2">PBIS badge only ‚Ä¢ 3 images max ‚Ä¢ Confirm before saving ‚Ä¢ AI-readable output</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">

      <!-- LEFT (scrollable) -->
      <div class="left">
        <p class="h">Text Log (scrolls)</p>
        <p class="m">Fill this out. The Export includes BOTH text + images.</p>

        <div class="row">
          <div>
            <label>Teacher / Owner</label>
            <input id="teacher" type="text" placeholder="e.g., Ms. Rivera"/>
          </div>
          <div>
            <label>Date</label>
            <input id="dateStr" type="text" placeholder="YYYY-MM-DD (auto)"/>
          </div>
        </div>

        <label>PBIS Checks (5)</label>
        <div class="checks" aria-label="PBIS Checks">
          <label class="check"><input type="checkbox" id="c1"/>ENGAGE in SAFTEY</label>
          <label class="check"><input type="checkbox" id="c2"/>LEARN TO EARN</label>
          <label class="check"><input type="checkbox" id="c3"/>ALWAYS RESPECTFUL</label>
          <label class="check"><input type="checkbox" id="c4"/>DO THE RIGHT THING</label>
          <label class="check" style="grid-column:1 / -1;"><input type="checkbox" id="c5"/>MY GOAL POINT</label>
        </div>

        <label>Standard / Goal</label>
        <input id="standard" type="text" placeholder="e.g., Behavior goal / PBIS focus"/>

        <label>Objective (one sentence)</label>
        <input id="objective" type="text" placeholder="Students will..."/>

        <label>CHECK IN</label>
        <textarea id="a1" placeholder="Today I will‚Ä¶"></textarea>

        <label>REFLECT</label>
        <textarea id="b1" placeholder="What happened?"></textarea>

        <label>GOAL</label>
        <textarea id="g1" placeholder="My goal point is‚Ä¶"></textarea>

        <label>Notes (short)</label>
        <textarea id="notes" placeholder="Any extra notes..."></textarea>

        <div class="btnRow">
          <button class="btn blue" id="exportBtn" type="button">üñºÔ∏è Export LANDSCAPE JPG (AI)</button>
          <button class="btn primary" id="saveDraftBtn" type="button">Save Draft</button>
          <button class="btn" id="clearAllBtn" type="button">Clean Up</button>
        </div>

        <p class="mini" id="saveStamp">‚Äî</p>
        <p class="mini">Google Sites tip: If download is blocked, Export still generates‚Äîyour browser may open it in a new tab. Save from there.</p>
      </div>

      <!-- RIGHT (locked preview) -->
      <div class="right">
        <div class="rightSticky">
          <p class="h" style="margin:0;">Preview (locked)</p>
          <p class="m" style="margin:0;">One chooser ‚Üí select image ‚Üí tap a slot ‚Üí Confirm (only then saved).</p>

          <div class="imgPanel">
            <label style="margin-top:0;">Choose Images (max 3)</label>
            <input id="imgUpload" type="file" accept="image/*" multiple />
            <div class="thumbs" id="thumbs"></div>
            <p class="mini" id="armed">No image selected.</p>
          </div>

          <div class="stage">
            <div class="preview" id="preview">
              <div class="pBanner">
                <div class="left">
                  <div class="pChip">PBIS</div>
                  <div class="pTitle" id="pTitle">Lesson Export Preview</div>
                </div>
                <div class="pDate" id="pDate">Date: ‚Äî</div>
              </div>

              <div class="pBody">
                <div style="display:flex;flex-direction:column;gap:10px;min-height:0;">
                  <div class="pText">
                    <p class="k">Standard / Goal</p>
                    <p class="v" id="pStandard">‚Äî</p>
                  </div>
                  <div class="pText">
                    <p class="k">Objective</p>
                    <p class="v" id="pObjective">‚Äî</p>
                  </div>
                  <div class="pText">
                    <p class="k">PBIS Checks</p>
                    <p class="v" id="pChecks">‚Äî</p>
                  </div>
                  <div class="pText">
                    <p class="k">Student Text</p>
                    <p class="v" id="pStudentText">‚Äî</p>
                  </div>
                </div>

                <div class="pImages">
                  <div class="slot" id="slotBig" data-slot="big" role="button" tabindex="0" aria-label="Big image slot">
                    <div class="slotLabel">Large</div>
                  </div>
                  <div class="twoSmall">
                    <div class="slot" id="slotS1" data-slot="s1" role="button" tabindex="0" aria-label="Small image slot 1">
                      <div class="slotLabel">Small 1</div>
                    </div>
                    <div class="slot" id="slotS2" data-slot="s2" role="button" tabindex="0" aria-label="Small image slot 2">
                      <div class="slotLabel">Small 2</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- confirm overlay -->
              <div class="confirm" id="confirm">
                <div class="confirmBox">
                  <p id="confirmMsg">Confirm placement?</p>
                  <div class="confirmBtns">
                    <button class="btn" id="cancelPlace" type="button">Cancel</button>
                    <button class="btn primary" id="confirmPlace" type="button">Confirm</button>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="btnRow" style="margin:0; justify-content:flex-end;">
            <button class="btn" id="unselectBtn" type="button">Unselect Image</button>
            <button class="btn" id="clearImgsBtn" type="button">Clear Images</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="exportHost"></div>

<script>
  const $ = (s, el=document)=> el.querySelector(s);

  // ---------- storage ----------
  const store = {
    get(k, fb=null){
      try{ const v=localStorage.getItem(k); return v?JSON.parse(v):fb; }catch(e){ return fb; }
    },
    set(k, v){
      try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){}
    }
  };

  // ---------- date ----------
  function todayISO(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  $("#dateStr").value = todayISO();

  // ---------- form refs ----------
  const F = {
    teacher: $("#teacher"),
    dateStr: $("#dateStr"),
    standard: $("#standard"),
    objective: $("#objective"),
    a1: $("#a1"),
    b1: $("#b1"),
    g1: $("#g1"),
    notes: $("#notes"),
    c1: $("#c1"), c2: $("#c2"), c3: $("#c3"), c4: $("#c4"), c5: $("#c5"),
  };

  function checksSelected(){
    const out=[];
    if(F.c1.checked) out.push("ENGAGE in SAFTEY");
    if(F.c2.checked) out.push("LEARN TO EARN");
    if(F.c3.checked) out.push("ALWAYS RESPECTFUL");
    if(F.c4.checked) out.push("DO THE RIGHT THING");
    if(F.c5.checked) out.push("MY GOAL POINT");
    return out;
  }

  function clamp(s, n){
    s=(s||"").trim();
    if(!s) return "‚Äî";
    if(s.length<=n) return s;
    return s.slice(0, n-1) + "‚Ä¶";
  }

  function studentText(){
    const parts=[];
    const a=F.a1.value.trim(), b=F.b1.value.trim(), g=F.g1.value.trim();
    if(a) parts.push("CHECK IN: " + a);
    if(b) parts.push("REFLECT: " + b);
    if(g) parts.push("GOAL: " + g);
    const n=F.notes.value.trim();
    if(n) parts.push("NOTES: " + n);
    return parts.join("\n\n") || "‚Äî";
  }

  // ---------- image library (max 3) ----------
  let library = store.get("pns_img_lib_v1", []); // [{id,name,dataUrl}]
  let armedId = null;

  // confirmed placements (persisted)
  let placements = store.get("pns_img_slots_v1", { big:null, s1:null, s2:null }); // slot -> imgId

  // pending placement (NOT saved until confirm)
  let pending = null; // {slot, imgId}

  function uuid(){
    return (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2);
  }

  function fileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }

  function renderThumbs(){
    const wrap=$("#thumbs");
    wrap.innerHTML="";
    library.forEach(item=>{
      const d=document.createElement("div");
      d.className="thumb" + (armedId===item.id ? " sel":"");
      d.title="Tap to select";
      const img=document.createElement("img");
      img.src=item.dataUrl;

      const tag=document.createElement("div");
      tag.className="tag";
      tag.textContent="Tap";

      d.appendChild(img);
      d.appendChild(tag);

      d.addEventListener("click", ()=>{
        armedId = (armedId===item.id) ? null : item.id;
        renderThumbs();
        updateArmed();
      });

      wrap.appendChild(d);
    });
    updateArmed();
  }

  function updateArmed(){
    const msg=$("#armed");
    if(!armedId){
      msg.textContent="No image selected.";
      return;
    }
    const item=library.find(x=>x.id===armedId);
    msg.textContent = item ? ("Selected: " + item.name) : "Selected image.";
  }

  $("#imgUpload").addEventListener("change", async (e)=>{
    const files = Array.from(e.target.files || []);
    for(const f of files){
      if(library.length >= 3) break; // max 3
      const dataUrl = await fileToDataURL(f);
      library.push({ id: uuid(), name: f.name, dataUrl });
    }
    store.set("pns_img_lib_v1", library);
    e.target.value="";
    renderThumbs();
    syncPreview();
  });

  $("#unselectBtn").addEventListener("click", ()=>{
    armedId=null;
    renderThumbs();
  });

  $("#clearImgsBtn").addEventListener("click", ()=>{
    armedId=null;
    placements={big:null,s1:null,s2:null};
    library=[];
    store.set("pns_img_lib_v1", library);
    store.set("pns_img_slots_v1", placements);
    renderThumbs();
    syncPreview();
  });

  // ---------- confirm gating ----------
  function showConfirm(slot, imgId){
    pending = { slot, imgId };
    const item = library.find(x=>x.id===imgId);
    $("#confirmMsg").textContent = item ? `Place "${item.name}" into ${slot.toUpperCase()} slot?` : "Confirm placement?";
    $("#confirm").style.display="flex";
  }
  function hideConfirm(){
    pending=null;
    $("#confirm").style.display="none";
  }
  $("#cancelPlace").addEventListener("click", hideConfirm);

  $("#confirmPlace").addEventListener("click", ()=>{
    if(!pending) return;
    placements[pending.slot] = pending.imgId;
    store.set("pns_img_slots_v1", placements); // ‚úÖ only saved on confirm
    hideConfirm();
    syncPreview();
  });

  function slotClicked(slot){
    if(!armedId) return;
    showConfirm(slot, armedId);
  }

  // slot handlers
  ["big","s1","s2"].forEach(key=>{
    const el = key==="big" ? $("#slotBig") : (key==="s1" ? $("#slotS1") : $("#slotS2"));
    el.addEventListener("click", ()=> slotClicked(key));
    el.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" || e.key===" "){ e.preventDefault(); slotClicked(key); }
    });
  });

  // ---------- preview rendering ----------
  function slotFill(el, imgId){
    // keep label
    const label = el.querySelector(".slotLabel");
    el.innerHTML="";
    el.appendChild(label);

    if(!imgId){
      // empty
      return;
    }
    const item = library.find(x=>x.id===imgId);
    if(!item) return;

    const img=document.createElement("img");
    img.src=item.dataUrl;
    el.appendChild(img);
  }

  function syncPreview(){
    const teacher = clamp(F.teacher.value, 60);
    const dateStr = (F.dateStr.value || todayISO()).trim();
    $("#pTitle").textContent = teacher==="‚Äî" ? "Lesson Export Preview" : teacher;
    $("#pDate").textContent = "Date: " + dateStr;

    $("#pStandard").textContent = clamp(F.standard.value, 240);
    $("#pObjective").textContent = clamp(F.objective.value, 300);

    const checks = checksSelected();
    $("#pChecks").textContent = checks.length ? clamp(checks.join(" ‚Ä¢ "), 280) : "‚Äî";

    $("#pStudentText").textContent = clamp(studentText(), 500);

    slotFill($("#slotBig"), placements.big);
    slotFill($("#slotS1"), placements.s1);
    slotFill($("#slotS2"), placements.s2);
  }

  Object.values(F).forEach(el=>{
    el.addEventListener("input", syncPreview);
    el.addEventListener("change", syncPreview);
  });

  // ---------- Draft save / restore ----------
  function collectDraft(){
    return {
      teacher: F.teacher.value || "",
      dateStr: F.dateStr.value || "",
      standard: F.standard.value || "",
      objective: F.objective.value || "",
      a1: F.a1.value || "",
      b1: F.b1.value || "",
      g1: F.g1.value || "",
      notes: F.notes.value || "",
      checks: {
        c1: !!F.c1.checked, c2: !!F.c2.checked, c3: !!F.c3.checked, c4: !!F.c4.checked, c5: !!F.c5.checked,
      }
    };
  }

  function applyDraft(d){
    if(!d) return;
    F.teacher.value = d.teacher || "";
    F.dateStr.value = d.dateStr || todayISO();
    F.standard.value = d.standard || "";
    F.objective.value = d.objective || "";
    F.a1.value = d.a1 || "";
    F.b1.value = d.b1 || "";
    F.g1.value = d.g1 || "";
    F.notes.value = d.notes || "";

    const c = d.checks || {};
    F.c1.checked=!!c.c1; F.c2.checked=!!c.c2; F.c3.checked=!!c.c3; F.c4.checked=!!c.c4; F.c5.checked=!!c.c5;
  }

  $("#saveDraftBtn").addEventListener("click", ()=>{
    store.set("pns_draft_v1", collectDraft());
    const stamp = new Date().toLocaleString();
    store.set("pns_saved_at_v1", stamp);
    $("#saveStamp").textContent = "Saved: " + stamp;
  });

  function restoreAll(){
    const d = store.get("pns_draft_v1", null);
    if(d) applyDraft(d);
    const stamp = store.get("pns_saved_at_v1", "‚Äî");
    $("#saveStamp").textContent = stamp==="‚Äî" ? "‚Äî" : ("Saved: " + stamp);

    // restore images/placements
    library = store.get("pns_img_lib_v1", []);
    placements = store.get("pns_img_slots_v1", {big:null,s1:null,s2:null});
    renderThumbs();
    syncPreview();
  }

  // ---------- CLEAN UP ----------
  $("#clearAllBtn").addEventListener("click", ()=>{
    // text only (keep images unless you hit Clear Images)
    F.teacher.value=""; F.dateStr.value=todayISO();
    F.standard.value=""; F.objective.value="";
    F.a1.value=""; F.b1.value=""; F.g1.value=""; F.notes.value="";
    F.c1.checked=F.c2.checked=F.c3.checked=F.c4.checked=F.c5.checked=false;
    store.set("pns_draft_v1", collectDraft());
    syncPreview();
  });

  // ---------- EXPORT LANDSCAPE (SINGLE CANVAS EXPORT) ----------
  function makeExportFrame(){
    const teacher = (F.teacher.value || "Teacher").trim();
    const dateStr = (F.dateStr.value || todayISO()).trim();
    const standard = clamp(F.standard.value, 420);
    const objective = clamp(F.objective.value, 520);
    const checks = checksSelected();
    const checksStr = checks.length ? checks.join(" ‚Ä¢ ") : "‚Äî";
    const body = studentText();

    const frame = document.createElement("div");
    frame.className="exportFrame";

    // images (resolved dataUrls)
    const resolveUrl = (imgId)=>{
      const item = library.find(x=>x.id===imgId);
      return item ? item.dataUrl : "";
    };

    const bigUrl = resolveUrl(placements.big);
    const s1Url  = resolveUrl(placements.s1);
    const s2Url  = resolveUrl(placements.s2);

    frame.innerHTML = `
      <div class="exportBanner">
        <div class="L">
          <div class="B">PB</div>
          <div class="T">
            <div class="T1">PBIS TICKET ‚Ä¢ LANDSCAPE EXPORT</div>
            <div class="T2">${escapeHtml(teacher)} ‚Ä¢ W.L.E.A.D.</div>
          </div>
        </div>
        <div class="R">Date: ${escapeHtml(dateStr)}</div>
      </div>

      <div class="exportBody">
        <div class="exportTextCol">
          <div class="box">
            <p class="k">Standard / Goal</p>
            <p class="v">${escapeHtml(standard)}</p>
          </div>
          <div class="box">
            <p class="k">Objective</p>
            <p class="v">${escapeHtml(objective)}</p>
          </div>
          <div class="box" style="min-height:140px;">
            <p class="k">PBIS Checks</p>
            <p class="v">${escapeHtml(clamp(checksStr, 520))}</p>
          </div>
          <div class="box" style="flex:1; min-height:280px;">
            <p class="k">Student Text Log</p>
            <p class="v">${escapeHtml(clamp(body, 1600))}</p>
          </div>
        </div>

        <div class="exportImgs">
          <div class="imgBox">
            <div class="tag">Large</div>
            ${bigUrl ? `<img src="${bigUrl}" alt="Large"/>` : ``}
          </div>
          <div class="twoRow">
            <div class="imgBox">
              <div class="tag">Small 1</div>
              ${s1Url ? `<img src="${s1Url}" alt="Small 1"/>` : ``}
            </div>
            <div class="imgBox">
              <div class="tag">Small 2</div>
              ${s2Url ? `<img src="${s2Url}" alt="Small 2"/>` : ``}
            </div>
          </div>
        </div>
      </div>
    `;
    return frame;
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function exportLandscape(){
    const host = document.getElementById("exportHost");
    host.innerHTML="";
    const frame = makeExportFrame();
    host.appendChild(frame);

    const dpr = Math.min(3, (window.devicePixelRatio || 2) + 1);
    const canvas = await html2canvas(frame, {
      backgroundColor:"#ffffff",
      scale:dpr,
      useCORS:true,
      imageTimeout:20000,
      removeContainer:true
    });

    const teacher = (F.teacher.value || "Teacher").trim().replace(/\s+/g,"_");
    const dateStr = (F.dateStr.value || todayISO()).trim();
    const filename = `PBIS_Landscape_${teacher}_${dateStr}_1920x1080.jpg`;

    canvas.toBlob((blob)=>{
      if(!blob){
        alert("Export failed (no blob). Try fewer/lower-res images.");
        host.innerHTML="";
        return;
      }
      const url = URL.createObjectURL(blob);

      // normal download attempt
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.rel = "noopener";
      document.body.appendChild(a);
      a.click();
      a.remove();

      // cleanup
      setTimeout(()=>{
        try{ URL.revokeObjectURL(url); }catch(e){}
        host.innerHTML="";
      }, 1500);
    }, "image/jpeg", 0.95);
  }

  $("#exportBtn").addEventListener("click", exportLandscape);

  // ---------- init ----------
  restoreAll();
</script>
</body>
</html>
```Ó®Å0Ó®Ç
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PBIS Canvas Studio — Text + 3 Images (Confirm-to-Save)</title>
<style>
:root{
  --bg:#f3f3f3; --card:#fff; --ink:#111; --muted:#444; --line:#cfcfcf; --r:14px;
  --blue:#0b2a5b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Arial;
  background:var(--bg);
  color:var(--ink);
  overflow:hidden; /* NO SCROLL */
}
.top{
  height:64px; background:#000; color:#fff;
  display:flex; align-items:center; gap:10px; padding:0 14px;
}
.badge{
  width:34px; height:34px; border-radius:999px;
  border:2px solid #fff; display:grid; place-items:center; font-weight:900;
}
.wrap{height:calc(100vh - 64px); padding:12px; display:flex; justify-content:center;}
.card{
  width:min(1260px,100%);
  background:var(--card);
  border:2px solid var(--line);
  border-radius:var(--r);
  padding:12px;
  display:flex;
  flex-direction:column;
  min-height:0;
}
.grid{display:flex; gap:12px; min-height:0; flex:1;}
.col{
  flex:1; min-width:0;
  border:2px dotted var(--line);
  border-radius:12px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0;
}
.h{margin:0;font-weight:900}
.m{margin:0;color:var(--muted);font-weight:700}
.row{display:flex; gap:10px; min-width:0}
.row.wrap{flex-wrap:wrap; height:auto; padding:0; justify-content:flex-start}

input,textarea{
  width:100%;
  border:2px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
  font-size:16px;
}
textarea{resize:none; height:48px;} /* tight: prevents scroll */

.btn{
  flex:1; min-width:0;
  border:2px solid #000; background:#fff; color:#000;
  border-radius:12px; padding:12px;
  font-weight:900; cursor:pointer; user-select:none; white-space:nowrap;
}
.btn.on{background:#000;color:#fff}
.small{
  flex:0 0 auto;
  border:2px solid #000; background:#fff;
  border-radius:12px; padding:10px 12px;
  font-weight:900; cursor:pointer; user-select:none; white-space:nowrap;
}
.small.primary{background:#000;color:#fff}
.small.good{border-color:#0b7a34;background:#0b7a34;color:#fff}
.small.warn{border-color:#8a5b00;background:#fff3cd;color:#111}

.foot{
  display:flex; gap:10px; flex-wrap:wrap;
  justify-content:flex-end; margin-top:auto;
}

/* checks */
.checks{
  border:2px solid var(--line);
  border-radius:12px;
  padding:8px 10px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px 10px;
}
.check{
  display:flex; align-items:center; gap:8px;
  font-weight:900; color:#000; font-size:0.92rem; line-height:1.1; min-width:0;
}
.check input{width:18px;height:18px;accent-color:#000;}
.check.full{grid-column:1 / -1;}

/* Image library + slots */
.libBox{
  border:2px solid var(--line);
  border-radius:12px;
  padding:10px;
  background:#fff;
}
.libTop{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
}
.libTop .hint{margin:0;color:var(--muted);font-weight:800;font-size:.92rem}
.library{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
  max-height:120px; /* keep no-scroll overall */
  overflow:auto; /* only library scrolls if huge; rest stays fixed */
  padding-bottom:2px;
}
.thumb{
  width:110px; height:80px;
  border:2px solid var(--line);
  border-radius:12px;
  overflow:hidden;
  background:#fff;
  cursor:pointer;
  position:relative;
  flex:0 0 auto;
}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.thumb .tag{
  position:absolute; left:6px; bottom:6px;
  background:rgba(0,0,0,.65);
  color:#fff;
  font-size:10px;
  padding:2px 7px;
  border-radius:999px;
  font-weight:950;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.thumb.sel{
  border-color:#0b7a34;
  box-shadow:0 0 0 3px rgba(11,122,52,.15);
}

.slotRow{
  display:flex; gap:10px; flex-wrap:wrap;
}
.slot{
  flex:1; min-width:160px;
  border:2px solid #000;
  border-radius:12px;
  padding:10px;
  background:#fff;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.slot .cap{font-weight:950}
.slot .sub{margin:0;color:var(--muted);font-weight:800;font-size:.9rem}
.slot .box{
  height:90px;
  border:2px solid var(--line);
  border-radius:10px;
  overflow:hidden;
  background:#fff;
  display:grid;
  place-items:center;
}
.slot .box img{width:100%;height:100%;object-fit:cover;display:block}
.slot .box .ph{color:var(--muted);font-weight:900;font-size:.92rem;padding:8px;text-align:center}
.slot.active{
  outline:3px solid rgba(11,122,52,.35);
  outline-offset:2px;
}

/* Preview stage canvas */
.previewStage{
  position:relative;
  flex:1;
  min-height:0;
  border:2px solid #000;
  border-radius:12px;
  overflow:hidden;
  background:#fff;
}
canvas{width:100%;height:100%;display:block}

/* JPEG overlay */
.jpegOverlay{
  position:absolute;
  inset:10px;
  border-radius:12px;
  border:2px solid var(--line);
  background:rgba(255,255,255,0.86);
  display:none;
  padding:10px;
  overflow:hidden;
}
.jpegOverlay .bar{
  display:flex; justify-content:space-between; align-items:center;
  gap:10px; margin-bottom:8px;
}
.jpegOverlay .hint{
  margin:0; font-weight:800; color:var(--muted); font-size:.92rem;
}
.jpegOverlay .close{
  border:2px solid #000; background:#fff;
  border-radius:10px; padding:8px 10px;
  font-weight:900; cursor:pointer;
}
.jpegOverlay img{
  width:100%;
  height:calc(100% - 44px);
  object-fit:contain;
  display:block;
  border-radius:10px;
  background:#fff;
}
</style>
</head>

<body>
<div class="top">
  <div class="badge">PB</div>
  <div>
    <div style="font-weight:900;letter-spacing:.08em">PBIS CANVAS STUDIO</div>
    <div style="font-weight:700;opacity:.85;font-size:.92rem">Text + Images • Confirm-to-Save • Landscape Export</div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="grid">

      <!-- LEFT -->
      <div class="col" id="left">
        <p class="h" id="status">1) Upload images  2) Select image  3) Tap slot (A/B/C)  4) Confirm</p>

        <div class="row wrap" role="group" aria-label="Activities">
          <button class="btn" id="tCheck" type="button">CHECK IN</button>
          <button class="btn" id="tReflect" type="button">REFLECT</button>
          <button class="btn" id="tGoal" type="button">GOAL</button>
        </div>

        <div class="row">
          <div style="flex:1;min-width:0">
            <p class="m">Student</p>
            <input id="name" placeholder="Name"/>
          </div>
          <div style="flex:1;min-width:0">
            <p class="m">Group</p>
            <input id="group" placeholder="Period"/>
          </div>
        </div>

        <p class="m">PBIS Checks (5)</p>
        <div class="checks" aria-label="PBIS Checks">
          <label class="check"><input type="checkbox" id="c1"/>ENGAGE in SAFTEY</label>
          <label class="check"><input type="checkbox" id="c2"/>LEARN TO EARN</label>
          <label class="check"><input type="checkbox" id="c3"/>ALWAYS RESPECTFUL</label>
          <label class="check"><input type="checkbox" id="c4"/>DO THE RIGHT THING</label>
          <label class="check full"><input type="checkbox" id="c5"/>MY GOAL POINT</label>
        </div>

        <p class="m">CHECK IN</p><textarea id="a1" placeholder="Today I will…"></textarea>
        <p class="m">REFLECT</p><textarea id="b1" placeholder="What happened?"></textarea>
        <p class="m">GOAL</p><textarea id="g1" placeholder="My goal point is…"></textarea>

        <!-- ONE IMAGE UPLOADER + SLOTS -->
        <div class="libBox">
          <div class="libTop">
            <div style="flex:1;min-width:220px">
              <div class="m" style="margin:0 0 6px 0;">Image Library (upload once)</div>
              <input id="imgUpload" type="file" accept="image/*" multiple />
            </div>
            <p class="hint">Select an image → tap a slot (A/B/C) → Confirm to save.</p>
          </div>

          <div class="library" id="library" aria-label="Uploaded images"></div>

          <div class="slotRow" style="margin-top:10px">
            <div class="slot" id="slotA" data-slot="A" tabindex="0">
              <div class="cap">SLOT A (Large)</div>
              <p class="sub">Export: top-right</p>
              <div class="box" id="boxA"><div class="ph">Tap to stage image</div></div>
              <button class="small" type="button" id="clearA">Clear A</button>
            </div>
            <div class="slot" id="slotB" data-slot="B" tabindex="0">
              <div class="cap">SLOT B (Small)</div>
              <p class="sub">Export: bottom-right (left)</p>
              <div class="box" id="boxB"><div class="ph">Tap to stage image</div></div>
              <button class="small" type="button" id="clearB">Clear B</button>
            </div>
            <div class="slot" id="slotC" data-slot="C" tabindex="0">
              <div class="cap">SLOT C (Small)</div>
              <p class="sub">Export: bottom-right (right)</p>
              <div class="box" id="boxC"><div class="ph">Tap to stage image</div></div>
              <button class="small" type="button" id="clearC">Clear C</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px; justify-content:flex-end;">
            <button class="small warn" type="button" id="cancelStage">Cancel Staged</button>
            <button class="small good" type="button" id="confirmStage">Confirm Image Placement</button>
          </div>

          <p class="m" id="stageNote" style="margin-top:6px;">
            Staged: none. (Nothing changes until you Confirm.)
          </p>
        </div>

        <div class="foot">
          <button class="small" id="preview" type="button">Preview JPEG</button>
          <button class="small primary" id="download" type="button">Download JPEG</button>
          <button class="small" id="openTab" type="button">Open JPEG Tab</button>
          <button class="small" id="clearAll" type="button">Clean Up</button>
        </div>

        <p class="m">If Sites blocks downloads: Preview → long-press image → Save. Or use “Open JPEG Tab”.</p>
      </div>

      <!-- RIGHT -->
      <div class="col" id="right">
        <p class="h">Export Preview (Text + Images)</p>

        <div class="previewStage" id="stage">
          <canvas id="cv"></canvas>

          <div class="jpegOverlay" id="jpegBox">
            <div class="bar">
              <p class="hint">JPEG Preview</p>
              <button class="close" id="closeJpeg" type="button">Close</button>
            </div>
            <img id="jpegImg" alt="JPEG Preview"/>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const $=(s,el=document)=>el.querySelector(s);

// ----- TEXT + CHECK STATE -----
const S={check:false,reflect:false,goal:false};
const btns={check:$("#tCheck"),reflect:$("#tReflect"),goal:$("#tGoal")};
const f={
  name:$("#name"), group:$("#group"),
  a1:$("#a1"), b1:$("#b1"), g1:$("#g1"),
  c1:$("#c1"), c2:$("#c2"), c3:$("#c3"), c4:$("#c4"), c5:$("#c5"),
};

// ----- CANVAS -----
const cv=$("#cv");
const ctx=cv.getContext("2d",{alpha:false});

// ----- IMAGE LIBRARY + COMMITTED SLOTS -----
const library=[]; // {id,name,dataUrl}
let selectedImageId=null;

// committed slots (only these appear in export)
const committed = { A:null, B:null, C:null }; // {dataUrl, imgObj} or null

// staged (does NOT affect export until confirm)
let staged = { slot:null, imageId:null, dataUrl:null };

// ----- HELPERS -----
function hideJpeg(){ $("#jpegBox").style.display="none"; }
$("#closeJpeg").onclick=hideJpeg;

function uid(){
  return (crypto && crypto.randomUUID) ? crypto.randomUUID() :
    "id-"+Math.random().toString(16).slice(2)+"-"+Date.now();
}

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}

function wrapLines(t,max=46){
  const w=(t||"").replace(/\r/g,"").split(/\s+/).filter(Boolean);
  let out=[], line="";
  for(const word of w){
    const test=line?line+" "+word:word;
    if(test.length>max){ if(line) out.push(line); line=word; }
    else line=test;
  }
  if(line) out.push(line);
  return out;
}
function checkedLabels(){
  const labels=[];
  if(f.c1.checked) labels.push("ENGAGE in SAFTEY");
  if(f.c2.checked) labels.push("LEARN TO EARN");
  if(f.c3.checked) labels.push("ALWAYS RESPECTFUL");
  if(f.c4.checked) labels.push("DO THE RIGHT THING");
  if(f.c5.checked) labels.push("MY GOAL POINT");
  return labels;
}

// ----- ACTIVITIES -----
function toggleAct(k){
  S[k]=!S[k];
  btns[k].classList.toggle("on",S[k]);
  hideJpeg(); draw("screen");
}
btns.check.onclick=()=>toggleAct("check");
btns.reflect.onclick=()=>toggleAct("reflect");
btns.goal.onclick=()=>toggleAct("goal");

// live redraw for text/checkbox changes
["input","change"].forEach(evt=>{
  Object.values(f).forEach(el=>el.addEventListener(evt, ()=>{ hideJpeg(); draw("screen"); }));
});

// ----- IMAGE LIBRARY UI -----
function renderThumb(item){
  const d=document.createElement("div");
  d.className="thumb";
  d.dataset.id=item.id;

  const im=document.createElement("img");
  im.src=item.dataUrl;

  const tag=document.createElement("div");
  tag.className="tag";
  tag.textContent="Tap";

  d.appendChild(im);
  d.appendChild(tag);

  d.addEventListener("click", ()=>{
    if(selectedImageId===item.id){ selectedImageId=null; }
    else selectedImageId=item.id;

    document.querySelectorAll(".thumb").forEach(t=>t.classList.remove("sel"));
    if(selectedImageId) d.classList.add("sel");

    // update staged note only (still not saved)
    updateStageNote();
  });

  $("#library").appendChild(d);
}

$("#imgUpload").addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files||[]);
  for(const file of files){
    const dataUrl = await fileToDataURL(file);
    const item = { id: uid(), name: file.name, dataUrl };
    library.push(item);
    renderThumb(item);
  }
  e.target.value="";
});

// ----- SLOTS (tap slot to STAGE) -----
function slotEl(letter){ return $("#slot"+letter); }
function boxEl(letter){ return $("#box"+letter); }

function clearActiveSlotHighlights(){
  ["A","B","C"].forEach(k=>slotEl(k).classList.remove("active"));
}

function stageInto(slotLetter){
  clearActiveSlotHighlights();
  slotEl(slotLetter).classList.add("active");

  if(!selectedImageId){
    staged = { slot: slotLetter, imageId: null, dataUrl: null };
    updateStageNote();
    return;
  }
  const item = library.find(x=>x.id===selectedImageId);
  if(!item){
    staged = { slot: slotLetter, imageId: null, dataUrl: null };
    updateStageNote();
    return;
  }
  staged = { slot: slotLetter, imageId: item.id, dataUrl: item.dataUrl };
  updateStageNote();
}

["A","B","C"].forEach(letter=>{
  slotEl(letter).addEventListener("click", ()=> stageInto(letter));
  slotEl(letter).addEventListener("keydown", (ev)=>{
    if(ev.key==="Enter" || ev.key===" "){ ev.preventDefault(); stageInto(letter); }
  });
});

// ----- COMMITTED SLOT UI -----
function setSlotBox(letter, dataUrl){
  const b = boxEl(letter);
  b.innerHTML="";
  if(!dataUrl){
    const ph=document.createElement("div");
    ph.className="ph";
    ph.textContent="Tap to stage image";
    b.appendChild(ph);
    return;
  }
  const im=document.createElement("img");
  im.src=dataUrl;
  b.appendChild(im);
}

function updateStageNote(){
  const slot = staged.slot ? staged.slot : "none";
  const hasImg = staged.dataUrl ? "YES" : "NO";
  $("#stageNote").textContent = `Staged: slot ${slot} • image selected: ${hasImg}. (Nothing changes until you Confirm.)`;
}

// ----- CONFIRM / CANCEL -----
function commitStaged(){
  if(!staged.slot || !staged.dataUrl){
    alert("Stage an image first: select an image, then tap a slot (A/B/C).");
    return;
  }
  const letter = staged.slot;
  const dataUrl = staged.dataUrl;

  // load Image object for canvas cover draw
  const img = new Image();
  img.onload = ()=>{
    committed[letter] = { dataUrl, imgObj: img };
    setSlotBox(letter, dataUrl);
    clearActiveSlotHighlights();
    staged = { slot:null, imageId:null, dataUrl:null };
    updateStageNote();
    hideJpeg();
    draw("screen");
  };
  img.onerror = ()=>{
    alert("That image failed to load. Try a different file.");
  };
  img.src = dataUrl;
}

function cancelStaged(){
  clearActiveSlotHighlights();
  staged = { slot:null, imageId:null, dataUrl:null };
  updateStageNote();
}

$("#confirmStage").onclick=commitStaged;
$("#cancelStage").onclick=cancelStaged;

// clear individual committed slots
function clearSlot(letter){
  committed[letter]=null;
  setSlotBox(letter, null);
  hideJpeg(); draw("screen");
}
$("#clearA").onclick=()=>clearSlot("A");
$("#clearB").onclick=()=>clearSlot("B");
$("#clearC").onclick=()=>clearSlot("C");

// ----- CANVAS FIT -----
function fit(){
  const box=$("#stage").getBoundingClientRect();
  const dpr=Math.max(1,window.devicePixelRatio||1);
  cv.width=Math.floor(box.width*dpr);
  cv.height=Math.floor(box.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw("screen");
}
window.addEventListener("resize",fit);

// ----- CANVAS DRAW (LANDSCAPE COMPOSITION) -----
function drawCover(img, rect){
  const iw = img.naturalWidth || img.width;
  const ih = img.naturalHeight || img.height;
  if(!iw || !ih) return;

  const r = rect.w / rect.h;
  const ir = iw / ih;

  let sx=0, sy=0, sw=iw, sh=ih;
  if(ir > r){
    sh = ih;
    sw = Math.floor(ih * r);
    sx = Math.floor((iw - sw)/2);
    sy = 0;
  }else{
    sw = iw;
    sh = Math.floor(iw / r);
    sx = 0;
    sy = Math.floor((ih - sh)/2);
  }

  ctx.save();
  ctx.beginPath();
  ctx.rect(rect.x, rect.y, rect.w, rect.h);
  ctx.clip();
  ctx.drawImage(img, sx, sy, sw, sh, rect.x, rect.y, rect.w, rect.h);
  ctx.restore();

  ctx.strokeStyle="#000";
  ctx.lineWidth=4;
  ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
}

function frame(rect, label){
  ctx.strokeStyle="#000"; ctx.lineWidth=4;
  ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
  ctx.fillStyle="#444";
  ctx.font="900 28px system-ui, -apple-system, Segoe UI, Arial";
  ctx.fillText(label, rect.x+14, rect.y+38);
}

function draw(mode="screen"){
  const W=cv.clientWidth, H=cv.clientHeight;
  const dateStr = new Date().toLocaleDateString();

  // virtual 1920x1080, scaled into preview box
  const baseW=1920, baseH=1080;
  const scale=Math.min(W/baseW, H/baseH);
  const ox=Math.floor((W-baseW*scale)/2);
  const oy=Math.floor((H-baseH*scale)/2);

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,W,H);

  ctx.save();
  ctx.translate(ox,oy);
  ctx.scale(scale,scale);

  // bg
  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,baseW,baseH);

  // header
  const headerH=96;
  if(mode==="download"){
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--blue").trim() || "#0b2a5b";
  }else{
    ctx.fillStyle="#000";
  }
  ctx.fillRect(0,0,baseW,headerH);

  ctx.fillStyle="#fff";
  ctx.textAlign="left";
  ctx.font="900 46px system-ui, -apple-system, Segoe UI, Arial";
  ctx.fillText("PBIS TICKET", 44, 62);
  ctx.font="700 30px system-ui, -apple-system, Segoe UI, Arial";
  ctx.fillText("W.L.E.A.D.", 44, 92);

  if(mode==="download"){
    ctx.textAlign="right";
    ctx.font="900 34px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("Date: " + dateStr, baseW-44, 62);
    ctx.textAlign="left";
  }

  const pad=44;
  const contentTop=headerH+34;

  // left text dominates
  const leftW=980, gap=40;
  const rightX=pad+leftW+gap;
  const rightW=baseW-rightX-pad;

  // panel borders
  ctx.strokeStyle="#cfcfcf";
  ctx.lineWidth=4;
  ctx.strokeRect(pad, contentTop, leftW, baseH-contentTop-pad);
  ctx.strokeRect(rightX, contentTop, rightW, baseH-contentTop-pad);

  // LEFT text
  let x=pad+34;
  let y=contentTop+60;

  const student=(f.name.value||"").trim() || "__________";
  const group=(f.group.value||"").trim() || "—";

  ctx.fillStyle="#111";
  ctx.font="900 52px system-ui, -apple-system, Segoe UI, Arial";
  ctx.fillText("Student: " + student, x, y);
  y+=64;

  ctx.font="800 40px system-ui, -apple-system, Segoe UI, Arial";
  ctx.fillText("Group: " + group + "   Date: " + dateStr, x, y);
  y+=44;

  // divider
  ctx.strokeStyle="#cfcfcf";
  ctx.lineWidth=4;
  ctx.beginPath(); ctx.moveTo(x, y+24); ctx.lineTo(pad+leftW-34, y+24); ctx.stroke();
  y+=80;

  // checks
  const checks=checkedLabels();
  if(checks.length){
    ctx.fillStyle="#000";
    ctx.font="900 44px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("PBIS CHECKS:", x, y); y+=58;

    ctx.font="800 36px system-ui, -apple-system, Segoe UI, Arial";
    const joined=checks.join(" • ");
    const cLines=wrapLines(joined,42).slice(0,2);
    for(const ln of cLines){ ctx.fillText(ln, x, y); y+=46; }
    y+=24;

    ctx.strokeStyle="#cfcfcf";
    ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(pad+leftW-34, y); ctx.stroke();
    y+=66;
  }

  // sections
  function section(title, text){
    ctx.fillStyle="#000";
    ctx.font="900 44px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText(title, x, y); y+=56;

    ctx.font="800 38px system-ui, -apple-system, Segoe UI, Arial";
    const lines=wrapLines(text||"",46).slice(0,3);
    if(lines.length===0){ ctx.fillText("—", x, y); y+=46; }
    else { for(const ln of lines){ ctx.fillText(ln, x, y); y+=46; } }
    y+=54;
  }

  const any = S.check || S.reflect || S.goal;
  if(S.check) section("CHECK IN:", f.a1.value);
  if(S.reflect) section("REFLECT:", f.b1.value);
  if(S.goal) section("GOAL:", f.g1.value);
  if(!any){
    ctx.fillStyle="#111";
    ctx.font="900 40px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("Tap CHECK IN / REFLECT / GOAL to add sections.", x, y);
  }

  // RIGHT images: committed only
  const rx=rightX+26, ry=contentTop+26;
  const rInnerW=rightW-52;
  const rInnerH=baseH-contentTop-pad-52;

  const bigH=Math.floor(rInnerH*0.62);
  const smallH=rInnerH-bigH-18;
  const smallW=Math.floor((rInnerW-18)/2);

  const A={x:rx,y:ry,w:rInnerW,h:bigH};
  const B={x:rx,y:ry+bigH+18,w:smallW,h:smallH};
  const C={x:rx+smallW+18,y:ry+bigH+18,w:smallW,h:smallH};

  if(committed.A && committed.A.imgObj) drawCover(committed.A.imgObj, A);
  else frame(A, "SLOT A (Large)");

  if(committed.B && committed.B.imgObj) drawCover(committed.B.imgObj, B);
  else frame(B, "SLOT B");

  if(committed.C && committed.C.imgObj) drawCover(committed.C.imgObj, C);
  else frame(C, "SLOT C");

  ctx.restore();

  $("#status").textContent =
    ("Selected: " + (S.check?"CHECK IN ":"") + (S.reflect?"REFLECT ":"") + (S.goal?"GOAL":"")).trim()
    || "1) Upload images  2) Select image  3) Tap slot  4) Confirm";
}

// ----- PREVIEW / DOWNLOAD -----
function canvasToJpegURL(q=0.92){ return cv.toDataURL("image/jpeg", q); }

$("#preview").onclick=()=>{
  draw("screen");
  try{
    $("#jpegImg").src = canvasToJpegURL(0.92);
    $("#jpegBox").style.display="block";
  }catch(e){ alert("Preview failed."); }
};

$("#download").onclick=()=>{
  draw("download");
  const base=(f.name.value.trim()||"pbis_canvas").replace(/\s+/g,"_");
  const file=base+"_LANDSCAPE.jpg";
  const restore=()=>setTimeout(()=>draw("screen"), 70);

  if(cv.toBlob){
    cv.toBlob(blob=>{
      if(!blob){ alert("Download failed."); restore(); return; }
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download=file; a.rel="noopener";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>{ try{URL.revokeObjectURL(url);}catch(e){} }, 1400);
      restore();
    },"image/jpeg",0.95);
  }else{
    try{
      const a=document.createElement("a");
      a.href=canvasToJpegURL(0.95);
      a.download=file;
      document.body.appendChild(a); a.click(); a.remove();
    }catch(e){ alert("Download failed."); }
    restore();
  }
};

$("#openTab").onclick=()=>{
  draw("download");
  try{
    const url = canvasToJpegURL(0.95);
    const w = window.open();
    if(!w){ alert("Pop-up blocked. Use Preview and long-press save."); draw("screen"); return; }
    w.document.write(`<title>PBIS JPEG</title><img src="${url}" style="max-width:100%;height:auto;display:block;margin:0 auto"/>`);
    w.document.close();
  }catch(e){ alert("Open tab failed."); }
  setTimeout(()=>draw("screen"), 90);
};

// ----- CLEAN UP -----
$("#clearAll").onclick=()=>{
  // text
  f.name.value=""; f.group.value="";
  f.a1.value=""; f.b1.value=""; f.g1.value="";
  f.c1.checked=f.c2.checked=f.c3.checked=f.c4.checked=f.c5.checked=false;
  S.check=S.reflect=S.goal=false;
  Object.values(btns).forEach(b=>b.classList.remove("on"));

  // images
  committed.A=committed.B=committed.C=null;
  setSlotBox("A", null); setSlotBox("B", null); setSlotBox("C", null);

  // stage
  cancelStaged();

  hideJpeg();
  draw("screen");
};

// init
setSlotBox("A", null); setSlotBox("B", null); setSlotBox("C", null);
updateStageNote();
setTimeout(()=>{ fit(); draw("screen"); }, 90);
</script>
</body>
</html>
<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PBIS Ticket Maker (B/W Spine)</title>
<style>
:root{--bg:#f3f3f3;--card:#fff;--ink:#111;--muted:#444;--line:#cfcfcf;--r:14px}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Arial;background:var(--bg);color:var(--ink);overflow:hidden}
.top{height:64px;background:#000;color:#fff;display:flex;align-items:center;gap:10px;padding:0 14px}
.badge{width:34px;height:34px;border-radius:999px;border:2px solid #fff;display:grid;place-items:center;font-weight:900}
.wrap{height:calc(100vh - 64px);padding:12px;display:flex;justify-content:center}
.card{width:min(1100px,100%);background:var(--card);border:2px solid var(--line);border-radius:var(--r);padding:12px;display:flex;flex-direction:column;min-height:0}
.grid{display:flex;gap:12px;min-height:0;flex:1}
.col{flex:1;min-width:0;border:2px dotted var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;min-height:0}
.row{display:flex;gap:10px;min-width:0}
.row.wrap{flex-wrap:wrap;height:auto;padding:0;justify-content:flex-start}
.btn{flex:1;min-width:0;border:2px solid #000;background:#fff;color:#000;border-radius:12px;padding:12px;font-weight:900;cursor:pointer}
.btn.on{background:#000;color:#fff}
.small{flex:0 0 auto;border:2px solid #000;background:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;min-width:140px}
.small.primary{background:#000;color:#fff}
input,textarea{width:100%;border:2px solid var(--line);border-radius:12px;padding:10px 12px;font-size:16px}
textarea{resize:none;height:64px}
.h{margin:0;font-weight:900}
.m{margin:0;color:var(--muted);font-weight:700}
.canvas{flex:1;min-height:0;border:2px solid #000;border-radius:12px;overflow:hidden;background:#fff;position:relative}
canvas{width:100%;height:100%;display:block}

/* JPEG preview area */
.jpeg{display:none;border:2px solid var(--line);border-radius:12px;padding:10px;background:#fff}
.jpeg img{width:100%;height:auto;display:block}

/* whirly woo */
.whirl{
  display:none;
  position:absolute; inset:0;
  background:rgba(255,255,255,0.72);
  backdrop-filter: blur(2px);
  display:grid; place-items:center;
}
.whirl .dot{
  width:44px;height:44px;border-radius:999px;
  border:5px solid #ddd; border-top-color:#000;
  animation: spin .75s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.foot{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
</style></head><body>
<div class="top"><div class="badge">PB</div><div>
  <div style="font-weight:900;letter-spacing:.08em">PBIS TICKET MAKER</div>
  <div style="font-weight:700;opacity:.85;font-size:.92rem">B/W Spine • No Scroll • Wrapped Text</div>
</div></div>

<div class="wrap"><div class="card">
  <div class="grid">
    <div class="col">
      <p class="h" id="status">Tap an activity. Preview updates instantly.</p>

      <div class="row wrap" role="group" aria-label="Activities">
        <button class="btn" id="tCheck" type="button">CHECK IN</button>
        <button class="btn" id="tReflect" type="button">REFLECT</button>
        <button class="btn" id="tGoal" type="button">GOAL</button>
      </div>

      <div class="row">
        <div style="flex:1;min-width:0">
          <p class="m">Student</p>
          <input id="name" placeholder="Name"/>
        </div>
        <div style="flex:1;min-width:0">
          <p class="m">Group</p>
          <input id="group" placeholder="Period"/>
        </div>
      </div>

      <p class="m">CHECK IN</p><textarea id="a1" placeholder="Today I will…"></textarea>
      <p class="m">REFLECT</p><textarea id="b1" placeholder="What happened?"></textarea>
      <p class="m">GOAL</p><textarea id="g1" placeholder="My goal point is…"></textarea>

      <div class="foot">
        <button class="small" id="preview" type="button">Preview JPEG</button>
        <button class="small primary" id="download" type="button">Download JPEG</button>
        <button class="small" id="clear" type="button">Clean Up</button>
      </div>
      <p class="m" id="note">If an embed blocks download: use Preview → long-press image → Save.</p>
    </div>

    <div class="col">
      <p class="h">Preview</p>
      <div class="jpeg" id="jpegBox"><img id="jpegImg" alt="JPEG Preview"/></div>

      <div class="canvas" id="canvasWrap">
        <div class="whirl" id="whirl"><div class="dot" aria-label="Loading"></div></div>
        <canvas id="cv"></canvas>
      </div>
    </div>
  </div>
</div></div>

<script>
const $=(s,el=document)=>el.querySelector(s);
const S={check:false,reflect:false,goal:false};
const btns={check:$("#tCheck"),reflect:$("#tReflect"),goal:$("#tGoal")};
const f={name:$("#name"),group:$("#group"),a1:$("#a1"),b1:$("#b1"),g1:$("#g1")};

const cv=$("#cv"), ctx=cv.getContext("2d",{alpha:false});

function showWhirl(on){ $("#whirl").style.display = on ? "grid" : "none"; }

function toggle(k){
  S[k]=!S[k];
  btns[k].classList.toggle("on",S[k]);
  $("#jpegBox").style.display="none";
  draw();
}
btns.check.onclick=()=>toggle("check");
btns.reflect.onclick=()=>toggle("reflect");
btns.goal.onclick=()=>toggle("goal");

function fit(){
  const box=cv.parentElement.getBoundingClientRect();
  const dpr=Math.max(1,window.devicePixelRatio||1);
  cv.width=Math.floor(box.width*dpr);
  cv.height=Math.floor(box.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw();
}
window.addEventListener("resize",fit);

/* === PIXEL-PERFECT WRAP === */
function wrapByPixels(text, maxWidth){
  const words=(text||"").replace(/\r/g,"").split(/\s+/).filter(Boolean);
  if(!words.length) return [""];
  const lines=[];
  let line=words[0];
  for(let i=1;i<words.length;i++){
    const test=line+" "+words[i];
    if(ctx.measureText(test).width<=maxWidth){
      line=test;
    }else{
      lines.push(line);
      line=words[i];
    }
  }
  lines.push(line);
  return lines;
}

/* draws one paragraph block with wrapping + returns new y */
function drawWrappedParagraph(label, body, x, y, maxWidth, lineH, maxLines){
  // label
  ctx.font="900 12px system-ui";
  ctx.fillStyle="#000";
  ctx.fillText(label, x, y);
  y += Math.floor(lineH * 1.15);

  // body
  ctx.font="700 12px system-ui";
  ctx.fillStyle="#000";
  const lines = wrapByPixels(body||"", maxWidth).filter(l=>l!==undefined);
  const take = lines.slice(0, maxLines);
  for(const ln of take){
    ctx.fillText(ln, x, y);
    y += lineH;
  }
  return y + Math.floor(lineH * 0.6);
}

function draw(){
  const w=cv.clientWidth, h=cv.clientHeight;
  const pad=12;
  const rightPad=12;
  const maxTextW = (w - pad - rightPad);
  const lineH=16;

  ctx.fillStyle="#fff"; ctx.fillRect(0,0,w,h);

  // header
  ctx.fillStyle="#000"; ctx.fillRect(0,0,w,54);
  ctx.fillStyle="#fff"; ctx.textAlign="left";
  ctx.font="900 14px system-ui";
  ctx.fillText("PBIS TICKET", pad, 22);
  ctx.font="700 12px system-ui";
  ctx.fillText("W.L.E.A.D. • B/W Spine", pad, 42);

  // meta (wrap-safe)
  ctx.fillStyle="#111";
  ctx.font="900 14px system-ui";
  const student = "Student: " + (f.name.value.trim()||"__________");
  ctx.fillText(student, pad, 80);

  ctx.font="700 12px system-ui";
  const meta = "Group: " + (f.group.value.trim()||"—") + "   Date: " + new Date().toLocaleDateString();
  // meta may wrap on narrow screens:
  const metaLines = wrapByPixels(meta, maxTextW);
  let metaY = 102;
  for(const ln of metaLines.slice(0,2)){
    ctx.fillText(ln, pad, metaY);
    metaY += 16;
  }

  // divider
  ctx.strokeStyle="#cfcfcf"; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(pad, metaY+6); ctx.lineTo(w-pad, metaY+6); ctx.stroke();

  // body area
  let y = metaY + 30;

  // If nothing selected, show instruction
  if(!S.check && !S.reflect && !S.goal){
    ctx.fillStyle="#000";
    ctx.font="900 13px system-ui";
    const msg="Tap CHECK IN / REFLECT / GOAL to add sections.";
    for(const ln of wrapByPixels(msg, maxTextW).slice(0,3)){
      ctx.fillText(ln, pad, y); y += 18;
    }
  } else {
    const maxLinesPerSection = 4; // safe; prevents running off bottom

    if(S.check){
      y = drawWrappedParagraph("CHECK IN:", f.a1.value, pad, y, maxTextW, lineH, maxLinesPerSection);
    }
    if(S.reflect){
      y = drawWrappedParagraph("REFLECT:", f.b1.value, pad, y, maxTextW, lineH, maxLinesPerSection);
    }
    if(S.goal){
      y = drawWrappedParagraph("GOAL:", f.g1.value, pad, y, maxTextW, lineH, maxLinesPerSection);
    }
  }

  // status line for teacher UI
  $("#status").textContent =
    ("Selected: " + (S.check?"CHECK IN ":"") + (S.reflect?"REFLECT ":"") + (S.goal?"GOAL":"")).trim()
    || "Tap an activity. Preview updates instantly.";
}

["input","change"].forEach(evt=>{
  Object.values(f).forEach(el=>el.addEventListener(evt, ()=>{ $("#jpegBox").style.display="none"; draw(); }));
});

$("#preview").onclick=()=>{
  $("#jpegBox").style.display="none";
  showWhirl(true);
  // let the spinner render before heavy work
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      draw();
      try{
        $("#jpegImg").src = cv.toDataURL("image/jpeg",0.92);
        $("#jpegBox").style.display="block";
      }catch(e){
        alert("Preview failed.");
      }finally{
        showWhirl(false);
      }
    });
  });
};

$("#download").onclick=()=>{
  showWhirl(true);
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      draw();
      const base=(f.name.value.trim()||"pbis_ticket").replace(/\s+/g,"_");
      const file=base+".jpg";
      const done=()=>showWhirl(false);

      if(cv.toBlob){
        cv.toBlob(blob=>{
          if(!blob){ done(); alert("Download failed."); return; }
          const url=URL.createObjectURL(blob);
          const a=document.createElement("a");
          a.href=url; a.download=file;
          document.body.appendChild(a); a.click(); a.remove();
          setTimeout(()=>URL.revokeObjectURL(url),800);
          done();
        },"image/jpeg",0.92);
      }else{
        try{
          const a=document.createElement("a");
          a.href=cv.toDataURL("image/jpeg",0.92);
          a.download=file;
          document.body.appendChild(a); a.click(); a.remove();
        }catch(e){ alert("Download failed."); }
        done();
      }
    });
  });
};

$("#clear").onclick=()=>{
  f.name.value=""; f.group.value=""; f.a1.value=""; f.b1.value=""; f.g1.value="";
  S.check=S.reflect=S.goal=false;
  Object.values(btns).forEach(b=>b.classList.remove("on"));
  $("#jpegBox").style.display="none";
  draw();
};

setTimeout(()=>{ fit(); draw(); },50);
</script>
</body></html>
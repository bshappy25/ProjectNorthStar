<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PBIS Ticket Maker ‚Äî W.L.E.A.D. (JPEG)</title>
  <style>
    :root{
      /* Starter Package palette */
      --page:#fff6bf;         /* light yellow */
      --card:#ffffff;
      --ink:#0b1220;          /* deep ink */
      --muted:#2b3445;
      --border:#d9d9d9;

      --navy:#0b2a5b;
      --navy2:#123b7a;
      --gold:#f2c94c;

      --r:16px;
      --shadow: 0 10px 28px rgba(11,42,91,0.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--page);
      color:var(--ink);
      overflow:hidden; /* NO SCROLL */
    }

    /* ===== Top bar (wide-screen effect) ===== */
    .topbar{
      height:72px;
      background:var(--navy);
      color:#fff;
      border-bottom:4px solid var(--gold);
      display:flex;
      align-items:center;
      gap:12px;
      padding:0 14px;
      position:relative;
      overflow:hidden;
    }
    .topbar::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(90deg,
        rgba(255,255,255,0.00) 0%,
        rgba(255,255,255,0.06) 20%,
        rgba(255,255,255,0.00) 52%,
        rgba(255,255,255,0.05) 82%,
        rgba(255,255,255,0.00) 100%);
      opacity:.55;
      pointer-events:none;
    }
    .crest{
      width:44px;height:44px;border-radius:999px;
      border:3px solid var(--gold);
      display:grid;place-items:center;
      font-weight:1000; letter-spacing:.05em;
      background:rgba(255,255,255,0.12);
      z-index:1;
      user-select:none;
    }
    .brand{flex:1; min-width:0; z-index:1}
    .brand .t{
      margin:0;
      font-weight:1000;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:1.05rem;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand .s{
      margin:4px 0 0;
      font-weight:800;
      font-size:.92rem;
      opacity:.92;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pill{
      z-index:1;
      font-weight:1000;
      font-size:.92rem;
      background:rgba(255,255,255,0.14);
      border:1px solid rgba(255,255,255,0.25);
      padding:8px 12px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* ===== App layout (NO SCROLL) ===== */
    .app{height:100vh; display:flex; flex-direction:column;}
    .stage{
      flex:1 1 auto;
      min-height:0;
      padding:12px;
      display:flex;
      justify-content:center;
      align-items:stretch;
    }
    .panel{
      width:min(1180px, 100%);
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .row{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      gap:12px;
    }
    .col{
      flex:1 1 0;
      min-width:320px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      display:flex;
      flex-direction:column;
      min-height:0;
      background:#fff;
    }

    /* Controls */
    label{display:block; font-weight:1000; color:var(--navy); margin:8px 0 6px;}
    input[type="text"], textarea{
      width:100%;
      border:2px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:1rem;
      background:#fff;
      color:var(--ink);
      outline:none;
    }
    textarea{
      height:78px;
      resize:none;
      line-height:1.25rem;
    }
    input:focus, textarea:focus{
      border-color:var(--navy2);
      box-shadow:0 0 0 3px rgba(18,59,122,0.12);
    }

    /* Activity buttons */
    .pickrow{display:flex; gap:10px; flex-wrap:wrap;}
    .pick{
      flex:1 1 150px;
      min-width:150px;
      border:2px solid var(--navy);
      border-radius:12px;
      background:#fff;
      color:var(--navy);
      font-weight:1000;
      padding:12px;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .pick.active{
      background:var(--navy);
      color:#fff;
      box-shadow:0 0 0 3px rgba(242,201,76,0.55) inset;
    }

    /* PBIS checks */
    .checks{
      border:2px solid var(--border);
      border-radius:12px;
      padding:10px;
      display:grid;
      gap:8px;
    }
    .check{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:var(--navy);
    }
    .check input{width:22px;height:22px; accent-color: var(--navy);}

    /* Buttons row (fixed footprint; NO SHIFT) */
    .btnrow{
      margin-top:auto;
      padding-top:10px;
      border-top:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Generate sits UNDER the Make/Save line (your request) */
    .topactions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      appearance:none;
      border:2px solid var(--navy);
      border-radius:12px;
      padding:10px 12px;
      font-weight:1000;
      background:#fff;
      color:var(--navy);
      cursor:pointer;
      user-select:none;
      min-width:160px;
    }
    .btn.gold{border-color:var(--gold); background:var(--gold); color:var(--ink);}
    .btn.danger{border-color:#b00020; background:#b00020; color:#fff;}
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .generate{
      width:100%;
      border:0;
      border-radius:14px;
      padding:14px 14px;
      background:linear-gradient(180deg, var(--navy2), var(--navy));
      color:#fff;
      font-weight:1000;
      font-size:1.05rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow:0 10px 24px rgba(11,42,91,0.22);
    }
    .generate .arrow{
      width:44px;height:44px;border-radius:999px;
      background:rgba(255,255,255,0.16);
      border:2px solid rgba(242,201,76,0.95);
      display:grid;place-items:center;
      font-size:1.35rem;
    }
    /* IMPORTANT: no layout shift ‚Äî reserve space even when hidden */
    .generatewrap{min-height:64px;}
    .generatewrap.hidden{visibility:hidden;}

    /* Preview */
    .previewtitle{margin:0; font-weight:1000; color:var(--navy);}
    .canvaswrap{
      margin-top:10px;
      border:3px solid var(--navy);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      position:relative;
    }
    canvas{
      display:block;
      width:100%;
      height:420px;
      background:#fff;
    }

    /* Foggy overlay for "Preview JPEG" only (subtle) */
    .fog{
      position:absolute;
      inset:0;
      background:rgba(255,255,255,0.10); /* slightly more transparent */
      backdrop-filter: blur(1.5px);
      pointer-events:none;
      opacity:0;
      transition:opacity .18s ease;
    }
    .fog.on{opacity:1;}

    .jpegbox{
      display:none;
      margin-top:10px;
      border:2px dashed var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .jpegbox img{max-width:100%; height:auto; display:block; border-radius:10px; border:1px solid var(--border);}
    .hint{margin:0; font-weight:800; color:var(--muted); font-size:.95rem;}

    .status{margin:0; font-weight:1000; color:var(--navy);}
    .savedAt{margin:0; font-weight:900; color:var(--muted); font-size:.92rem;}
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="crest">PBIS</div>
    <div class="brand">
      <p class="t">PBIS Ticket Maker</p>
      <p class="s">Teacher Tools Hub ‚Ä¢ We are L.E.A.D.</p>
    </div>
    <div class="pill" id="datePill">Date: ‚Äî</div>
  </div>

  <div class="stage">
    <div class="panel">
      <div class="row">
        <!-- LEFT -->
        <div class="col" aria-label="Inputs">
          <p class="status" id="statusLine">Select activities to build the ticket.</p>

          <label>Activities (tap to include)</label>
          <div class="pickrow">
            <button class="pick" id="pickCheckin" type="button">‚úÖ CHECK IN</button>
            <button class="pick" id="pickReflect" type="button">üîÑ REFLECT</button>
            <button class="pick" id="pickGoal" type="button">‚≠ê GOAL</button>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
            <div style="flex:1 1 220px;">
              <label>Student</label>
              <input id="studentName" type="text" placeholder="Name"/>
            </div>
            <div style="flex:1 1 220px;">
              <label>Group</label>
              <input id="studentGroup" type="text" placeholder="Period / Group"/>
            </div>
          </div>

          <label>PBIS Checks (5)</label>
          <div class="checks">
            <div class="check"><input type="checkbox" id="c1"><span>ENGAGE in SAFTEY</span></div>
            <div class="check"><input type="checkbox" id="c2"><span>LEARN TO EARN</span></div>
            <div class="check"><input type="checkbox" id="c3"><span>ALWAYS RESPECTFUL</span></div>
            <div class="check"><input type="checkbox" id="c4"><span>DO THE RIGHT THING</span></div>
            <div class="check"><input type="checkbox" id="c5"><span>MY GOAL POINT</span></div>
          </div>

          <label>CHECK IN</label>
          <textarea id="a1" placeholder="Today I will‚Ä¶"></textarea>

          <label>REFLECT</label>
          <textarea id="b1" placeholder="What happened?"></textarea>

          <label>GOAL</label>
          <textarea id="g1" placeholder="My goal point is‚Ä¶"></textarea>

          <div class="btnrow">
            <!-- Line 1: Make/Save/Clean (fixed) -->
            <div class="topactions">
              <button class="btn gold" id="previewJpeg" type="button">Preview JPEG</button>
              <button class="btn" id="saveJpeg" type="button" disabled>Save JPEG</button>
              <button class="btn danger" id="clear" type="button">Clean Up</button>
            </div>

            <!-- Line 2: Generate (always reserves space; appears when all 3 selected) -->
            <div class="generatewrap hidden" id="genWrap">
              <button class="generate" id="generate" type="button" aria-label="Generate complete ticket">
                <span class="arrow">‚û°Ô∏è</span>
                <span>Generate Complete Ticket</span>
              </button>
            </div>

            <p class="savedAt" id="savedAt">‚Äî</p>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="col" aria-label="Preview">
          <p class="previewtitle">Ticket Preview</p>

          <div class="canvaswrap">
            <canvas id="ticket"></canvas>
            <div class="fog" id="fog"></div>
          </div>

          <div class="jpegbox" id="jpegBox">
            <p class="hint" style="margin:0 0 8px;">JPEG preview (student). Then click <b>Save JPEG</b>.</p>
            <img id="jpegImg" alt="Ticket JPEG preview"/>
          </div>

          <p class="hint" id="helperLine" style="margin-top:10px;">
            Tip: Select activities first. Preview updates automatically.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (s, el=document) => el.querySelector(s);

  // Date
  const now = new Date();
  $("#datePill").textContent = "Date: " + now.toLocaleDateString();

  // Local store (safe)
  const store = {
    get(k, fallback){
      try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; }
      catch(e){ return fallback; }
    },
    set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
  };

  // Elements
  const picks = {
    checkin: $("#pickCheckin"),
    reflect: $("#pickReflect"),
    goal: $("#pickGoal"),
  };

  const fields = {
    name: $("#studentName"),
    group: $("#studentGroup"),
    c1: $("#c1"), c2: $("#c2"), c3: $("#c3"), c4: $("#c4"), c5: $("#c5"),
    a1: $("#a1"),
    b1: $("#b1"),
    g1: $("#g1"),
  };

  const genWrap = $("#genWrap");
  const generateBtn = $("#generate");
  const previewBtn = $("#previewJpeg");
  const saveBtn = $("#saveJpeg");
  const clearBtn = $("#clear");
  const statusLine = $("#statusLine");
  const savedAt = $("#savedAt");
  const fog = $("#fog");
  const jpegBox = $("#jpegBox");
  const jpegImg = $("#jpegImg");

  // State
  let selected = store.get("pbis_selected_v4", {checkin:false, reflect:false, goal:false});
  let lastJpegDataUrl = null;

  function collect(){
    const checks = {
      c1: fields.c1.checked, c2: fields.c2.checked, c3: fields.c3.checked, c4: fields.c4.checked, c5: fields.c5.checked
    };
    return {
      selected,
      name: (fields.name.value||"").trim(),
      group: (fields.group.value||"").trim(),
      checks,
      a1: fields.a1.value||"",
      b1: fields.b1.value||"",
      g1: fields.g1.value||"",
      savedAt: store.get("pbis_savedAt_v4","‚Äî")
    };
  }

  function persist(){
    store.set("pbis_ticket_v4", collect());
  }

  function applyPicks(){
    picks.checkin.classList.toggle("active", !!selected.checkin);
    picks.reflect.classList.toggle("active", !!selected.reflect);
    picks.goal.classList.toggle("active", !!selected.goal);

    const ready = selected.checkin && selected.reflect && selected.goal;

    // No shift: reserve space always, just hide visually
    genWrap.classList.toggle("hidden", !ready);

    statusLine.textContent = ready
      ? "Ready. Click Generate if you want a finalized layout."
      : "Select activities to build the ticket.";

    // If selections change, JPEG is outdated
    lastJpegDataUrl = null;
    saveBtn.disabled = true;
    jpegBox.style.display = "none";
  }

  function togglePick(k){
    selected[k] = !selected[k];
    store.set("pbis_selected_v4", selected);
    applyPicks();
    drawTicket(); // live update
    persist();
  }

  picks.checkin.addEventListener("click", ()=>togglePick("checkin"));
  picks.reflect.addEventListener("click", ()=>togglePick("reflect"));
  picks.goal.addEventListener("click", ()=>togglePick("goal"));

  // Restore
  function restore(){
    const v = store.get("pbis_ticket_v4", null);
    if(!v) return;
    if(v.selected){
      selected = v.selected;
      store.set("pbis_selected_v4", selected);
    }
    fields.name.value = v.name || "";
    fields.group.value = v.group || "";
    if(v.checks){
      fields.c1.checked = !!v.checks.c1;
      fields.c2.checked = !!v.checks.c2;
      fields.c3.checked = !!v.checks.c3;
      fields.c4.checked = !!v.checks.c4;
      fields.c5.checked = !!v.checks.c5;
    }
    fields.a1.value = v.a1 || "";
    fields.b1.value = v.b1 || "";
    fields.g1.value = v.g1 || "";
    const stamp = store.get("pbis_savedAt_v4","‚Äî");
    savedAt.textContent = stamp === "‚Äî" ? "‚Äî" : ("Saved: " + stamp);
  }
  restore();
  applyPicks();

  // Auto persist (light)
  Object.values(fields).forEach(el=>{
    el.addEventListener("input", ()=>{ persist(); drawTicket(); });
    el.addEventListener("change", ()=>{ persist(); drawTicket(); });
  });

  // ===== Canvas drawing with measureText wrapping (no cut-off) =====
  const canvas = $("#ticket");
  const ctx = canvas.getContext("2d", { alpha:false });

  function fitCanvas(){
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    drawTicket();
  }
  window.addEventListener("resize", fitCanvas);

  function wrapByMeasure(text, maxWidth){
    const words = (text||"").replace(/\r/g,"").split(/\s+/).filter(Boolean);
    const lines = [];
    let line = "";
    for(const w of words){
      const test = line ? (line + " " + w) : w;
      if(ctx.measureText(test).width > maxWidth){
        if(line) lines.push(line);
        line = w;
      }else{
        line = test;
      }
    }
    if(line) lines.push(line);
    return lines;
  }

  function selectedLine(v){
    const parts = [];
    if(v.selected.checkin) parts.push("CHECK IN");
    if(v.selected.reflect) parts.push("REFLECT");
    if(v.selected.goal) parts.push("GOAL");
    return parts.length ? ("Selected: " + parts.join(" ‚Ä¢ ")) : "Selected: ‚Äî";
  }

  function checksLine(v){
    const labels = [];
    if(v.checks.c1) labels.push("ENGAGE in SAFTEY");
    if(v.checks.c2) labels.push("LEARN TO EARN");
    if(v.checks.c3) labels.push("ALWAYS RESPECTFUL");
    if(v.checks.c4) labels.push("DO THE RIGHT THING");
    if(v.checks.c5) labels.push("MY GOAL POINT");
    return labels.length ? labels.join(" ‚Ä¢ ") : "‚Äî";
  }

  function drawTicket(){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const v = collect();

    // background
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,w,h);

    // header
    ctx.fillStyle = "#0b2a5b";
    ctx.fillRect(0,0,w,64);
    ctx.fillStyle = "#f2c94c";
    ctx.fillRect(0,60,w,6);

    // header text
    ctx.fillStyle = "#ffffff";
    ctx.font = "1000 18px system-ui, -apple-system, Segoe UI, Arial";
    ctx.textAlign = "left";
    ctx.fillText("PBIS TICKET", 16, 28);

    ctx.font = "900 13px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.fillText("W.L.E.A.D. ‚Ä¢ Teacher Tools Hub", 16, 50);

    // meta right
    ctx.fillStyle = "#123b7a";
    ctx.fillRect(w-260, 10, 244, 44);
    ctx.fillStyle = "#ffffff";
    ctx.font = "900 12px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("Date: " + new Date().toLocaleDateString(), w-248, 28);
    ctx.fillText("Group: " + (v.group || "‚Äî"), w-248, 46);

    // student line
    ctx.fillStyle = "#0b1220";
    ctx.font = "1000 18px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("Student: " + (v.name || "________________"), 16, 96);

    // divider
    ctx.fillStyle = "#d9d9d9";
    ctx.fillRect(16, 112, w-32, 3);

    // selected
    ctx.fillStyle = "#0b2a5b";
    ctx.font = "1000 13px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText(selectedLine(v), 16, 136);

    // checks
    ctx.fillStyle = "#0b1220";
    ctx.font = "1000 14px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("PBIS CHECKS:", 16, 164);

    ctx.font = "900 14px system-ui, -apple-system, Segoe UI, Arial";
    const checksText = checksLine(v);
    const maxChecksWidth = w - 32;
    const checkLines = wrapByMeasure(checksText, maxChecksWidth);
    let cy = 188;
    for(const ln of checkLines.slice(0,2)){ // keep tight
      ctx.fillText(ln, 16, cy);
      cy += 20;
    }

    // divider
    ctx.fillStyle = "#d9d9d9";
    ctx.fillRect(16, cy+6, w-32, 3);

    // body
    let y = cy + 44;
    const left = 16;
    const maxWidth = w - 32;

    function section(title, text){
      ctx.fillStyle = "#0b1220";
      ctx.font = "1000 16px system-ui, -apple-system, Segoe UI, Arial";
      ctx.fillText(title, left, y);
      y += 22;

      ctx.font = "900 16px system-ui, -apple-system, Segoe UI, Arial";
      const lines = wrapByMeasure(text || "‚Äî", maxWidth);
      for(const ln of lines.slice(0,2)){ // keep within frame
        ctx.fillText(ln, left, y);
        y += 22;
      }
      y += 14;
    }

    if(v.selected.checkin) section("CHECK IN:", v.a1);
    if(v.selected.reflect) section("REFLECT:", v.b1);
    if(v.selected.goal) section("GOAL:", v.g1);

    // footer
    ctx.fillStyle = "#0b2a5b";
    ctx.font = "900 11px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("W.L.E.A.D. ‚Ä¢ PBIS", 16, h-14);
    ctx.textAlign = "right";
    ctx.fillStyle = "#123b7a";
    ctx.fillText("Student copy (JPEG)", w-16, h-14);
    ctx.textAlign = "left";
  }

  // initial sizing/draw
  setTimeout(()=>{ fitCanvas(); }, 40);

  // Generate: just forces a clean redraw + message (no layout shift)
  generateBtn.addEventListener("click", ()=>{
    drawTicket();
    statusLine.textContent = "Generated ‚úì";
  });

  // Preview JPEG: ONLY place we show fog, and ONLY briefly (no ‚Äúwhirly woo‚Äù)
  previewBtn.addEventListener("click", ()=>{
    fog.classList.add("on");
    drawTicket();

    // build JPEG preview
    try{
      const url = canvas.toDataURL("image/jpeg", 0.92);
      lastJpegDataUrl = url;
      jpegImg.src = url;
      jpegBox.style.display = "block";
      saveBtn.disabled = false;
      statusLine.textContent = "JPEG preview ready ‚úì";
    }catch(e){
      statusLine.textContent = "JPEG preview failed.";
    }

    // subtle fog pulse, then off
    setTimeout(()=> fog.classList.remove("on"), 260);
  });

  // Save JPEG: real download file (works on most browsers; Google Sites embed varies by iOS)
  saveBtn.addEventListener("click", ()=>{
    if(!lastJpegDataUrl){
      statusLine.textContent = "Preview JPEG first.";
      return;
    }
    const a = document.createElement("a");
    const stamp = new Date();
    const y = stamp.getFullYear();
    const m = String(stamp.getMonth()+1).padStart(2,"0");
    const d = String(stamp.getDate()).padStart(2,"0");
    a.download = `pbis_ticket_${y}-${m}-${d}.jpg`;
    a.href = lastJpegDataUrl;
    document.body.appendChild(a);
    a.click();
    a.remove();

    const savedStamp = new Date().toLocaleString();
    store.set("pbis_savedAt_v4", savedStamp);
    savedAt.textContent = "Saved: " + savedStamp;
    statusLine.textContent = "Downloaded ‚úì";
  });

  // Clean Up
  clearBtn.addEventListener("click", ()=>{
    fields.name.value = "";
    fields.group.value = "";
    fields.c1.checked = fields.c2.checked = fields.c3.checked = fields.c4.checked = fields.c5.checked = false;
    fields.a1.value = "";
    fields.b1.value = "";
    fields.g1.value = "";
    selected = {checkin:false, reflect:false, goal:false};
    store.set("pbis_selected_v4", selected);
    store.set("pbis_ticket_v4", null);
    store.set("pbis_savedAt_v4", "‚Äî");
    savedAt.textContent = "‚Äî";
    jpegBox.style.display = "none";
    lastJpegDataUrl = null;
    saveBtn.disabled = true;
    applyPicks();
    drawTicket();
    statusLine.textContent = "Cleared.";
  });

  // Always keep preview live
  function wireLive(el){
    el.addEventListener("input", ()=>{ persist(); drawTicket(); });
    el.addEventListener("change", ()=>{ persist(); drawTicket(); });
  }
  Object.values(fields).forEach(wireLive);

  // Apply picks to view
  applyPicks();
</script>
</body>
</html>
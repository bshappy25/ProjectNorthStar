<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PBIS Ticket Maker (B/W Spine)</title>
<style>
:root{--bg:#f3f3f3;--card:#fff;--ink:#111;--muted:#444;--line:#cfcfcf;--r:14px}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Arial;background:var(--bg);color:var(--ink);overflow:hidden}
.top{height:64px;background:#000;color:#fff;display:flex;align-items:center;gap:10px;padding:0 14px}
.badge{width:34px;height:34px;border-radius:999px;border:2px solid #fff;display:grid;place-items:center;font-weight:900}
.wrap{height:calc(100vh - 64px);padding:12px;display:flex;justify-content:center}
.card{width:min(1100px,100%);background:var(--card);border:2px solid var(--line);border-radius:var(--r);padding:12px;display:flex;flex-direction:column;min-height:0}
.grid{display:flex;gap:12px;min-height:0;flex:1}
.col{flex:1;min-width:0;border:2px dotted var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;min-height:0}
.row{display:flex;gap:10px;min-width:0}
.row.wrap{flex-wrap:wrap;height:auto;padding:0;justify-content:flex-start}
.btn{flex:1;min-width:0;border:2px solid #000;background:#fff;color:#000;border-radius:12px;padding:12px;font-weight:900;cursor:pointer}
.btn.on{background:#000;color:#fff}
.small{flex:0 0 auto;border:2px solid #000;background:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;min-width:140px}
.small.primary{background:#000;color:#fff}
input,textarea{width:100%;border:2px solid var(--line);border-radius:12px;padding:10px 12px;font-size:16px}
textarea{resize:none;height:58px}
.h{margin:0;font-weight:900}
.m{margin:0;color:var(--muted);font-weight:700}
.canvas{flex:1;min-height:0;border:2px solid #000;border-radius:12px;overflow:hidden;background:#fff;position:relative}
canvas{width:100%;height:100%;display:block}

/* PBIS checks (B/W) */
label{font-weight:900}
.checks{border:2px solid var(--line);border-radius:12px;padding:10px;display:grid;gap:8px;background:#fff}
.check{display:flex;align-items:center;gap:10px;font-weight:800}
.check input{width:20px;height:20px;accent-color:#000}

/* JPEG preview area */
.jpeg{display:none;border:2px solid var(--line);border-radius:12px;padding:10px;background:#fff}
.jpeg img{width:100%;height:auto;display:block}

/* whirly woo (ONLY for Preview JPEG) */
.whirl{
  display:none;
  position:absolute; inset:0;
  background:rgba(255,255,255,0.55); /* more transparent */
  backdrop-filter: blur(2px);
  display:grid; place-items:center;
}
.whirl .dot{
  width:40px;height:40px;border-radius:999px;
  border:5px solid #e0e0e0; border-top-color:#000;
  animation: spin .65s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.foot{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
</style></head><body>
<div class="top"><div class="badge">PB</div><div>
  <div style="font-weight:900;letter-spacing:.08em">PBIS TICKET MAKER</div>
  <div style="font-weight:700;opacity:.85;font-size:.92rem">B/W Spine • No Scroll • Wrapped Text</div>
</div></div>

<div class="wrap"><div class="card">
  <div class="grid">
    <div class="col">
      <p class="h" id="status">Tap an activity. Preview updates instantly.</p>

      <div class="row wrap" role="group" aria-label="Activities">
        <button class="btn" id="tCheck" type="button">CHECK IN</button>
        <button class="btn" id="tReflect" type="button">REFLECT</button>
        <button class="btn" id="tGoal" type="button">GOAL</button>
      </div>

      <div class="row">
        <div style="flex:1;min-width:0">
          <p class="m">Student</p>
          <input id="name" placeholder="Name"/>
        </div>
        <div style="flex:1;min-width:0">
          <p class="m">Group</p>
          <input id="group" placeholder="Period"/>
        </div>
      </div>

      <label>PBIS Checks (5)</label>
      <div class="checks">
        <div class="check"><input type="checkbox" id="c1"><span>ENGAGE in SAFTEY</span></div>
        <div class="check"><input type="checkbox" id="c2"><span>LEARN TO EARN</span></div>
        <div class="check"><input type="checkbox" id="c3"><span>ALWAYS RESPECTFUL</span></div>
        <div class="check"><input type="checkbox" id="c4"><span>DO THE RIGHT THING</span></div>
        <div class="check"><input type="checkbox" id="c5"><span>MY GOAL POINT</span></div>
      </div>

      <p class="m">CHECK IN</p><textarea id="a1" placeholder="Today I will…"></textarea>
      <p class="m">REFLECT</p><textarea id="b1" placeholder="What happened?"></textarea>
      <p class="m">GOAL</p><textarea id="g1" placeholder="My goal point is…"></textarea>

      <div class="foot">
        <button class="small" id="preview" type="button">Preview JPEG</button>
        <button class="small primary" id="download" type="button">Download JPEG</button>
        <button class="small" id="clear" type="button">Clean Up</button>
      </div>
      <p class="m" id="note">If an embed blocks download: use Preview → long-press image → Save.</p>
    </div>

    <div class="col">
      <p class="h">Preview</p>
      <div class="jpeg" id="jpegBox"><img id="jpegImg" alt="JPEG Preview"/></div>

      <div class="canvas" id="canvasWrap">
        <div class="whirl" id="whirl"><div class="dot" aria-label="Loading"></div></div>
        <canvas id="cv"></canvas>
      </div>
    </div>
  </div>
</div></div>

<script>
const $=(s,el=document)=>el.querySelector(s);
const S={check:false,reflect:false,goal:false};
const btns={check:$("#tCheck"),reflect:$("#tReflect"),goal:$("#tGoal")};
const f={
  name:$("#name"), group:$("#group"),
  c1:$("#c1"), c2:$("#c2"), c3:$("#c3"), c4:$("#c4"), c5:$("#c5"),
  a1:$("#a1"), b1:$("#b1"), g1:$("#g1")
};

const cv=$("#cv"), ctx=cv.getContext("2d",{alpha:false});
function showWhirl(on){ $("#whirl").style.display = on ? "grid" : "none"; }

function toggle(k){
  S[k]=!S[k];
  btns[k].classList.toggle("on",S[k]);
  $("#jpegBox").style.display="none";
  draw();
}
btns.check.onclick=()=>toggle("check");
btns.reflect.onclick=()=>toggle("reflect");
btns.goal.onclick=()=>toggle("goal");

function fit(){
  const box=cv.parentElement.getBoundingClientRect();
  const dpr=Math.max(1,window.devicePixelRatio||1);
  cv.width=Math.floor(box.width*dpr);
  cv.height=Math.floor(box.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw();
}
window.addEventListener("resize",fit);

/* === PIXEL-PERFECT WRAP === */
function wrapByPixels(text, maxWidth){
  const words=(text||"").replace(/\r/g,"").split(/\s+/).filter(Boolean);
  if(!words.length) return [""];
  const lines=[];
  let line=words[0];
  for(let i=1;i<words.length;i++){
    const test=line+" "+words[i];
    if(ctx.measureText(test).width<=maxWidth){ line=test; }
    else{ lines.push(line); line=words[i]; }
  }
  lines.push(line);
  return lines;
}
function drawWrappedParagraph(label, body, x, y, maxWidth, lineH, maxLines){
  ctx.font="900 12px system-ui"; ctx.fillStyle="#000";
  ctx.fillText(label, x, y); y += Math.floor(lineH * 1.15);
  ctx.font="700 12px system-ui"; ctx.fillStyle="#000";
  const lines = wrapByPixels(body||"", maxWidth).slice(0, maxLines);
  for(const ln of lines){ ctx.fillText(ln, x, y); y += lineH; }
  return y + Math.floor(lineH * 0.6);
}
function checksSelected(){
  const names=[];
  if(f.c1.checked) names.push("ENGAGE in SAFTEY");
  if(f.c2.checked) names.push("LEARN TO EARN");
  if(f.c3.checked) names.push("ALWAYS RESPECTFUL");
  if(f.c4.checked) names.push("DO THE RIGHT THING");
  if(f.c5.checked) names.push("MY GOAL POINT");
  return names;
}

function draw(){
  const w=cv.clientWidth, h=cv.clientHeight;
  const pad=12, rightPad=12;
  const maxTextW = (w - pad - rightPad);
  const lineH=16;

  ctx.fillStyle="#fff"; ctx.fillRect(0,0,w,h);

  // header
  ctx.fillStyle="#000"; ctx.fillRect(0,0,w,54);
  ctx.fillStyle="#fff"; ctx.textAlign="left";
  ctx.font="900 14px system-ui";
  ctx.fillText("PBIS TICKET", pad, 22);
  ctx.font="700 12px system-ui";
  ctx.fillText("W.L.E.A.D. • B/W Spine", pad, 42);

  // student/meta (wrap-safe)
  ctx.fillStyle="#111"; ctx.font="900 14px system-ui";
  ctx.fillText("Student: " + (f.name.value.trim()||"__________"), pad, 80);

  ctx.font="700 12px system-ui";
  const meta = "Group: " + (f.group.value.trim()||"—") + "   Date: " + new Date().toLocaleDateString();
  const metaLines = wrapByPixels(meta, maxTextW);
  let metaY = 102;
  for(const ln of metaLines.slice(0,2)){ ctx.fillText(ln, pad, metaY); metaY += 16; }

  // divider
  ctx.strokeStyle="#cfcfcf"; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(pad, metaY+6); ctx.lineTo(w-pad, metaY+6); ctx.stroke();

  // checks line (wrapped)
  const checked = checksSelected();
  let y = metaY + 26;

  ctx.fillStyle="#000";
  ctx.font="900 12px system-ui";
  ctx.fillText("PBIS CHECKS:", pad, y);
  y += 18;

  ctx.font="700 12px system-ui";
  const checksText = checked.length ? checked.join(" • ") : "(none selected)";
  for(const ln of wrapByPixels(checksText, maxTextW).slice(0,3)){
    ctx.fillText(ln, pad, y);
    y += 16;
  }

  // divider under checks
  y += 6;
  ctx.strokeStyle="#cfcfcf"; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w-pad, y); ctx.stroke();
  y += 22;

  // body
  if(!S.check && !S.reflect && !S.goal){
    ctx.fillStyle="#000"; ctx.font="900 13px system-ui";
    const msg="Tap CHECK IN / REFLECT / GOAL to add sections.";
    for(const ln of wrapByPixels(msg, maxTextW).slice(0,3)){ ctx.fillText(ln, pad, y); y += 18; }
  } else {
    const maxLinesPerSection = 4;
    if(S.check)   y = drawWrappedParagraph("CHECK IN:", f.a1.value, pad, y, maxTextW, lineH, maxLinesPerSection);
    if(S.reflect) y = drawWrappedParagraph("REFLECT:", f.b1.value, pad, y, maxTextW, lineH, maxLinesPerSection);
    if(S.goal)    y = drawWrappedParagraph("GOAL:", f.g1.value, pad, y, maxTextW, lineH, maxLinesPerSection);
  }

  $("#status").textContent =
    ("Selected: " + (S.check?"CHECK IN ":"") + (S.reflect?"REFLECT ":"") + (S.goal?"GOAL":"")).trim()
    || "Tap an activity. Preview updates instantly.";
}

["input","change"].forEach(evt=>{
  Object.values(f).forEach(el=>{
    el.addEventListener(evt, ()=>{ $("#jpegBox").style.display="none"; draw(); });
  });
});

$("#preview").onclick=()=>{
  $("#jpegBox").style.display="none";
  showWhirl(true); // ONLY here
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      draw();
      try{
        $("#jpegImg").src = cv.toDataURL("image/jpeg",0.92);
        $("#jpegBox").style.display="block";
      }catch(e){
        alert("Preview failed.");
      }finally{
        showWhirl(false);
      }
    });
  });
};

$("#download").onclick=()=>{
  // no whirly woo here (as requested)
  draw();
  const base=(f.name.value.trim()||"pbis_ticket").replace(/\s+/g,"_");
  const file=base+".jpg";

  if(cv.toBlob){
    cv.toBlob(blob=>{
      if(!blob){ alert("Download failed."); return; }
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download=file;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),800);
    },"image/jpeg",0.92);
  }else{
    try{
      const a=document.createElement("a");
      a.href=cv.toDataURL("image/jpeg",0.92);
      a.download=file;
      document.body.appendChild(a); a.click(); a.remove();
    }catch(e){ alert("Download failed."); }
  }
};

$("#clear").onclick=()=>{
  f.name.value=""; f.group.value="";
  f.c1.checked=f.c2.checked=f.c3.checked=f.c4.checked=f.c5.checked=false;
  f.a1.value=""; f.b1.value=""; f.g1.value="";
  S.check=S.reflect=S.goal=false;
  Object.values(btns).forEach(b=>b.classList.remove("on"));
  $("#jpegBox").style.display="none";
  draw();
};

setTimeout(()=>{ fit(); draw(); },50);
</script>
</body></html>
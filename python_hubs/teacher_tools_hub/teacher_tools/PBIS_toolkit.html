<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>PBIS Ticket Maker ‚Äî W.L.E.A.D. (JPEG)</title>
  <style>
    :root{
      --bg:#f2f2f2;
      --card:#ffffff;
      --border:#d7d7d7;
      --text:#111111;
      --muted:#4a4a4a;

      --navy:#0b2a5b;
      --navy2:#123b7a;
      --gold:#f2c94c;

      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:hidden; /* NO PAGE SCROLL */
    }

    /* ===== APP SHELL (NO SCROLL) ===== */
    .app{
      height:100dvh;
      display:grid;
      grid-template-rows: 74px 1fr;
      overflow:hidden;
    }

    /* ===== WIDE SCREEN TOP BAR ===== */
    .topbar{
      position:relative;
      background:var(--navy);
      color:#fff;
      border-bottom:4px solid var(--gold);
      height:74px;
      display:flex;
      align-items:center;
      padding:0 14px;
      gap:12px;
      overflow:hidden;
    }
    .topbar::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(
        90deg,
        rgba(255,255,255,0.00) 0%,
        rgba(255,255,255,0.06) 25%,
        rgba(255,255,255,0.00) 55%,
        rgba(255,255,255,0.05) 85%,
        rgba(255,255,255,0.00) 100%
      );
      pointer-events:none;
      opacity:0.55;
    }
    .crest{
      width:44px;height:44px;
      border-radius:999px;
      border:3px solid var(--gold);
      background:rgba(255,255,255,0.12);
      display:grid;place-items:center;
      font-weight:1000;
      letter-spacing:0.06em;
      user-select:none;
      z-index:1;
      flex:0 0 auto;
    }
    .brand{
      flex:1;
      min-width:0;
      z-index:1;
    }
    .brand .t{
      margin:0;
      font-weight:1000;
      letter-spacing:0.10em;
      text-transform:uppercase;
      font-size:1.05rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .s{
      margin:4px 0 0;
      font-weight:800;
      font-size:0.92rem;
      opacity:0.92;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tiny{
      z-index:1;
      font-weight:900;
      font-size:0.92rem;
      opacity:0.95;
      white-space:nowrap;
      flex:0 0 auto;
    }

    /* ===== MAIN STAGE (NO SCROLL) ===== */
    .stage{
      min-height:0;
      padding:12px;
      display:flex;
      justify-content:center;
      align-items:stretch;
      overflow:hidden;
    }
    .panel{
      width:min(1220px, 100%);
      background:var(--card);
      border:2px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      min-height:0;
      display:grid;
      grid-template-rows: 1fr;
      overflow:hidden;
    }

    /* Two-column grid that always fits */
    .row{
      min-height:0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      overflow:hidden;
    }

    .left, .right{
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      padding:12px;
      min-height:0;
      overflow:hidden; /* no internal scroll */
      display:grid;
      grid-template-rows: auto auto auto auto auto 1fr auto; /* left is ‚Äústack + flexible middle + footer‚Äù */
      gap:10px;
    }

    /* Right: header + canvas + jpeg area + date */
    .right{
      grid-template-rows: auto 1fr auto auto;
      gap:10px;
    }

    /* Typography + controls */
    label{
      display:block;
      font-weight:1000;
      margin:0 0 6px;
      color:var(--navy);
    }
    input[type="text"], textarea{
      width:100%;
      border:2px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:1rem;
      outline:none;
      background:#fff;
      color:var(--text);
    }
    input:focus, textarea:focus{
      border-color:var(--navy2);
      box-shadow:0 0 0 3px rgba(18,59,122,0.12);
    }

    /* ===== Compact text areas that ALWAYS FIT ===== */
    .triInputs{
      min-height:0;
      overflow:hidden;
      display:grid;
      grid-template-rows: auto 1fr auto 1fr auto 1fr; /* label + box x3 */
      gap:8px;
      align-content:stretch;
    }
    textarea{
      resize:none;
      height:100%;
      min-height:0;
      line-height:1.25rem;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      font-size:0.98rem;
    }

    /* ===== Activities ===== */
    .statusline{
      margin:0;
      font-weight:1000;
      color:var(--navy);
    }
    .pickrow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .pick{
      border:2px solid var(--navy);
      background:#fff;
      color:var(--navy);
      border-radius:12px;
      padding:12px 10px;
      font-weight:1000;
      font-size:0.98rem;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .pick.active{
      background:var(--navy);
      color:#fff;
      box-shadow:0 0 0 3px rgba(242,201,76,0.55) inset;
    }
    .pick:focus{outline:3px solid rgba(242,201,76,0.65); outline-offset:2px;}

    /* ===== Student row ===== */
    .studentRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    /* ===== PBIS checks ===== */
    .checks{
      border:2px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px 10px;
      align-items:center;
    }
    .check{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:var(--navy);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .check input{ width:22px; height:22px; accent-color: var(--navy); }

    /* ===== Footer controls ===== */
    .genwrap{
      border-top:1px solid var(--border);
      padding-top:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .arrowbtn{
      appearance:none;
      border:0;
      border-radius:14px;
      padding:14px 14px;
      background:linear-gradient(180deg, var(--navy2), var(--navy));
      color:#fff;
      font-weight:1000;
      font-size:1.05rem;
      cursor:pointer;
      user-select:none;
      display:none; /* shown only when all 3 selected */
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow:0 10px 24px rgba(11,42,91,0.22);
      min-width:320px;
    }
    .arrowbtn .arrow{
      width:44px;height:44px;
      border-radius:999px;
      background:rgba(255,255,255,0.16);
      border:2px solid rgba(242,201,76,0.95);
      display:grid;place-items:center;
      font-size:1.35rem;
    }
    .arrowbtn:focus{outline:3px solid rgba(242,201,76,0.65); outline-offset:3px;}

    .minirow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:nowrap;
    }
    .btn{
      appearance:none;
      border:2px solid var(--navy);
      background:#fff;
      color:var(--navy);
      border-radius:12px;
      padding:10px 12px;
      font-weight:1000;
      font-size:0.95rem;
      cursor:pointer;
      user-select:none;
      min-width:118px;
      white-space:nowrap;
    }
    .btn:focus{outline:3px solid rgba(242,201,76,0.65); outline-offset:2px;}
    .btn.gold{border-color:var(--gold); background:var(--gold); color:#111;}
    .btn.danger{border-color:#b00020; background:#b00020; color:#fff;}

    .tinyhint{ margin:0; color:var(--muted); font-weight:800; font-size:0.92rem; }

    /* ===== PREVIEW ===== */
    .canvaswrap{
      border:3px solid var(--navy);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      min-height:0;
      display:flex;
    }
    canvas{
      display:block;
      width:100%;
      height:100%;
      background:#fff;
    }
    .jpegbox{
      display:none;
      border:2px dashed var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .jpegbox img{
      max-width:100%;
      height:auto;
      display:block;
      border-radius:10px;
      border:1px solid var(--border);
    }
    .hint{ margin:0; color:var(--muted); font-weight:800; }

    /* ===== TOAST ===== */
    .toast{
      position:fixed;
      top:10px; left:50%;
      transform:translateX(-50%);
      background:var(--navy);
      color:#fff;
      border:3px solid var(--gold);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      z-index:9999;
      display:none;
      max-width:92vw;
      text-align:center;
    }

    /* ===== Responsive tweaks ===== */
    @media (max-width: 980px){
      .row{ grid-template-columns: 1fr; }
      .minirow{ flex-wrap:wrap; justify-content:flex-start; }
      .arrowbtn{ min-width: 100%; }
      .genwrap{ grid-template-columns: 1fr; }
      .checks{ grid-template-columns: 1fr; }
      .studentRow{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="app">
    <div class="topbar">
      <div class="crest">W</div>
      <div class="brand">
        <p class="t">PBIS Ticket Maker</p>
        <p class="s">We are L.E.A.Ders ‚Ä¢ Teacher First</p>
      </div>
      <div class="tiny">JPEG Ready</div>
    </div>

    <div class="stage">
      <div class="panel">
        <div class="row">
          <!-- LEFT -->
          <div class="left">
            <p class="statusline" id="statusLine">Select all 3 activities.</p>

            <div class="pickrow" role="group" aria-label="Activities">
              <button class="pick" id="pickCheckin" type="button">‚úÖ CHECK IN</button>
              <button class="pick" id="pickReflect" type="button">üîÑ REFLECT</button>
              <button class="pick" id="pickGoal" type="button">‚≠ê GOAL</button>
            </div>

            <div class="studentRow">
              <div>
                <label>Student</label>
                <input id="studentName" type="text" placeholder="Name"/>
              </div>
              <div>
                <label>Group (optional)</label>
                <input id="studentGroup" type="text" placeholder="Period / Group"/>
              </div>
            </div>

            <div>
              <label>PBIS Checks (5)</label>
              <div class="checks">
                <div class="check"><input type="checkbox" id="c1"><span>ENGAGE in SAFTEY</span></div>
                <div class="check"><input type="checkbox" id="c2"><span>LEARN TO EARN</span></div>
                <div class="check"><input type="checkbox" id="c3"><span>ALWAYS RESPECTFUL</span></div>
                <div class="check"><input type="checkbox" id="c4"><span>DO THE RIGHT THING</span></div>
                <div class="check"><input type="checkbox" id="c5"><span>MY GOAL POINT</span></div>
              </div>
            </div>

            <!-- 3 inputs: auto-fit area -->
            <div class="triInputs" aria-label="Three student inputs">
              <label>CHECK IN</label>
              <textarea id="a1" placeholder="Today I will‚Ä¶"></textarea>

              <label>REFLECT</label>
              <textarea id="b1" placeholder="What happened?"></textarea>

              <label>GOAL</label>
              <textarea id="g1" placeholder="My goal point is‚Ä¶"></textarea>
            </div>

            <div class="genwrap">
              <button class="arrowbtn" id="generate" type="button" aria-label="Generate complete ticket">
                <span class="arrow">‚û°Ô∏è</span>
                <span>Generate Complete Ticket</span>
              </button>

              <div class="minirow">
                <button class="btn gold" id="makeJpeg" type="button">Make JPEG</button>
                <button class="btn" id="save" type="button">Save</button>
                <button class="btn danger" id="clear" type="button">Clean Up</button>
              </div>
            </div>

            <p class="tinyhint" id="savedAt">‚Äî</p>
          </div>

          <!-- RIGHT -->
          <div class="right">
            <p class="statusline">Ticket Preview</p>

            <!-- Canvas fills remaining height safely -->
            <div class="canvaswrap">
              <canvas id="ticket"></canvas>
            </div>

            <div class="jpegbox" id="jpegBox">
              <p class="hint" style="margin:0 0 8px;">
                JPEG Output (student). iPhone: long-press ‚Üí Save Image.
              </p>
              <img id="jpegImg" alt="Ticket JPEG"/>
            </div>

            <p class="tinyhint"><span id="today"></span></p>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (s, el=document)=> el.querySelector(s);
  const store = {
    get(k, fallback){
      try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; }
      catch(e){ return fallback; }
    },
    set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
  };
  function toast(msg){
    const t = $("#toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> t.style.display="none", 1400);
  }

  // date
  const d = new Date();
  $("#today").textContent = "Date: " + d.toLocaleDateString();

  // activity picks (must select all 3 to show big arrow)
  const picks = {
    checkin: $("#pickCheckin"),
    reflect: $("#pickReflect"),
    goal: $("#pickGoal"),
  };
  let selected = store.get("pbis_selected_3", {checkin:false, reflect:false, goal:false});

  function applyPicks(){
    picks.checkin.classList.toggle("active", !!selected.checkin);
    picks.reflect.classList.toggle("active", !!selected.reflect);
    picks.goal.classList.toggle("active", !!selected.goal);

    const ready = !!selected.checkin && !!selected.reflect && !!selected.goal;
    $("#generate").style.display = ready ? "inline-flex" : "none";
    $("#statusLine").textContent = ready ? "Ready. Click the big arrow." : "Select all 3 activities.";
  }

  function togglePick(key){
    selected[key] = !selected[key];
    store.set("pbis_selected_3", selected);
    $("#jpegBox").style.display = "none";
    applyPicks();
  }

  picks.checkin.addEventListener("click", ()=>togglePick("checkin"));
  picks.reflect.addEventListener("click", ()=>togglePick("reflect"));
  picks.goal.addEventListener("click", ()=>togglePick("goal"));
  applyPicks();

  // form fields
  const fields = {
    name: $("#studentName"),
    group: $("#studentGroup"),
    c1: $("#c1"), c2: $("#c2"), c3: $("#c3"), c4: $("#c4"), c5: $("#c5"),
    a1: $("#a1"),
    b1: $("#b1"),
    g1: $("#g1"),
  };

  function collect(){
    return {
      selected,
      name: (fields.name.value||"").trim(),
      group: (fields.group.value||"").trim(),
      checks: {
        c1: fields.c1.checked,
        c2: fields.c2.checked,
        c3: fields.c3.checked,
        c4: fields.c4.checked,
        c5: fields.c5.checked,
      },
      a1: fields.a1.value||"",
      b1: fields.b1.value||"",
      g1: fields.g1.value||"",
    };
  }

  function restore(){
    const v = store.get("pbis_ticket_v3", null);
    if(!v) return;
    if(v.selected){
      selected = v.selected;
      store.set("pbis_selected_3", selected);
      applyPicks();
    }
    fields.name.value = v.name || "";
    fields.group.value = v.group || "";
    if(v.checks){
      fields.c1.checked = !!v.checks.c1;
      fields.c2.checked = !!v.checks.c2;
      fields.c3.checked = !!v.checks.c3;
      fields.c4.checked = !!v.checks.c4;
      fields.c5.checked = !!v.checks.c5;
    }
    fields.a1.value = v.a1 || "";
    fields.b1.value = v.b1 || "";
    fields.g1.value = v.g1 || "";

    const stamp = store.get("pbis_saved_at_v3","‚Äî");
    $("#savedAt").textContent = stamp === "‚Äî" ? "‚Äî" : ("Saved: " + stamp);
  }
  restore();

  // autosave
  Object.values(fields).forEach(el=>{
    el.addEventListener("input", ()=> store.set("pbis_ticket_v3", collect()));
    el.addEventListener("change", ()=> store.set("pbis_ticket_v3", collect()));
  });

  function save(){
    store.set("pbis_ticket_v3", collect());
    const stamp = new Date().toLocaleString();
    store.set("pbis_saved_at_v3", stamp);
    $("#savedAt").textContent = "Saved: " + stamp;
    toast("Saved ‚úì");
  }

  // canvas
  const canvas = $("#ticket");
  const ctx = canvas.getContext("2d", { alpha:false });

  function wrapText(text, maxChars){
    const words = (text||"").replace(/\r/g,"").split(/\s+/).filter(Boolean);
    const lines = [];
    let line = "";
    for(const w of words){
      const test = line ? (line + " " + w) : w;
      if(test.length > maxChars){
        if(line) lines.push(line);
        line = w;
      }else{
        line = test;
      }
    }
    if(line) lines.push(line);
    return lines;
  }
  function checkLabel(k){
    if(k==="c1") return "ENGAGE in SAFTEY";
    if(k==="c2") return "LEARN TO EARN";
    if(k==="c3") return "ALWAYS RESPECTFUL";
    if(k==="c4") return "DO THE RIGHT THING";
    if(k==="c5") return "MY GOAL POINT";
    return k;
  }

  function drawTicket(blank=false){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const v = collect();

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,w,h);

    // header stripe
    ctx.fillStyle = "#0b2a5b";
    ctx.fillRect(0,0,w,62);
    ctx.fillStyle = "#f2c94c";
    ctx.fillRect(0,60,w,6);

    // crest
    const cx=28, cy=31, r=22;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle="#f2c94c"; ctx.fill();
    ctx.beginPath(); ctx.arc(cx,cy,r-5,0,Math.PI*2); ctx.fillStyle="#0b2a5b"; ctx.fill();
    ctx.fillStyle="#ffffff";
    ctx.font="900 16px system-ui, -apple-system, Segoe UI, Arial";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText("W", cx, cy);

    // header text
    ctx.textAlign="left"; ctx.textBaseline="alphabetic";
    ctx.fillStyle="#ffffff";
    ctx.font="1000 15px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("PBIS TICKET ‚Ä¢ W.L.E.A.D.", 62, 30);
    ctx.font="900 12px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillStyle="rgba(255,255,255,0.92)";
    ctx.fillText("We are L.E.A.Ders ‚Ä¢ Teacher First", 62, 50);

    // meta
    ctx.fillStyle="#123b7a";
    ctx.fillRect(w-250, 10, 240, 44);
    ctx.fillStyle="#ffffff";
    ctx.font="900 12px system-ui, -apple-system, Segoe UI, Arial";
    const dateStr = new Date().toLocaleDateString();
    ctx.fillText("Date: " + dateStr, w-238, 28);
    ctx.fillText("Group: " + (v.group || "‚Äî"), w-238, 46);

    // student
    ctx.fillStyle="#111";
    ctx.font="1000 16px system-ui, -apple-system, Segoe UI, Arial";
    ctx.textAlign="left";
    ctx.fillText("Student: " + (v.name || "________________"), 16, 92);

    // selected line
    const selLine = "Selected: " +
      (v.selected.checkin ? "CHECK IN " : "") +
      (v.selected.reflect ? "REFLECT " : "") +
      (v.selected.goal ? "GOAL" : "");
    ctx.fillStyle="#0b2a5b";
    ctx.font="1000 13px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText(selLine.trim(), 16, 118);

    // checks box
    const boxX=16, boxY=130, boxW=w-32, boxH=118;
    ctx.strokeStyle="#d7d7d7";
    ctx.lineWidth=2;
    ctx.strokeRect(boxX, boxY, boxW, boxH);

    ctx.fillStyle="#0b2a5b";
    ctx.font="1000 12px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("PBIS CHECKS:", boxX+10, boxY+22);

    const checks = v.checks;
    const items = ["c1","c2","c3","c4","c5"];
    ctx.font="900 12px system-ui, -apple-system, Segoe UI, Arial";
    let x=boxX+10, y=boxY+44;
    const colGap = Math.floor((boxW-20)/2);

    items.forEach((k, idx)=>{
      const on = !!checks[k];
      const col = (idx<3) ? 0 : 1;
      const row = (idx<3) ? idx : (idx-3);
      const px = x + col*colGap;
      const py = y + row*24;

      ctx.strokeStyle="#0b2a5b";
      ctx.lineWidth=2;
      ctx.strokeRect(px, py-12, 16, 16);
      if(on){
        ctx.fillStyle="#f2c94c";
        ctx.fillRect(px+3, py-9, 10, 10);
      }
      ctx.fillStyle="#0b2a5b";
      ctx.fillText(checkLabel(k), px+24, py+2);
    });

    // body box
    const bodyX=16, bodyY=258, bodyW=w-32, bodyH=h-258-40;
    ctx.strokeStyle="#d7d7d7";
    ctx.lineWidth=2;
    ctx.strokeRect(bodyX, bodyY, bodyW, bodyH);

    ctx.fillStyle="#0b2a5b";
    ctx.font="1000 12px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("STUDENT TEXT:", bodyX+10, bodyY+22);

    ctx.fillStyle="#111";
    ctx.font="900 13px system-ui, -apple-system, Segoe UI, Arial";

    let lines = [];
    if(v.selected.checkin){
      lines.push("CHECK IN:");
      lines = lines.concat(wrapText(v.a1 || (blank ? "" : "________________"), 60).slice(0,3));
      lines.push("");
    }
    if(v.selected.reflect){
      lines.push("REFLECT:");
      lines = lines.concat(wrapText(v.b1 || "", 60).slice(0,3));
      lines.push("");
    }
    if(v.selected.goal){
      lines.push("GOAL:");
      lines = lines.concat(wrapText(v.g1 || "", 60).slice(0,3));
    }
    if(!v.selected.checkin && !v.selected.reflect && !v.selected.goal){
      lines = ["(Select all 3 activities to generate.)"];
    }

    let ty = bodyY+46;
    const maxY = bodyY + bodyH - 14;
    for(const ln of lines){
      if(ty > maxY) break;
      ctx.fillText(ln, bodyX+10, ty);
      ty += 18;
    }

    // footer
    ctx.fillStyle="#0b2a5b";
    ctx.font="900 11px system-ui, -apple-system, Segoe UI, Arial";
    ctx.textAlign="left";
    ctx.fillText("W.L.E.A.D. ‚Ä¢ PBIS", 16, h-14);
    ctx.textAlign="right";
    ctx.fillStyle="#123b7a";
    ctx.fillText("Student copy (JPEG)", w-16, h-14);
    ctx.textAlign="left";
  }

  function fitCanvas(){
    // Make canvas perfectly match container size, no overflow, crisp DPR
    const wrap = $(".canvaswrap");
    const rect = wrap.getBoundingClientRect();
    const w = Math.floor(rect.width);
    const h = Math.floor(rect.height);

    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    canvas.style.width = w + "px";
    canvas.style.height = h + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);

    drawTicket(true);
  }

  // wait for layout, then fit
  requestAnimationFrame(()=>{ fitCanvas(); });
  window.addEventListener("resize", ()=>{ fitCanvas(); });

  function canGenerate(){
    return !!selected.checkin && !!selected.reflect && !!selected.goal;
  }

  $("#generate").addEventListener("click", ()=>{
    if(!canGenerate()){
      toast("Select all 3 activities first");
      return;
    }
    drawTicket(false);
    $("#jpegBox").style.display = "none";
    $("#statusLine").textContent = "Generated ‚úì";
    toast("Generated ‚úì");
  });

  $("#makeJpeg").addEventListener("click", ()=>{
    if(!canGenerate()){
      toast("Select all 3 activities first");
      return;
    }
    drawTicket(false);
    try{
      const url = canvas.toDataURL("image/jpeg", 0.92);
      $("#jpegImg").src = url;
      $("#jpegBox").style.display = "block";
      toast("JPEG ready ‚úì");
    }catch(e){
      toast("JPEG failed");
    }
  });

  $("#save").addEventListener("click", ()=>{
    store.set("pbis_ticket_v3", collect());
    const stamp = new Date().toLocaleString();
    store.set("pbis_saved_at_v3", stamp);
    $("#savedAt").textContent = "Saved: " + stamp;
    toast("Saved ‚úì");
  });

  $("#clear").addEventListener("click", ()=>{
    fields.name.value = "";
    fields.group.value = "";
    fields.c1.checked = fields.c2.checked = fields.c3.checked = fields.c4.checked = fields.c5.checked = false;
    fields.a1.value = "";
    fields.b1.value = "";
    fields.g1.value = "";
    selected = {checkin:false, reflect:false, goal:false};
    store.set("pbis_selected_3", selected);
    store.set("pbis_ticket_v3", collect());
    store.set("pbis_saved_at_v3", "‚Äî");
    $("#savedAt").textContent = "‚Äî";
    $("#jpegBox").style.display = "none";
    applyPicks();
    drawTicket(true);
    $("#statusLine").textContent = "Cleared";
    toast("Cleared");
  });

  // restore saved form
  (function restore(){
    const v = store.get("pbis_ticket_v3", null);
    if(!v) return;
    if(v.selected){
      selected = v.selected;
      store.set("pbis_selected_3", selected);
      applyPicks();
    }
    fields.name.value = v.name || "";
    fields.group.value = v.group || "";
    if(v.checks){
      fields.c1.checked = !!v.checks.c1;
      fields.c2.checked = !!v.checks.c2;
      fields.c3.checked = !!v.checks.c3;
      fields.c4.checked = !!v.checks.c4;
      fields.c5.checked = !!v.checks.c5;
    }
    fields.a1.value = v.a1 || "";
    fields.b1.value = v.b1 || "";
    fields.g1.value = v.g1 || "";
    const stamp = store.get("pbis_saved_at_v3","‚Äî");
    $("#savedAt").textContent = stamp === "‚Äî" ? "‚Äî" : ("Saved: " + stamp);
  })();

  // autosave on any change
  Object.values(fields).forEach(el=>{
    el.addEventListener("input", ()=> store.set("pbis_ticket_v3", collect()));
    el.addEventListener("change", ()=> store.set("pbis_ticket_v3", collect()));
  });

  // initial draw after restore + layout
  setTimeout(()=>{ fitCanvas(); }, 60);
</script>
</body>
</html>
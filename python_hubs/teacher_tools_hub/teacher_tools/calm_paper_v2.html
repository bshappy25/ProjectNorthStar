<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Paper Picker — Full Screen Paper Mode</title>

<style>
  :root{
    --text:#eaf2ff;
    --muted:#b8c7e6;

    --ui: rgba(10,14,24,0.78);
    --ui2: rgba(7,10,18,0.62);
    --border: rgba(160,190,255,0.22);

    --shadow: 0 18px 55px rgba(0,0,0,0.55);
    --radius: 18px;

    /* Pastel + neutral palette (more varied, still calm) */
    --p1:#fbf7ef; /* warm ivory */
    --p2:#eef2ff; /* lavender mist */
    --p3:#eaf7f1; /* mint fog */
    --p4:#fff1e6; /* peach veil */
    --p5:#f1f5f9; /* cool slate */
    --p6:#f7efff; /* lilac paper */
    --p7:#fff7d6; /* butter */
    --p8:#e9f3ff; /* sky */

    --neonA:#58f7ff;
    --neonB:#c77dff;
    --neonC:#66ff99;
    --warn:#ffd166;

    --paperColor: var(--p1);

    /* UI sizing */
    --toolbarH: 86px;
    --safeTop: env(safe-area-inset-top);
    --safeBot: env(safe-area-inset-bottom);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:#050814;
    color:var(--text);
    overflow:hidden;

    /* script handwriting for the paper */
    font-family: "Snell Roundhand","Apple Chancery","Segoe Script","Brush Script MT","Comic Sans MS",cursive;

    cursor: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'>\
<defs>\
  <linearGradient id='wood' x1='0' y1='0' x2='1' y2='1'>\
    <stop offset='0' stop-color='%238b5a2b'/>\
    <stop offset='0.5' stop-color='%236b3f1f'/>\
    <stop offset='1' stop-color='%239a6a3a'/>\
  </linearGradient>\
  <radialGradient id='gem' cx='50%25' cy='50%25' r='60%25'>\
    <stop offset='0' stop-color='%23ffffff' stop-opacity='0.9'/>\
    <stop offset='0.35' stop-color='%2358f7ff' stop-opacity='0.9'/>\
    <stop offset='1' stop-color='%23c77dff' stop-opacity='0.9'/>\
  </radialGradient>\
</defs>\
<path d='M10 52 L52 10' stroke='url(%23wood)' stroke-width='6' stroke-linecap='round'/>\
<path d='M14 56 L56 14' stroke='%23000000' stroke-opacity='0.25' stroke-width='2' stroke-linecap='round'/>\
<circle cx='54' cy='12' r='6' fill='url(%23gem)' stroke='%23ffffff' stroke-opacity='0.35' stroke-width='1.2'/>\
</svg>") 6 58, auto;
  }

  /* Fullscreen “wood table” behind everything */
  .wood{
    position:fixed; inset:0;
    background:
      radial-gradient(1200px 700px at 20% 0%, rgba(255,255,255,0.10), transparent 58%),
      radial-gradient(900px 600px at 90% 15%, rgba(0,0,0,0.24), transparent 62%),
      repeating-linear-gradient(90deg,
        rgba(0,0,0,0.08) 0px,
        rgba(0,0,0,0.00) 12px,
        rgba(255,255,255,0.035) 22px,
        rgba(0,0,0,0.00) 34px
      ),
      linear-gradient(135deg, #5e3f27, #7b5636 45%, #4b2f1b);
  }

  /* CRT overlay */
  .crt::before{
    content:"";
    position:fixed; inset:0;
    pointer-events:none;
    background: repeating-linear-gradient(
      to bottom,
      rgba(0,0,0,0.22) 0px,
      rgba(0,0,0,0.22) 1px,
      rgba(0,0,0,0.0) 2px,
      rgba(0,0,0,0.0) 4px
    );
    opacity: 0.30;
    mix-blend-mode: multiply;
  }
  .crt::after{
    content:"";
    position:fixed; inset:0;
    pointer-events:none;
    background: radial-gradient(900px 600px at 50% 35%, rgba(255,255,255,0.08), transparent 60%);
    opacity: 0.55;
  }

  /* Wand glow follower */
  #wandGlow, #wandTrail{
    position: fixed;
    border-radius: 999px;
    pointer-events:none;
    transform: translate(-50%, -50%);
    z-index: 9999;
  }
  #wandGlow{
    width: 18px; height: 18px;
    background: radial-gradient(circle at 35% 35%,
      rgba(255,255,255,0.95),
      rgba(88,247,255,0.55) 35%,
      rgba(199,125,255,0.25) 65%,
      rgba(0,0,0,0) 72%);
    opacity: 0.95;
  }
  #wandTrail{
    width: 44px; height: 44px;
    background: radial-gradient(circle at 50% 50%,
      rgba(88,247,255,0.18),
      rgba(199,125,255,0.08) 45%,
      rgba(0,0,0,0) 70%);
    opacity: 0.55;
    z-index: 9998;
  }

  /* ===== FULL SCREEN PAPER ===== */
  .paperStage{
    position:fixed; inset:0;
    padding: calc(10px + var(--safeTop)) 10px calc(var(--toolbarH) + 10px + var(--safeBot));
    display:grid;
    place-items:center;
  }

  .paperFrame{
    position:relative;
    width: min(940px, 100%);
    height: 100%;
    max-height: 100%;
    border-radius: 26px;
    overflow:hidden;

    box-shadow:
      0 0 0 2px rgba(88,247,255,0.14),
      0 0 0 6px rgba(199,125,255,0.10),
      0 24px 70px rgba(0,0,0,0.58);

    transform: rotate(-0.12deg);
    background: rgba(255,255,255,0.03);
  }

  /* shimmer sweep */
  .paperFrame::before{
    content:"";
    position:absolute; inset:-40%;
    background: linear-gradient(120deg, transparent 42%, rgba(88,247,255,0.12) 50%, transparent 58%);
    transform: translateX(-45%) rotate(10deg);
    animation: sweep 6.5s ease-in-out infinite;
    pointer-events:none;
    opacity: 0.55;
  }
  @keyframes sweep{
    0%{ transform: translateX(-48%) rotate(10deg); }
    50%{ transform: translateX(12%) rotate(10deg); }
    100%{ transform: translateX(-48%) rotate(10deg); }
  }

  .paper{
    position:absolute; inset:0;
    background: var(--paperColor);
    transition: background 160ms ease;
  }
  .paper::before{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(1100px 900px at 10% 0%, rgba(255,255,255,0.22), transparent 60%),
      radial-gradient(900px 700px at 100% 35%, rgba(0,0,0,0.10), transparent 60%),
      repeating-linear-gradient(0deg,
        rgba(0,0,0,0.020) 0px,
        rgba(0,0,0,0.000) 6px
      );
    opacity: 0.62;
    pointer-events:none;
    mix-blend-mode: multiply;
  }

  /* Paper types */
  .paper.postit{ border-radius: 16px; }
  .paper.postit::after{
    content:"";
    position:absolute; top:0; left:0; right:0; height: 58px;
    background: linear-gradient(180deg, rgba(0,0,0,0.10), rgba(0,0,0,0.00));
    opacity: 0.28;
    pointer-events:none;
  }

  .paper.note::after{
    content:"";
    position:absolute; inset:0;
    background:
      repeating-linear-gradient(to bottom,
        rgba(17,24,39,0.00) 0px,
        rgba(17,24,39,0.00) 26px,
        rgba(17,24,39,0.12) 27px,
        rgba(17,24,39,0.00) 28px
      ),
      linear-gradient(to right, rgba(239,68,68,0.16), rgba(239,68,68,0.16));
    background-size: auto, 2px 100%;
    background-position: 0 0, 78px 0;
    background-repeat: repeat, no-repeat;
    opacity: 0.44;
    pointer-events:none;
  }

  .paper.book{
    background:
      linear-gradient(135deg, rgba(0,0,0,0.06), rgba(0,0,0,0.00) 40%),
      var(--paperColor);
  }
  .paper.book::after{
    content:"";
    position:absolute; left:0; top:0; bottom:0; width: 22%;
    background: linear-gradient(90deg, rgba(0,0,0,0.16), rgba(0,0,0,0.02));
    opacity: 0.55;
    pointer-events:none;
  }

  /* Cute stamps / stickers */
  .stamps{ position:absolute; inset:0; pointer-events:none; }
  .stamp{
    position:absolute;
    padding: 8px 10px;
    border-radius: 14px;
    font-weight: 900;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    box-shadow: 0 12px 24px rgba(0,0,0,0.22);
    opacity: 0.88;
  }
  .stamp.star{ top: 14px; left: 14px; transform: rotate(7deg);
    background: rgba(255,255,255,0.58); border: 1px dashed rgba(0,0,0,0.18); color:#111827; }
  .stamp.heart{ top: 14px; right: 14px; transform: rotate(-7deg);
    background: rgba(255,255,255,0.58); border: 1px dashed rgba(0,0,0,0.18); color:#111827; }
  .stamp.mode{ bottom: 14px; left: 14px; transform: rotate(-3deg);
    background: rgba(255,255,255,0.50); border: 1px dashed rgba(0,0,0,0.18); color:#111827; opacity:0.82; }

  .stamp.level{
    left: 50%;
    top: 46%;
    transform: translate(-50%,-50%) rotate(-12deg) scale(0.7);
    background: rgba(255,255,255,0.66);
    border: 2px solid rgba(0,0,0,0.18);
    color:#111827;
    opacity: 0.0;
    transition: opacity 160ms ease, transform 160ms ease;
    z-index: 5;
  }
  .stamp.level.show{
    opacity: 0.92;
    transform: translate(-50%,-50%) rotate(-12deg) scale(1.0);
  }

  /* Sparkle burst canvas layer */
  #sparkCanvas{
    position:absolute; inset:0;
    pointer-events:none;
    z-index: 6;
  }

  /* Text boxes overlay */
  .boxes{
    position:absolute; inset:0;
    padding: 28px 24px 54px;
    display:grid;
    gap: 14px;
    z-index: 4;
  }

  textarea, input[type="text"]{
    width:100%;
    border-radius: 18px;
    border: 1px solid rgba(0,0,0,0.18);
    background: rgba(255,255,255,0.54);
    outline:none;
    padding: 14px 14px;
    color:#111827;
    resize:none;
    box-shadow: 0 12px 20px rgba(0,0,0,0.16);
    font-family: inherit;
    font-size: clamp(1.05rem, 2.1vw, 1.35rem);
  }
  textarea:focus, input[type="text"]:focus{
    border-color: rgba(88,247,255,0.52);
    box-shadow: 0 0 0 4px rgba(88,247,255,0.16), 0 12px 20px rgba(0,0,0,0.16);
  }

  /* Layouts (class is on .paperFrame) */
  .layout-postit .boxes{ grid-template-rows: 1fr 1fr 1fr; }
  .layout-note .boxes{ grid-template-rows: auto 1fr auto; }
  .layout-book .boxes{ grid-template-rows: 1fr auto auto; align-content: center; }
  .layout-book input[type="text"]{ text-align:center; }
  .layout-blank .boxes{ grid-template-rows: 1fr; }

  /* hint bar */
  .hint{
    position:absolute;
    bottom: 12px; left: 14px; right:14px;
    display:flex; justify-content:space-between; gap:10px;
    pointer-events:none;
    color: rgba(8,10,18,0.62);
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.10em;
    font-size: 0.80rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    z-index: 4;
  }

  /* ===== Floating toolbar (bottom) ===== */
  .toolbar{
    position:fixed;
    left: 10px;
    right: 10px;
    bottom: calc(10px + var(--safeBot));
    height: var(--toolbarH);
    border-radius: 22px;
    border: 1px solid var(--border);
    background: linear-gradient(180deg, var(--ui), rgba(8,10,18,0.78));
    box-shadow: 0 22px 70px rgba(0,0,0,0.62);
    backdrop-filter: blur(12px);
    padding: 10px 10px;
    display:grid;
    grid-template-columns: 1.25fr 1fr 1.2fr;
    gap: 10px;
    align-items:center;
    z-index: 30;
  }

  @media (min-width: 1100px){
    .toolbar{
      left: 50%;
      right: auto;
      transform: translateX(-50%);
      width: 1060px;
    }
  }

  .group{
    display:flex; align-items:center; gap:10px; flex-wrap:nowrap;
    min-width:0;
  }

  .labelTiny{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    font-weight: 900;
    letter-spacing: 0.10em;
    text-transform: uppercase;
    font-size: 0.70rem;
    color: #cfe2ff;
    opacity: 0.9;
    white-space:nowrap;
  }

  select, button{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  }

  .sel{
    width: 100%;
    min-width: 0;
    padding: 10px 10px;
    border-radius: 16px;
    border: 1px solid rgba(160,190,255,0.22);
    background: rgba(7,10,18,0.55);
    color: var(--text);
    outline:none;
  }

  .chips{
    display:flex; gap:8px; align-items:center;
    min-width:0;
  }
  .chip{
    width: 28px; height: 28px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.18);
    box-shadow: 0 10px 18px rgba(0,0,0,0.35);
    cursor:pointer;
    position: relative;
    overflow:hidden;
    flex: 0 0 auto;
  }
  .chip[aria-pressed="true"]{ outline: 3px solid rgba(88,247,255,0.35); }
  .chip::after{
    content:"";
    position:absolute; inset:0;
    background: radial-gradient(80px 28px at 20% 0%, rgba(255,255,255,0.28), transparent 60%);
    pointer-events:none;
  }

  .btn{
    padding: 11px 10px;
    border-radius: 18px;
    border: 1px solid rgba(160,190,255,0.22);
    background: linear-gradient(180deg, rgba(14,18,34,0.92), rgba(8,10,18,0.88));
    color: var(--text);
    font-weight: 900;
    letter-spacing: 0.10em;
    text-transform: uppercase;
    cursor:pointer;
    transition: transform 120ms ease, filter 120ms ease;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active{ transform: translateY(1px) scale(0.995); }
  .btn.primary{ border-color: rgba(88,247,255,0.38); }
  .btn.warn{ border-color: rgba(255,209,102,0.45); }
  .btn.good{ border-color: rgba(102,255,153,0.30); }

  .tog{
    display:flex; align-items:center; gap:10px;
    padding: 10px 10px;
    border-radius: 16px;
    border: 1px solid rgba(160,190,255,0.22);
    background: rgba(7,10,18,0.45);
    min-width:0;
  }
  .tog small{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--muted);
    font-weight: 700;
    line-height: 1.1rem;
  }
  input[type="checkbox"]{ transform: scale(1.2); accent-color: var(--neonA); }

  /* Toast */
  .toast{
    position: fixed;
    left: 50%;
    bottom: calc(var(--toolbarH) + 18px + var(--safeBot));
    transform: translateX(-50%);
    padding: 10px 12px;
    border-radius: 16px;
    border: 1px solid rgba(160,190,255,0.22);
    background: rgba(10,14,24,0.90);
    color: var(--text);
    font-weight: 900;
    letter-spacing: 0.10em;
    text-transform: uppercase;
    box-shadow: 0 18px 40px rgba(0,0,0,0.55);
    opacity: 0;
    pointer-events:none;
    transition: opacity 180ms ease, transform 180ms ease;
    z-index: 60;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  }
  .toast.show{ opacity:1; transform: translateX(-50%) translateY(-2px); }

  /* Splash */
  .splash{
    position:fixed; inset:0;
    display:grid; place-items:center;
    background:
      radial-gradient(900px 600px at 50% 35%, rgba(88,247,255,0.12), transparent 60%),
      radial-gradient(900px 600px at 20% 15%, rgba(199,125,255,0.10), transparent 55%),
      linear-gradient(180deg, rgba(5,8,20,0.96), rgba(0,0,0,0.86));
    z-index: 80;
  }
  .sCard{
    width:min(640px, 92vw);
    border-radius: 22px;
    border: 1px solid rgba(160,190,255,0.22);
    background: rgba(10,14,24,0.78);
    box-shadow: 0 22px 70px rgba(0,0,0,0.60);
    padding: 18px;
  }
  .logo{
    font-weight: 1000;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    font-size: 1.05rem;
    margin: 0 0 8px 0;
    text-shadow: 0 0 18px rgba(88,247,255,0.20);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  }
  .sSmall{
    color: var(--muted);
    font-size:0.95rem;
    line-height:1.35rem;
    margin:0 0 12px;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .meter{
    height: 10px;
    border-radius: 999px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(160,190,255,0.18);
    overflow:hidden;
    margin: 12px 0 10px;
  }
  .meter > div{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(88,247,255,0.75), rgba(199,125,255,0.65), rgba(102,255,153,0.55));
    animation: load 1.1s ease-out forwards;
  }
  @keyframes load{ to{ width: 100%; } }
  .sBtn{
    width:100%;
    padding: 12px 12px;
    border-radius: 18px;
    border: 1px solid rgba(88,247,255,0.38);
    background: linear-gradient(180deg, rgba(15,22,44,0.92), rgba(8,10,18,0.88));
    color: var(--text);
    font-weight: 1000;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    cursor:pointer;
    box-shadow: 0 0 0 5px rgba(88,247,255,0.10), 0 18px 40px rgba(0,0,0,0.55);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  }
  .hidden{ display:none !important; }
</style>
</head>

<body class="crt">
  <div class="wood"></div>

  <div id="wandTrail"></div>
  <div id="wandGlow"></div>

  <!-- Splash -->
  <div class="splash" id="splash">
    <div class="sCard">
      <div class="logo">Paper Picker</div>
      <div class="sSmall">
        Full-screen paper mode for Samsung Smart Select.
        Retro wand + stamps + richer sound palette.
      </div>
      <div class="meter"><div></div></div>
      <button class="sBtn" id="startBtn">Start</button>
      <div class="sSmall" style="margin-top:10px;">
        Audio unlocks after Start (browser rule). No Flash needed.
      </div>
    </div>
  </div>

  <div class="toast" id="toast">OK</div>

  <!-- Paper stage -->
  <div class="paperStage">
    <div class="paperFrame layout-postit" id="paperFrame">
      <div class="paper postit" id="paper"></div>

      <canvas id="sparkCanvas"></canvas>

      <div class="stamps">
        <div class="stamp star" id="stampStar">★ star</div>
        <div class="stamp heart" id="stampHeart">❤ cute</div>
        <div class="stamp mode" id="stampMode">MODE: POST-IT</div>
        <div class="stamp level" id="levelStamp">LEVEL UP!</div>
      </div>

      <div class="boxes" id="boxes"></div>

      <div class="hint">
        <span id="layoutHint">POST-IT • 3 BOXES</span>
        <span id="colorHint">IVORY</span>
      </div>
    </div>
  </div>

  <!-- Floating toolbar -->
  <div class="toolbar" id="toolbar">
    <!-- group 1: type + music -->
    <div class="group">
      <div style="min-width:0; flex:1;">
        <div class="labelTiny">paper</div>
        <select class="sel" id="paperType">
          <option value="postit">Post-it</option>
          <option value="note">Notebook</option>
          <option value="book">Book Cover</option>
          <option value="blank">Blank</option>
        </select>
      </div>
      <div style="min-width:0; flex:1;">
        <div class="labelTiny">music</div>
        <select class="sel" id="musicMode">
          <option value="off">Off</option>
          <option value="chip">Chill Chiptune</option>
          <option value="pad">Lo-fi Pad</option>
          <option value="bells">Ambient Bells</option>
        </select>
      </div>
    </div>

    <!-- group 2: colors + sfx -->
    <div class="group" style="justify-content:center;">
      <div style="min-width:0;">
        <div class="labelTiny">color</div>
        <div class="chips" aria-label="Paper colors">
          <button class="chip" data-color="--p1" aria-pressed="true" title="Ivory"   style="background:var(--p1)"></button>
          <button class="chip" data-color="--p2" aria-pressed="false" title="Lavender" style="background:var(--p2)"></button>
          <button class="chip" data-color="--p3" aria-pressed="false" title="Mint"   style="background:var(--p3)"></button>
          <button class="chip" data-color="--p4" aria-pressed="false" title="Peach"  style="background:var(--p4)"></button>
          <button class="chip" data-color="--p5" aria-pressed="false" title="Slate"  style="background:var(--p5)"></button>
          <button class="chip" data-color="--p6" aria-pressed="false" title="Lilac"  style="background:var(--p6)"></button>
          <button class="chip" data-color="--p7" aria-pressed="false" title="Butter" style="background:var(--p7)"></button>
          <button class="chip" data-color="--p8" aria-pressed="false" title="Sky"    style="background:var(--p8)"></button>
        </div>
      </div>

      <div class="tog" style="max-width: 210px;">
        <input id="sfxToggle" type="checkbox" checked />
        <div style="min-width:0">
          <div class="labelTiny" style="margin-bottom:2px;">sfx</div>
          <small>tap • flip • stamp • sparkle</small>
        </div>
      </div>
    </div>

    <!-- group 3: actions -->
    <div class="group" style="justify-content:flex-end;">
      <button class="btn good" id="randomBtn">Random</button>
      <button class="btn warn" id="clearBtn">Clear</button>
      <button class="btn primary" id="exportBtn">Export PNG</button>
    </div>
  </div>

<script>
(() => {
  // ===== Elements =====
  const splash = document.getElementById('splash');
  const startBtn = document.getElementById('startBtn');
  const toast = document.getElementById('toast');

  const paperFrame = document.getElementById('paperFrame');
  const paper = document.getElementById('paper');
  const boxes = document.getElementById('boxes');

  const paperType = document.getElementById('paperType');
  const musicMode = document.getElementById('musicMode');
  const sfxToggle = document.getElementById('sfxToggle');
  const chips = Array.from(document.querySelectorAll('.chip'));

  const randomBtn = document.getElementById('randomBtn');
  const clearBtn = document.getElementById('clearBtn');
  const exportBtn = document.getElementById('exportBtn');

  const layoutHint = document.getElementById('layoutHint');
  const colorHint = document.getElementById('colorHint');
  const stampMode = document.getElementById('stampMode');
  const levelStamp = document.getElementById('levelStamp');

  const wandGlow = document.getElementById('wandGlow');
  const wandTrail = document.getElementById('wandTrail');

  const sparkCanvas = document.getElementById('sparkCanvas');
  const ctx2d = sparkCanvas.getContext("2d");

  // ===== Wand follower =====
  let mx = innerWidth/2, my = innerHeight/2;
  let gx = mx, gy = my, tx = mx, ty = my;
  function animWand(){
    gx += (mx - gx) * 0.22;
    gy += (my - gy) * 0.22;
    tx += (mx - tx) * 0.10;
    ty += (my - ty) * 0.10;

    wandGlow.style.left = gx + "px";
    wandGlow.style.top  = gy + "px";
    wandTrail.style.left = tx + "px";
    wandTrail.style.top  = ty + "px";
    requestAnimationFrame(animWand);
  }
  animWand();
  addEventListener("pointermove", (e)=>{ mx=e.clientX; my=e.clientY; });

  // ===== Sparkles (tiny particle burst) =====
  let sparks = [];
  function resizeSpark(){
    const r = paperFrame.getBoundingClientRect();
    sparkCanvas.width = Math.floor(r.width * devicePixelRatio);
    sparkCanvas.height = Math.floor(r.height * devicePixelRatio);
    sparkCanvas.style.width = r.width + "px";
    sparkCanvas.style.height = r.height + "px";
    ctx2d.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  }
  resizeSpark();
  addEventListener("resize", resizeSpark);

  function burst(x, y){
    // x,y are page coords; convert to paperFrame local
    const r = paperFrame.getBoundingClientRect();
    const lx = x - r.left;
    const ly = y - r.top;
    for (let i=0;i<14;i++){
      const a = Math.random()*Math.PI*2;
      const s = 1.2 + Math.random()*2.6;
      sparks.push({
        x: lx, y: ly,
        vx: Math.cos(a)*s,
        vy: Math.sin(a)*s - 0.2,
        life: 1.0,
        rot: Math.random()*Math.PI,
        spin: (Math.random()*2-1)*0.2
      });
    }
  }
  function drawSparks(){
    const r = paperFrame.getBoundingClientRect();
    ctx2d.clearRect(0,0,r.width,r.height);

    sparks = sparks.filter(p => p.life > 0.02);
    for (const p of sparks){
      p.life *= 0.92;
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.03;
      p.rot += p.spin;

      const alpha = Math.max(0, (p.life - 0.02));
      ctx2d.save();
      ctx2d.globalAlpha = alpha;
      ctx2d.translate(p.x, p.y);
      ctx2d.rotate(p.rot);

      // little diamond sparkle
      ctx2d.beginPath();
      ctx2d.moveTo(0, -4);
      ctx2d.lineTo(3.5, 0);
      ctx2d.lineTo(0, 4);
      ctx2d.lineTo(-3.5, 0);
      ctx2d.closePath();
      ctx2d.fillStyle = "rgba(255,255,255,0.9)";
      ctx2d.fill();

      ctx2d.globalAlpha = alpha * 0.55;
      ctx2d.beginPath();
      ctx2d.arc(0,0,7,0,Math.PI*2);
      ctx2d.fillStyle = "rgba(88,247,255,0.18)";
      ctx2d.fill();

      ctx2d.restore();
    }

    requestAnimationFrame(drawSparks);
  }
  drawSparks();

  // ===== Audio System (richer SFX palette) =====
  let audioCtx = null;
  let musicNodes = [];
  let musicTimer = null;

  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
  }
  function sfxOn(){ return !!sfxToggle.checked; }

  function stopMusic(){
    if (musicTimer){ clearInterval(musicTimer); musicTimer = null; }
    musicNodes.forEach(n => { try{ n.stop && n.stop(); }catch(_){} try{ n.disconnect && n.disconnect(); }catch(_){} });
    musicNodes = [];
  }

  // Helpers
  function mkNoiseBuffer(dur=0.2){
    const size = Math.floor(audioCtx.sampleRate * dur);
    const buf = audioCtx.createBuffer(1, size, audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<size;i++){
      const x = i/size;
      const decay = Math.exp(-10*x);
      data[i] = (Math.random()*2-1) * decay;
    }
    return buf;
  }

  // 1) Tap (click + subtle paper rustle)
  function playTap(){
    if (!sfxOn()) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = "triangle";
    osc.frequency.setValueAtTime(520, t0);
    osc.frequency.exponentialRampToValueAtTime(420, t0 + 0.06);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.05, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.09);
    osc.connect(g).connect(audioCtx.destination);
    osc.start(t0);
    osc.stop(t0 + 0.10);

    // Rustle layer
    const noise = audioCtx.createBufferSource();
    noise.buffer = mkNoiseBuffer(0.18);

    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.setValueAtTime(1700, t0);

    const ng = audioCtx.createGain();
    ng.gain.setValueAtTime(0.0001, t0);
    ng.gain.exponentialRampToValueAtTime(0.03, t0 + 0.02);
    ng.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);

    noise.connect(lp).connect(ng).connect(audioCtx.destination);
    noise.start(t0);
  }

  // 2) Page flip (for type changes)
  function playFlip(){
    if (!sfxOn()) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;

    // broadband noise burst + bandpass sweep
    const src = audioCtx.createBufferSource();
    src.buffer = mkNoiseBuffer(0.28);

    const bp = audioCtx.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.setValueAtTime(900, t0);
    bp.frequency.exponentialRampToValueAtTime(2400, t0 + 0.10);
    bp.frequency.exponentialRampToValueAtTime(700, t0 + 0.26);
    bp.Q.setValueAtTime(0.8, t0);

    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.08, t0 + 0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.28);

    src.connect(bp).connect(g).connect(audioCtx.destination);
    src.start(t0);

    // tiny “thump” at end
    const th = audioCtx.createOscillator();
    const tg = audioCtx.createGain();
    th.type = "sine";
    th.frequency.setValueAtTime(110, t0 + 0.18);
    tg.gain.setValueAtTime(0.0001, t0 + 0.18);
    tg.gain.exponentialRampToValueAtTime(0.06, t0 + 0.19);
    tg.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.26);
    th.connect(tg).connect(audioCtx.destination);
    th.start(t0 + 0.18);
    th.stop(t0 + 0.27);
  }

  // 3) Stamp (when level-up triggers)
  function playStamp(){
    if (!sfxOn()) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;

    // punch
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = "square";
    osc.frequency.setValueAtTime(180, t0);
    osc.frequency.exponentialRampToValueAtTime(90, t0 + 0.05);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.10, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.09);
    osc.connect(g).connect(audioCtx.destination);
    osc.start(t0);
    osc.stop(t0 + 0.10);

    // papery “poof”
    const n = audioCtx.createBufferSource();
    n.buffer = mkNoiseBuffer(0.12);

    const hp = audioCtx.createBiquadFilter();
    hp.type = "highpass";
    hp.frequency.setValueAtTime(500, t0);

    const ng = audioCtx.createGain();
    ng.gain.setValueAtTime(0.0001, t0);
    ng.gain.exponentialRampToValueAtTime(0.06, t0 + 0.02);
    ng.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.12);

    n.connect(hp).connect(ng).connect(audioCtx.destination);
    n.start(t0);
  }

  // 4) Sparkle (wand magic layer) — light triad
  function playSparkle(){
    if (!sfxOn()) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;

    const notes = [880, 1108.73, 1318.51]; // A5, C#6, E6-ish
    notes.forEach((f, i) => {
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(f, t0 + i*0.02);
      g.gain.setValueAtTime(0.0001, t0 + i*0.02);
      g.gain.exponentialRampToValueAtTime(0.025, t0 + i*0.02 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + i*0.02 + 0.12);
      o.connect(g).connect(audioCtx.destination);
      o.start(t0 + i*0.02);
      o.stop(t0 + i*0.02 + 0.14);
    });
  }

  // 5) Soft success chime (export saved)
  function playSuccess(){
    if (!sfxOn()) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;

    const seq = [523.25, 659.25, 783.99]; // C E G
    seq.forEach((f, i) => {
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(f, t0 + i*0.07);
      g.gain.setValueAtTime(0.0001, t0 + i*0.07);
      g.gain.exponentialRampToValueAtTime(0.03, t0 + i*0.07 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + i*0.07 + 0.22);
      o.connect(g).connect(audioCtx.destination);
      o.start(t0 + i*0.07);
      o.stop(t0 + i*0.07 + 0.24);
    });
  }

  // ===== Music (same 3 modes) =====
  function setMusic(mode){
    ensureAudio();
    stopMusic();
    if (mode === "off") return;

    const master = audioCtx.createGain();
    master.gain.value = 0.12;
    master.connect(audioCtx.destination);

    const now = () => audioCtx.currentTime;
    const mkOsc = (type, freq) => {
      const o = audioCtx.createOscillator();
      o.type = type;
      o.frequency.value = freq;
      return o;
    };
    const mkEnv = (peak=0.06) => {
      const g = audioCtx.createGain();
      g.gain.value = 0.0001;
      g._peak = peak;
      return g;
    };
    const trigger = (g, t, a=0.01, d=0.18, peak=null) => {
      const p = peak ?? g._peak ?? 0.06;
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(p, t + a);
      g.gain.exponentialRampToValueAtTime(0.0001, t + a + d);
    };

    if (mode === "chip"){
      const scale = [0, 3, 7, 10];
      const base = 220;
      let step = 0;
      musicTimer = setInterval(() => {
        const t = now() + 0.02;
        const n = scale[step % scale.length];
        const freq = base * Math.pow(2, n/12);

        const o = mkOsc("square", freq);
        const g = mkEnv(0.030);
        const lp = audioCtx.createBiquadFilter();
        lp.type = "lowpass";
        lp.frequency.value = 1400;

        o.connect(lp).connect(g).connect(master);
        o.start(t);
        o.stop(t + 0.22);
        trigger(g, t, 0.01, 0.16, 0.028);

        musicNodes.push(o,g,lp);
        step++;
      }, 220);

    } else if (mode === "pad"){
      const chord = [261.63, 311.13, 392.00];
      const g = audioCtx.createGain();
      g.gain.value = 0.028;

      const lp = audioCtx.createBiquadFilter();
      lp.type = "lowpass";
      lp.frequency.value = 900;

      const lfo = mkOsc("sine", 0.12);
      const lfoG = audioCtx.createGain();
      lfoG.gain.value = 45;
      lfo.connect(lfoG).connect(lp.frequency);

      g.connect(lp).connect(master);

      chord.forEach((f,i) => {
        const o = mkOsc("sine", f);
        o.detune.value = (i-1) * 6;
        o.connect(g);
        o.start();
        musicNodes.push(o);
      });
      lfo.start();
      musicNodes.push(g,lp,lfo,lfoG);

    } else if (mode === "bells"){
      const notes = [523.25, 659.25, 783.99, 1046.50];
      musicTimer = setInterval(() => {
        const t = now() + 0.02;
        const f = notes[Math.floor(Math.random()*notes.length)];
        const o = mkOsc("sine", f);
        const g = mkEnv(0.020);
        const hp = audioCtx.createBiquadFilter();
        hp.type = "highpass";
        hp.frequency.value = 300;

        o.connect(hp).connect(g).connect(master);
        o.start(t);
        o.stop(t + 0.7);

        trigger(g, t, 0.01, 0.55, 0.018);
        musicNodes.push(o,g,hp);
      }, 850);
    }
  }

  // ===== UI Helpers =====
  let toastTimer = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), 1200);
  }

  let levelTimer = null;
  function levelUp(){
    levelStamp.classList.add("show");
    playStamp();
    if (levelTimer) clearTimeout(levelTimer);
    levelTimer = setTimeout(() => levelStamp.classList.remove("show"), 900);
  }

  // ===== Layout builders =====
  function el(tag, attrs = {}){
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)){
      if (k === "class") n.className = v;
      else n.setAttribute(k, v);
    }
    return n;
  }

  function buildPostIt(){
    boxes.innerHTML = "";
    boxes.append(
      el("textarea",{rows:"5",placeholder:"Box 1..."}),
      el("textarea",{rows:"5",placeholder:"Box 2..."}),
      el("textarea",{rows:"5",placeholder:"Box 3..."})
    );
    layoutHint.textContent = "POST-IT • 3 BOXES";
    stampMode.textContent = "MODE: POST-IT";
  }

  function buildNote(){
    boxes.innerHTML = "";
    boxes.append(
      el("input",{type:"text",placeholder:"Title..."}),
      el("textarea",{rows:"14",placeholder:"Write your note..."}),
      el("input",{type:"text",placeholder:"Signature..."})
    );
    layoutHint.textContent = "NOTEBOOK • TITLE + BODY + SIGNATURE";
    stampMode.textContent = "MODE: NOTEBOOK";
  }

  function buildBook(){
    boxes.innerHTML = "";
    boxes.append(
      el("input",{type:"text",placeholder:"BOOK TITLE..."}),
      el("input",{type:"text",placeholder:"Subtitle..."}),
      el("input",{type:"text",placeholder:"Author..."})
    );
    layoutHint.textContent = "BOOK COVER • TITLE + SUBTITLE + AUTHOR";
    stampMode.textContent = "MODE: BOOK";
  }

  function buildBlank(){
    boxes.innerHTML = "";
    boxes.append(el("textarea",{rows:"18",placeholder:"Free write..."}));
    layoutHint.textContent = "BLANK • FREE WRITE";
    stampMode.textContent = "MODE: BLANK";
  }

  function applyType(type){
    paper.classList.remove("postit","note","book","blank");
    paper.classList.add(type);

    paperFrame.classList.remove("layout-postit","layout-note","layout-book","layout-blank");
    paperFrame.classList.add("layout-" + type);

    playFlip();
    if (type === "postit") buildPostIt();
    else if (type === "note") buildNote();
    else if (type === "book") buildBook();
    else buildBlank();
    levelUp();
  }

  // ===== Colors =====
  const colorNames = {
    "--p1":"IVORY",
    "--p2":"LAVENDER",
    "--p3":"MINT",
    "--p4":"PEACH",
    "--p5":"SLATE",
    "--p6":"LILAC",
    "--p7":"BUTTER",
    "--p8":"SKY"
  };
  function applyColor(cssVar){
    const val = getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
    document.documentElement.style.setProperty("--paperColor", val);
    colorHint.textContent = colorNames[cssVar] || "COLOR";

    chips.forEach(ch => ch.setAttribute("aria-pressed","false"));
    const active = chips.find(ch => ch.dataset.color === cssVar);
    if (active) active.setAttribute("aria-pressed","true");

    playTap();
    levelUp();
  }

  // ===== Magic interactions =====
  // Click anywhere on paper = sparkle + sparkle sound
  paperFrame.addEventListener("pointerdown", (e) => {
    // avoid double-trigger if clicking input/textarea
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : "";
    if (tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT" || tag === "BUTTON") return;

    burst(e.clientX, e.clientY);
    playSparkle();
  }, {passive:true});

  // Focus in fields = tap
  boxes.addEventListener("focusin", () => playTap());

  // ===== Export PNG (same approach, tuned for fullscreen) =====
  async function exportPNG(){
    ensureAudio();
    playTap();
    levelUp();
    showToast("EXPORTING…");

    const node = paperFrame;
    const clone = node.cloneNode(true);

    // Remove spark canvas from clone (avoid blank/odd export)
    const cCanvas = clone.querySelector("#sparkCanvas");
    if (cCanvas) cCanvas.remove();

    const origAll = node.querySelectorAll("*");
    const cloneAll = clone.querySelectorAll("*");
    const origArr = [node, ...origAll];
    const cloneArr = [clone, ...cloneAll];

    for (let i=0;i<origArr.length;i++){
      const o = origArr[i];
      const c = cloneArr[i];
      if (!c) continue;

      // Skip the real spark canvas
      if (o.id === "sparkCanvas") continue;

      const cs = getComputedStyle(o);
      const props = [
        "display","position","inset","top","left","right","bottom",
        "width","height","margin","padding",
        "border","borderRadius","boxShadow",
        "background","backgroundImage","backgroundSize","backgroundPosition","backgroundRepeat",
        "color","font","fontFamily","fontSize","fontWeight","letterSpacing","textTransform","textAlign","lineHeight",
        "opacity","transform","filter",
        "gridTemplateRows","gridTemplateColumns","gap","alignContent","justifyContent"
      ];
      let s="";
      props.forEach(p=>{ s += `${p}:${cs.getPropertyValue(p)};`; });

      if (c.tagName === "TEXTAREA") c.textContent = o.value || "";
      if (c.tagName === "INPUT") c.setAttribute("value", o.value || "");

      c.setAttribute("style", s);
    }

    const wrap = document.createElement("div");
    wrap.appendChild(clone);

    const rect = node.getBoundingClientRect();
    const w = rect.width, h = rect.height;

    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="${Math.ceil(w)}" height="${Math.ceil(h)}">
        <foreignObject width="100%" height="100%">
          <div xmlns="http://www.w3.org/1999/xhtml">${wrap.innerHTML}</div>
        </foreignObject>
      </svg>
    `;

    const blob = new Blob([svg], {type:"image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = Math.ceil(w) * 2;
      canvas.height = Math.ceil(h) * 2;
      const c = canvas.getContext("2d");
      c.scale(2,2);
      c.drawImage(img, 0, 0);
      URL.revokeObjectURL(url);

      canvas.toBlob((png) => {
        const a = document.createElement("a");
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
        a.download = `paper-picker-${stamp}.png`;
        a.href = URL.createObjectURL(png);
        document.body.appendChild(a);
        a.click();
        a.remove();
        showToast("SAVED PNG");
        playSuccess();
      }, "image/png");
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      showToast("EXPORT FAILED");
      alert("Export failed in this browser/device. Try Chrome/Edge, or enable downloads.");
    };
    img.src = url;
  }

  // ===== Toolbar events =====
  paperType.addEventListener("change", () => applyType(paperType.value));
  musicMode.addEventListener("change", () => { playTap(); setMusic(musicMode.value); });

  chips.forEach(ch => ch.addEventListener("click", () => applyColor(ch.dataset.color)));

  randomBtn.addEventListener("click", () => {
    playTap();
    const types = ["postit","note","book","blank"];
    const colors = ["--p1","--p2","--p3","--p4","--p5","--p6","--p7","--p8"];
    const t = types[Math.floor(Math.random()*types.length)];
    const c = colors[Math.floor(Math.random()*colors.length)];
    paperType.value = t;
    applyType(t);
    applyColor(c);
    showToast("RANDOMIZED");
  });

  clearBtn.addEventListener("click", () => {
    playTap();
    const fields = boxes.querySelectorAll("textarea, input[type='text']");
    fields.forEach(f => f.value = "");
    showToast("CLEARED");
  });

  exportBtn.addEventListener("click", exportPNG);

  // ===== Start (unlock audio) =====
  startBtn.addEventListener("click", () => {
    ensureAudio();
    playTap();
    splash.classList.add("hidden");
  });

  // ===== Init =====
  applyType("postit");
  // Don't call applyColor here because it plays sounds / levelUp; do silent init:
  const initVar = "--p1";
  document.documentElement.style.setProperty("--paperColor",
    getComputedStyle(document.documentElement).getPropertyValue(initVar).trim()
  );
  colorHint.textContent = "IVORY";
})();
</script>
</body>
</html>
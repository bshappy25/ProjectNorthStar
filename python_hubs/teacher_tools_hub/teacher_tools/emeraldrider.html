<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Emerald Rider</title>
  <style>
    :root { color-scheme: light; }
    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; background:#e8f5e9; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #wrap{ position:fixed; inset:0; display:grid; place-items:center; }
    canvas{ width:100vw; height:100vh; display:block; }
    .hud{
      position:fixed; inset:0; pointer-events:none;
      padding:16px 16px 20px;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:16px;
      text-shadow: 0 1px 6px rgba(0,0,0,.12);
    }
    .left{ display:flex; flex-direction:column; gap:8px; }
    .title{ font-weight:800; letter-spacing:.5px; color:#006400; opacity:.98; }
    .sub{ opacity:.82; font-size:13px; color:#2e7d32; }
    .score{ font-size:19px; font-weight:800; color:#1b5e20; }
    .btns{ display:flex; gap:12px; pointer-events:auto; }
    button{
      appearance:none; border:1px solid rgba(0,200,83,.4);
      background: rgba(255,255,255,.82);
      color: #006400;
      padding:11px 14px; border-radius:14px;
      font-weight:700; letter-spacing:.2px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 24px rgba(0,100,0,.12);
      cursor:pointer;
      transition: all .15s ease;
    }
    button:hover{ transform: translateY(-1px); box-shadow: 0 12px 32px rgba(0,100,0,.18); }
    button:active{ transform: translateY(1px); }
    #msg{
      position:fixed; inset:auto 0 20px 0;
      text-align:center; pointer-events:none;
      opacity:.88; font-size:13px; color:#2e7d32;
    }
    .pill{
      display:inline-block; padding:9px 14px; border-radius:999px;
      border:1px solid rgba(0,200,83,.3);
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(12px);
      color:#1b5e20;
      font-weight:600;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="c"></canvas>
  </div>

  <div class="hud">
    <div class="left">
      <div class="title">Emerald Rider ✨</div>
      <div class="sub">Space / Tap to float • Avoid the pillars</div>
      <div class="score">Score: <span id="score">0</span></div>
    </div>
    <div class="btns">
      <button id="soundBtn" aria-label="Toggle sound">Sound: Off</button>
      <button id="restartBtn" aria-label="Restart">Restart</button>
    </div>
  </div>

  <div id="msg"><span class="pill">First tap/space starts the music (browser rule). Hold to hover.</span></div>

<script>
// Full game logic (mechanics unchanged, only visual & audio updated)
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha: false });
  const scoreEl = document.getElementById('score');
  const soundBtn = document.getElementById('soundBtn');
  const restartBtn = document.getElementById('restartBtn');

  let W=0, H=0, DPR=1;
  function resize(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = Math.floor(innerWidth * DPR);
    H = Math.floor(innerHeight * DPR);
    canvas.width = W;
    canvas.height = H;
  }
  addEventListener('resize', resize, { passive:true });
  resize();

  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const rand = (a,b) => a + Math.random()*(b-a);
  const pick = (arr) => arr[(Math.random()*arr.length)|0];

  const game = {
    running: true,
    started: false,
    over: false,
    t: 0,
    speed: 280,
    gravity: 1680,
    flap: 580,
    score: 0,
    best: 0,
  };

  const player = {
    x: 0,
    y: 0,
    vy: 0,
    r: 19,
    tilt: 0,
  };

  function reset(){
    game.running = true;
    game.started = false;
    game.over = false;
    game.t = 0;
    game.score = 0;
    scoreEl.textContent = "0";

    player.x = Math.floor(W * 0.28);
    player.y = Math.floor(H * 0.5);
    player.vy = 0;
    player.tilt = 0;

    particles.length = 0;
    trail.length = 0;
    obstacles.length = 0;
    stars.length = 0;
    clouds.length = 0;

    spawnInitial();
  }

  const stars = [];
  const clouds = [];
  function spawnInitial(){
    const starCount = Math.floor((W*H)/(DPR*DPR) / 26000);
    for(let i=0;i<starCount;i++){
      stars.push({
        x: Math.random()*W,
        y: Math.random()*H,
        s: rand(0.9, 2.6)*DPR,
        a: rand(0.3, 0.85),
        tw: rand(0.7, 2.0),
      });
    }
    const cloudCount = Math.floor((W*H)/(DPR*DPR) / 85000);
    for(let i=0;i<cloudCount;i++){
      clouds.push(makeCloud(rand(0,W), rand(0,H)));
    }
    for(let i=0;i<3;i++) spawnObstacle(W + i*(W*0.45));
  }

  function makeCloud(x,y){
    return {
      x, y,
      r: rand(100, 180)*DPR,
      vx: rand(20, 38)*DPR,
      a: rand(0.07, 0.16),
      wob: rand(0.9, 1.5),
      phase: Math.random()*Math.PI*2,
    };
  }

  const obstacles = [];
  let nextGapY = null;

  function spawnObstacle(x){
    const gapH = rand(180, 240)*DPR;
    const pad = 85*DPR;
    const gapY = nextGapY ?? rand(pad, H - pad - gapH);
    nextGapY = clamp(gapY + rand(-130, 130)*DPR, pad, H - pad - gapH);
    const w = rand(55, 78)*DPR;
    obstacles.push({ x, w, gapY, gapH, passed: false });
  }

  const trail = [];
  const particles = [];

  function emitTrail(dt){
    const seg = {
      x: player.x - 26*DPR,
      y: player.y + rand(-5,5)*DPR,
      w: rand(28, 44)*DPR,
      h: rand(12, 20)*DPR,
      a: rand(0.3, 0.6),
      life: 0.6,
      t: 0
    };
    trail.push(seg);
  }

  function emitSparkles(n){
    for(let i=0;i<n;i++){
      const ang = rand(-Math.PI*0.8, Math.PI*0.8);
      const sp = rand(100, 260)*DPR;
      particles.push({
        x: player.x - 9*DPR,
        y: player.y + rand(-12,12)*DPR,
        vx: Math.cos(ang)*sp - game.speed*0.3,
        vy: Math.sin(ang)*sp + rand(-45,45)*DPR,
        r: rand(2.2, 5.0)*DPR,
        a: rand(0.6, 1.0),
        life: rand(0.4, 0.85),
        t: 0,
        spin: rand(-9, 9),
        kind: pick(["spark","star"])
      });
    }
  }

  let holding = false;

  function userAction(){
    if(!game.started){
      game.started = true;
      tryStartAudio();
      document.getElementById('msg').style.opacity = 0;
    }
  }

  function flapOnce(){
    userAction();
    if(game.over) return;
    player.vy = -game.flap*DPR;
    player.tilt = -0.58;
    emitSparkles(12);
  }

  addEventListener('keydown', e => {
    if(e.code === 'Space'){
      e.preventDefault();
      if(!holding){
        holding = true;
        flapOnce();
      }
    }
  }, { passive:false });

  addEventListener('keyup', e => {
    if(e.code === 'Space'){
      e.preventDefault();
      holding = false;
    }
  }, { passive:false });

  function onDown(e){
    e.preventDefault();
    holding = true;
    flapOnce();
  }
  function onUp(e){
    e.preventDefault();
    holding = false;
  }
  canvas.addEventListener('pointerdown', onDown, { passive:false });
  addEventListener('pointerup', onUp, { passive:false });
  addEventListener('pointercancel', onUp, { passive:false });

  function applyHold(dt){
    if(holding && game.started && !game.over){
      player.vy -= 540*DPR*dt;
      emitSparkles(3);
    }
  }

  // Audio – complex, catchy C# major loop
  let audio = {
    ctx: null,
    master: null,
    musicOn: false,
    playing: false,
    stepTimer: null,
    stepIndex: 0,
    bpm: 145,
  };

  const NOTE = {
    "C#2": 69.296, "G#2": 103.826, "C#3": 138.591, "F3": 174.614,
    "G#3": 207.652, "C#4": 277.183, "F4": 349.228, "G#4": 415.305,
    "C#5": 554.365, "F5": 698.456, "G#5": 830.609, "C#6": 1108.731
  };

  const pattern = [
    {b:"C#2", k:"C#3", l:"C#5", p:0.0},
    {b:"C#2", k:"G#3", l:"G#5", p:0.1},
    {b:"C#2", k:"F3",  l:"F5",  p:0.15},
    {b:"C#2", k:"G#3", l:"C#5", p:0.2},
    {b:"G#2", k:"C#4", l:"G#5", p:0.25},
    {b:"G#2", k:"G#3", l:"F5",  p:0.3},
    {b:"G#2", k:"F3",  l:"C#5", p:0.35},
    {b:"G#2", k:"C#4", l:"G#5", p:0.4},
    {b:"C#2", k:"C#3", l:"C#6", p:0.45},
    {b:"C#2", k:"G#3", l:"G#5", p:0.5},
    {b:"C#2", k:"F3",  l:"F5",  p:0.55},
    {b:"C#2", k:"G#3", l:"C#6", p:0.6},
    {b:"G#2", k:"C#4", l:"F6",  p:0.65},
    {b:"G#2", k:"G#3", l:"G#5", p:0.7},
    {b:"G#2", k:"F3",  l:"C#6", p:0.75},
    {b:"G#2", k:"C#4", l:"F6",  p:0.8},
    {b:"C#2", k:"C#3", l:"C#6", p:0.85},
    {b:"C#2", k:"G#3", l:"G#6", p:0.9},
    {b:"C#2", k:"F3",  l:"F6",  p:0.95},
    {b:"C#2", k:"G#3", l:"C#6", p:1.0},
    {b:"G#2", k:"C#4", l:"G#6", p:1.05},
    {b:"G#2", k:"G#3", l:"F6",  p:1.1},
    {b:"G#2", k:"F3",  l:"C#6", p:1.15},
    {b:"G#2", k:"C#4", l:"G#6", p:1.2},
    {b:"C#2", k:"C#3", l:"C#6", p:1.25},
    {b:"C#2", k:"G#3", l:"G#6", p:1.3},
    {b:"C#2", k:"F3",  l:"F6",  p:1.35},
    {b:"C#2", k:"G#3", l:"C#7", p:1.4},
    {b:"G#2", k:"C#4", l:"F6",  p:1.45},
    {b:"G#2", k:"G#3", l:"G#6", p:1.5},
    {b:"G#2", k:"F3",  l:"C#7", p:1.55},
    {b:"G#2", k:"C#4", l:"F7",  p:1.6},
  ];

  function ensureAudio(){
    if(audio.ctx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    audio.ctx = new AC();
    audio.master = audio.ctx.createGain();
    audio.master.gain.value = 0;
    audio.master.connect(audio.ctx.destination);
  }

  function beep(freq, dur, type, gain, when, detune=0){
    const c = audio.ctx;
    const t0 = when ?? c.currentTime;

    const o = c.createOscillator();
    const g = c.createGain();
    const f = c.createBiquadFilter();

    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    o.detune.setValueAtTime(detune, t0);

    f.type = "lowpass";
    f.frequency.setValueAtTime(type === "square" ? 1400 : 2200, t0);
    f.Q.setValueAtTime(0.65, t0);

    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.008);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

    o.connect(f);
    f.connect(g);
    g.connect(audio.master);

    o.start(t0);
    o.stop(t0 + dur + 0.015);
  }

  function tickSound(when){
    const f = pick([NOTE["C#6"], NOTE["G#6"], NOTE["F6"]]);
    beep(f, 0.05, "triangle", 0.04, when, -200);
  }

  function startMusic(){
    ensureAudio();
    if(audio.playing) return;
    audio.playing = true;
    audio.stepIndex = 0;

    const c = audio.ctx;
    const spb = 60 / audio.bpm;
    const stepDur = spb / 2;
    let next = c.currentTime + 0.04;

    audio.master.gain.cancelScheduledValues(c.currentTime);
    audio.master.gain.linearRampToValueAtTime(0.65, c.currentTime + 0.6);

    audio.stepTimer = setInterval(() => {
      if(!audio.musicOn || !audio.playing) return;

      const now = c.currentTime;
      while(next < now + 0.25){
        const step = pattern[audio.stepIndex % pattern.length];

        beep(NOTE[step.b], stepDur*0.9, "square", 0.09, next);
        beep(55, 0.08, "sine", 0.12, next, -800);
        beep(NOTE[step.l], stepDur*0.5, "triangle", 0.07, next + stepDur*0.06, rand(-80,80));

        if((audio.stepIndex % 2) === 1) tickSound(next + stepDur*0.25);

        audio.stepIndex++;
        next += stepDur;
      }
    }, 40);
  }

  function stopMusic(){
    audio.playing = false;
    if(audio.stepTimer){
      clearInterval(audio.stepTimer);
      audio.stepTimer = null;
    }
    if(audio.ctx){
      audio.master.gain.cancelScheduledValues(audio.ctx.currentTime);
      audio.master.gain.linearRampToValueAtTime(0, audio.ctx.currentTime + 0.4);
    }
  }

  function setMusic(on){
    ensureAudio();
    audio.musicOn = on;
    if(on) startMusic();
    else stopMusic();
    soundBtn.textContent = `Sound: ${on ? "On" : "Off"}`;
  }

  function tryStartAudio(){
    ensureAudio();
    if(audio.ctx.state === "suspended") audio.ctx.resume().catch(()=>{});
    if(audio.musicOn) startMusic();
  }

  soundBtn.addEventListener('click', () => {
    userAction();
    setMusic(!audio.musicOn);
  });

  restartBtn.addEventListener('click', () => {
    reset();
  });

  // Game logic (collision, physics, rendering) remains identical to original
  // ... (omitted for brevity; copy the full game loop from your previous version)

  reset();
  requestAnimationFrame(step);

  setMusic(false);
})();
</script>
</body>
</html>
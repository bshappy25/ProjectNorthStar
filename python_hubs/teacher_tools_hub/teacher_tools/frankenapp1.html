<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PBIS Canvas Studio — Landscape Export (Text + 3 Images)</title>
<style>
:root{
  --bg:#f3f3f3; --card:#fff; --ink:#111; --muted:#444; --line:#cfcfcf; --r:14px;
  --blue:#0b2a5b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Arial;
  background:var(--bg);
  color:var(--ink);
  overflow:hidden; /* NO SCROLL */
}
.top{
  height:64px; background:#000; color:#fff;
  display:flex; align-items:center; gap:10px; padding:0 14px;
}
.badge{
  width:34px; height:34px; border-radius:999px;
  border:2px solid #fff; display:grid; place-items:center; font-weight:900;
}
.wrap{height:calc(100vh - 64px); padding:12px; display:flex; justify-content:center;}
.card{
  width:min(1200px,100%);
  background:var(--card);
  border:2px solid var(--line);
  border-radius:var(--r);
  padding:12px;
  display:flex;
  flex-direction:column;
  min-height:0;
}
.grid{display:flex; gap:12px; min-height:0; flex:1;}
.col{
  flex:1; min-width:0;
  border:2px dotted var(--line);
  border-radius:12px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0;
}
.row{display:flex; gap:10px; min-width:0}
.row.wrap{flex-wrap:wrap; height:auto; padding:0; justify-content:flex-start}

.h{margin:0;font-weight:900}
.m{margin:0;color:var(--muted);font-weight:700}
label.m{display:block}
input,textarea{
  width:100%;
  border:2px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
  font-size:16px;
}
textarea{resize:none; height:48px;} /* tight: prevents scroll */

.btn{
  flex:1; min-width:0;
  border:2px solid #000; background:#fff; color:#000;
  border-radius:12px; padding:12px;
  font-weight:900; cursor:pointer; user-select:none; white-space:nowrap;
}
.btn.on{background:#000;color:#fff}
.small{
  flex:0 0 auto;
  border:2px solid #000; background:#fff;
  border-radius:12px; padding:10px 12px;
  font-weight:900; cursor:pointer; user-select:none; white-space:nowrap;
}
.small.primary{background:#000;color:#fff}

.foot{
  display:flex; gap:10px; flex-wrap:wrap;
  justify-content:flex-end; margin-top:auto; /* pins buttons bottom */
}

/* PBIS checks: compact */
.checks{
  border:2px solid var(--line);
  border-radius:12px;
  padding:8px 10px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px 10px;
}
.check{
  display:flex; align-items:center; gap:8px;
  font-weight:900; color:#000; font-size:0.92rem; line-height:1.1; min-width:0;
}
.check input{width:18px;height:18px;accent-color:#000;}
.check.full{grid-column:1 / -1;}

/* RIGHT column: image pickers + live mini previews */
.imgGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto auto;
  gap:10px;
}
.imgSlot{
  border:2px solid var(--line);
  border-radius:12px;
  padding:10px;
  background:#fff;
  display:flex;
  flex-direction:column;
  gap:8px;
  min-height:0;
}
.imgSlot.big{ grid-column: 1 / -1; }
.imgSlot .cap{font-weight:900;color:#000;}
.imgSlot .hint{margin:0;color:var(--muted);font-weight:700;font-size:.92rem;}
.imgSlot input[type="file"]{font-size:14px;}
.thumb{
  flex:1;
  min-height:0;
  border:2px solid #000;
  border-radius:10px;
  overflow:hidden;
  background:#fff;
  display:grid;
  place-items:center;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
.thumb .ph{
  color:var(--muted);
  font-weight:900;
  text-align:center;
  padding:8px;
  font-size:.95rem;
}

/* PREVIEW STAGE: canvas owns space; JPEG overlay doesn't shift layout */
.previewStage{
  position:relative;
  flex:1;
  min-height:0;
  border:2px solid #000;
  border-radius:12px;
  overflow:hidden;
  background:#fff;
}
canvas{width:100%;height:100%;display:block}

/* JPEG overlay */
.jpegOverlay{
  position:absolute;
  inset:10px;
  border-radius:12px;
  border:2px solid var(--line);
  background:rgba(255,255,255,0.86);
  display:none;
  padding:10px;
  overflow:hidden;
}
.jpegOverlay .bar{
  display:flex; justify-content:space-between; align-items:center;
  gap:10px; margin-bottom:8px;
}
.jpegOverlay .hint{
  margin:0; font-weight:800; color:var(--muted); font-size:.92rem;
}
.jpegOverlay .close{
  border:2px solid #000; background:#fff;
  border-radius:10px; padding:8px 10px;
  font-weight:900; cursor:pointer;
}
.jpegOverlay img{
  width:100%;
  height:calc(100% - 44px);
  object-fit:contain;
  display:block;
  border-radius:10px;
  background:#fff;
}
</style>
</head>

<body>
<div class="top">
  <div class="badge">PB</div>
  <div>
    <div style="font-weight:900;letter-spacing:.08em">PBIS CANVAS STUDIO</div>
    <div style="font-weight:700;opacity:.85;font-size:.92rem">Landscape Export • Text Log + 3 Images • No Scroll</div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="grid">

      <!-- LEFT: TEXT LOG -->
      <div class="col" id="left">
        <p class="h" id="status">Tap CHECK IN / REFLECT / GOAL. Canvas updates instantly.</p>

        <div class="row wrap" role="group" aria-label="Activities">
          <button class="btn" id="tCheck" type="button">CHECK IN</button>
          <button class="btn" id="tReflect" type="button">REFLECT</button>
          <button class="btn" id="tGoal" type="button">GOAL</button>
        </div>

        <div class="row">
          <div style="flex:1;min-width:0">
            <p class="m">Student</p>
            <input id="name" placeholder="Name"/>
          </div>
          <div style="flex:1;min-width:0">
            <p class="m">Group</p>
            <input id="group" placeholder="Period"/>
          </div>
        </div>

        <p class="m">PBIS Checks (5)</p>
        <div class="checks" aria-label="PBIS Checks">
          <label class="check"><input type="checkbox" id="c1"/>ENGAGE in SAFTEY</label>
          <label class="check"><input type="checkbox" id="c2"/>LEARN TO EARN</label>
          <label class="check"><input type="checkbox" id="c3"/>ALWAYS RESPECTFUL</label>
          <label class="check"><input type="checkbox" id="c4"/>DO THE RIGHT THING</label>
          <label class="check full"><input type="checkbox" id="c5"/>MY GOAL POINT</label>
        </div>

        <p class="m">CHECK IN</p><textarea id="a1" placeholder="Today I will…"></textarea>
        <p class="m">REFLECT</p><textarea id="b1" placeholder="What happened?"></textarea>
        <p class="m">GOAL</p><textarea id="g1" placeholder="My goal point is…"></textarea>

        <div class="foot">
          <button class="small" id="preview" type="button">Preview JPEG</button>
          <button class="small primary" id="download" type="button">Download JPEG</button>
          <button class="small" id="openTab" type="button" title="Fallback if downloads are blocked">Open JPEG Tab</button>
          <button class="small" id="clear" type="button">Clean Up</button>
        </div>

        <p class="m" id="note">If Sites blocks downloads: Preview → long-press image → Save. Or use “Open JPEG Tab”.</p>
      </div>

      <!-- RIGHT: IMAGES + CANVAS PREVIEW -->
      <div class="col" id="right">
        <p class="h">Images (max 3) + Export Preview</p>

        <div class="imgGrid">
          <div class="imgSlot big">
            <div class="cap">IMAGE A (Large)</div>
            <p class="hint">Upload one main image (top-right in export).</p>
            <input id="imgA" type="file" accept="image/*"/>
            <div class="thumb" id="thumbA"><div class="ph">No image</div></div>
          </div>

          <div class="imgSlot">
            <div class="cap">IMAGE B (Small)</div>
            <p class="hint">Bottom-right (left).</p>
            <input id="imgB" type="file" accept="image/*"/>
            <div class="thumb" id="thumbB"><div class="ph">No image</div></div>
          </div>

          <div class="imgSlot">
            <div class="cap">IMAGE C (Small)</div>
            <p class="hint">Bottom-right (right).</p>
            <input id="imgC" type="file" accept="image/*"/>
            <div class="thumb" id="thumbC"><div class="ph">No image</div></div>
          </div>
        </div>

        <div class="previewStage" id="stage" style="margin-top:10px;">
          <canvas id="cv"></canvas>

          <div class="jpegOverlay" id="jpegBox">
            <div class="bar">
              <p class="hint">JPEG Preview</p>
              <button class="close" id="closeJpeg" type="button">Close</button>
            </div>
            <img id="jpegImg" alt="JPEG Preview"/>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const $=(s,el=document)=>el.querySelector(s);

// -------- STATE --------
const S={check:false,reflect:false,goal:false};
const btns={check:$("#tCheck"),reflect:$("#tReflect"),goal:$("#tGoal")};
const f={
  name:$("#name"), group:$("#group"),
  a1:$("#a1"), b1:$("#b1"), g1:$("#g1"),
  c1:$("#c1"), c2:$("#c2"), c3:$("#c3"), c4:$("#c4"), c5:$("#c5"),
};

const cv=$("#cv");
const ctx=cv.getContext("2d",{alpha:false});

const imgs = { A:null, B:null, C:null }; // dataURL strings
const imgObjs = { A:null, B:null, C:null }; // Image() objects

// -------- ACTIVITIES --------
function toggle(k){
  S[k]=!S[k];
  btns[k].classList.toggle("on",S[k]);
  hideJpeg();
  draw("screen");
}
btns.check.onclick=()=>toggle("check");
btns.reflect.onclick=()=>toggle("reflect");
btns.goal.onclick=()=>toggle("goal");

// -------- JPEG OVERLAY --------
let lastTab=null;
function hideJpeg(){
  $("#jpegBox").style.display="none";
}
$("#closeJpeg").onclick=hideJpeg;

// -------- INPUT HOOKS --------
["input","change"].forEach(evt=>{
  Object.values(f).forEach(el=>el.addEventListener(evt, ()=>{ hideJpeg(); draw("screen"); }));
});

// -------- IMAGE UPLOADS --------
function setThumb(slot, dataUrl){
  const box = $("#thumb"+slot);
  box.innerHTML = "";
  if(!dataUrl){
    const ph=document.createElement("div");
    ph.className="ph";
    ph.textContent="No image";
    box.appendChild(ph);
    return;
  }
  const im=document.createElement("img");
  im.src=dataUrl;
  box.appendChild(im);
}

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}

async function handleImg(slot, inputEl){
  const file = (inputEl.files && inputEl.files[0]) ? inputEl.files[0] : null;
  if(!file){
    imgs[slot]=null; imgObjs[slot]=null; setThumb(slot,null);
    hideJpeg(); draw("screen"); return;
  }
  const dataUrl = await fileToDataURL(file);
  imgs[slot]=dataUrl;
  setThumb(slot,dataUrl);

  const im = new Image();
  im.onload = ()=>{ imgObjs[slot]=im; hideJpeg(); draw("screen"); };
  im.onerror = ()=>{ imgObjs[slot]=null; hideJpeg(); draw("screen"); };
  im.src = dataUrl;

  inputEl.value = ""; // allows re-upload of same file if needed
}

$("#imgA").addEventListener("change", (e)=>handleImg("A", e.target));
$("#imgB").addEventListener("change", (e)=>handleImg("B", e.target));
$("#imgC").addEventListener("change", (e)=>handleImg("C", e.target));

// -------- CANVAS FIT --------
function fit(){
  const box=$("#stage").getBoundingClientRect();
  const dpr=Math.max(1,window.devicePixelRatio||1);
  cv.width=Math.floor(box.width*dpr);
  cv.height=Math.floor(box.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw("screen");
}
window.addEventListener("resize",fit);

// -------- TEXT WRAP (stable) --------
function wrapLines(t,max=56){
  const w=(t||"").replace(/\r/g,"").split(/\s+/).filter(Boolean);
  let out=[], line="";
  for(const word of w){
    const test=line?line+" "+word:word;
    if(test.length>max){ if(line) out.push(line); line=word; }
    else line=test;
  }
  if(line) out.push(line);
  return out;
}
function checkedLabels(){
  const labels=[];
  if(f.c1.checked) labels.push("ENGAGE in SAFTEY");
  if(f.c2.checked) labels.push("LEARN TO EARN");
  if(f.c3.checked) labels.push("ALWAYS RESPECTFUL");
  if(f.c4.checked) labels.push("DO THE RIGHT THING");
  if(f.c5.checked) labels.push("MY GOAL POINT");
  return labels;
}

// -------- DRAW: LANDSCAPE CANVAS ENGINE --------
function draw(mode="screen"){
  const W=cv.clientWidth, H=cv.clientHeight;
  const dateStr = new Date().toLocaleDateString();

  // Always draw as landscape composition INSIDE whatever preview box size exists.
  // We build a virtual 1920×1080 layout and scale to fit.
  const baseW = 1920, baseH = 1080;
  const scale = Math.min(W/baseW, H/baseH);
  const ox = Math.floor((W - baseW*scale)/2);
  const oy = Math.floor((H - baseH*scale)/2);

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,W,H);

  ctx.save();
  ctx.translate(ox, oy);
  ctx.scale(scale, scale);

  // background
  ctx.fillStyle="#ffffff";
  ctx.fillRect(0,0,baseW,baseH);

  // header (screen black, download blue with date)
  const headerH = 96;
  if(mode==="download"){
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--blue").trim() || "#0b2a5b";
  }else{
    ctx.fillStyle="#000000";
  }
  ctx.fillRect(0,0,baseW,headerH);

  // header text
  ctx.fillStyle="#ffffff";
  ctx.textAlign="left";
  ctx.font="900 46px system-ui, -apple-system, Segoe UI, Arial";
  ctx.fillText("PBIS TICKET", 44, 62);

  ctx.font="700 30px system-ui, -apple-system, Segoe UI, Arial";
  ctx.fillText("W.L.E.A.D.", 44, 92);

  if(mode==="download"){
    ctx.textAlign="right";
    ctx.font="900 34px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("Date: " + dateStr, baseW-44, 62);
    ctx.textAlign="left";
  }

  // layout regions
  const pad = 44;
  const contentTop = headerH + 34;

  const leftW = 980;          // text log dominant
  const gap = 40;
  const rightX = pad + leftW + gap;
  const rightW = baseW - rightX - pad;

  // left panel box
  ctx.strokeStyle="#cfcfcf";
  ctx.lineWidth=4;
  ctx.strokeRect(pad, contentTop, leftW, baseH - contentTop - pad);

  // right panel box
  ctx.strokeRect(rightX, contentTop, rightW, baseH - contentTop - pad);

  // --- LEFT: TEXT LOG ---
  let x = pad + 34;
  let y = contentTop + 60;

  const student = (f.name.value||"").trim() || "__________";
  const group = (f.group.value||"").trim() || "—";

  ctx.fillStyle="#111";
  ctx.font="900 52px system-ui, -apple-system, Segoe UI, Arial";
  ctx.fillText("Student: " + student, x, y);
  y += 64;

  ctx.font="800 40px system-ui, -apple-system, Segoe UI, Arial";
  ctx.fillText("Group: " + group + "   Date: " + dateStr, x, y);
  y += 44;

  // divider
  ctx.strokeStyle="#cfcfcf";
  ctx.lineWidth=4;
  ctx.beginPath(); ctx.moveTo(x, y+24); ctx.lineTo(pad+leftW-34, y+24); ctx.stroke();
  y += 80;

  // checks
  const checks = checkedLabels();
  if(checks.length){
    ctx.fillStyle="#000";
    ctx.font="900 44px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("PBIS CHECKS:", x, y);
    y += 58;

    ctx.font="800 36px system-ui, -apple-system, Segoe UI, Arial";
    const joined = checks.join(" • ");
    const cLines = wrapLines(joined, 42).slice(0,2);
    for(const ln of cLines){
      ctx.fillText(ln, x, y);
      y += 46;
    }
    y += 24;

    ctx.strokeStyle="#cfcfcf";
    ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(pad+leftW-34, y); ctx.stroke();
    y += 66;
  }

  // body sections
  const any = S.check || S.reflect || S.goal;

  function section(title, text){
    ctx.fillStyle="#000";
    ctx.font="900 44px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText(title, x, y);
    y += 56;

    ctx.font="800 38px system-ui, -apple-system, Segoe UI, Arial";
    const lines = wrapLines(text || "", 46).slice(0,3);
    if(lines.length===0){
      ctx.fillText("—", x, y); y += 46;
    }else{
      for(const ln of lines){ ctx.fillText(ln, x, y); y += 46; }
    }
    y += 54;
  }

  if(S.check)  section("CHECK IN:", f.a1.value);
  if(S.reflect) section("REFLECT:", f.b1.value);
  if(S.goal)   section("GOAL:", f.g1.value);

  if(!any){
    ctx.fillStyle="#111";
    ctx.font="900 40px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText("Tap CHECK IN / REFLECT / GOAL to add sections.", x, y);
  }

  // --- RIGHT: 3 IMAGES (1 large + 2 small) ---
  const rx = rightX + 26;
  const ry = contentTop + 26;
  const rPad = 26;
  const rInnerW = rightW - 52;
  const rInnerH = baseH - contentTop - pad - 52;

  // large top region ~ 62% height
  const bigH = Math.floor(rInnerH * 0.62);
  const smallH = rInnerH - bigH - 18;
  const smallW = Math.floor((rInnerW - 18) / 2);

  // draw frames
  function frame(px,py,pw,ph,label){
    ctx.strokeStyle="#000";
    ctx.lineWidth=4;
    ctx.strokeRect(px,py,pw,ph);
    ctx.fillStyle="#444";
    ctx.font="900 28px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText(label, px+14, py+38);
  }

  const A = { x: rx, y: ry, w: rInnerW, h: bigH };
  const B = { x: rx, y: ry + bigH + 18, w: smallW, h: smallH };
  const C = { x: rx + smallW + 18, y: ry + bigH + 18, w: smallW, h: smallH };

  // helpers to cover-crop images into rectangles
  function drawCover(img, rect){
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    if(!iw || !ih) return;

    const r = rect.w / rect.h;
    const ir = iw / ih;

    let sx=0, sy=0, sw=iw, sh=ih;
    if(ir > r){
      // image too wide -> crop sides
      sh = ih;
      sw = Math.floor(ih * r);
      sx = Math.floor((iw - sw)/2);
      sy = 0;
    }else{
      // image too tall -> crop top/bottom
      sw = iw;
      sh = Math.floor(iw / r);
      sx = 0;
      sy = Math.floor((ih - sh)/2);
    }

    ctx.save();
    ctx.beginPath();
    ctx.rect(rect.x, rect.y, rect.w, rect.h);
    ctx.clip();
    ctx.drawImage(img, sx, sy, sw, sh, rect.x, rect.y, rect.w, rect.h);
    ctx.restore();

    // border again (clean)
    ctx.strokeStyle="#000";
    ctx.lineWidth=4;
    ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
  }

  // A
  if(imgObjs.A){
    drawCover(imgObjs.A, A);
  }else{
    frame(A.x,A.y,A.w,A.h,"IMAGE A (Large)");
    ctx.fillStyle="#444";
    ctx.font="800 28px system-ui";
    ctx.fillText("Upload on the right panel", A.x+14, A.y+78);
  }

  // B
  if(imgObjs.B){
    drawCover(imgObjs.B, B);
  }else{
    frame(B.x,B.y,B.w,B.h,"IMAGE B");
  }

  // C
  if(imgObjs.C){
    drawCover(imgObjs.C, C);
  }else{
    frame(C.x,C.y,C.w,C.h,"IMAGE C");
  }

  ctx.restore();

  // status line
  $("#status").textContent =
    ("Selected: " + (S.check?"CHECK IN ":"") + (S.reflect?"REFLECT ":"") + (S.goal?"GOAL":"")).trim()
    || "Tap CHECK IN / REFLECT / GOAL. Canvas updates instantly.";
}

// -------- PREVIEW / DOWNLOAD --------
function canvasToJpegURL(q=0.92){
  return cv.toDataURL("image/jpeg", q);
}

$("#preview").onclick=()=>{
  draw("screen");
  try{
    $("#jpegImg").src = canvasToJpegURL(0.92);
    $("#jpegBox").style.display="block";
  }catch(e){
    alert("Preview failed.");
  }
};

$("#download").onclick=()=>{
  draw("download"); // blue banner + date only on downloaded jpeg
  const base=(f.name.value.trim()||"pbis_canvas").replace(/\s+/g,"_");
  const file=base+"_LANDSCAPE.jpg";

  const restore = ()=> setTimeout(()=>draw("screen"), 60);

  if(cv.toBlob){
    cv.toBlob(blob=>{
      if(!blob){ alert("Download failed."); restore(); return; }
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download=file; a.rel="noopener";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>{ try{URL.revokeObjectURL(url);}catch(e){} }, 1400);
      restore();
    },"image/jpeg",0.95);
  }else{
    try{
      const a=document.createElement("a");
      a.href=canvasToJpegURL(0.95);
      a.download=file;
      document.body.appendChild(a); a.click(); a.remove();
    }catch(e){
      alert("Download failed.");
    }
    restore();
  }
};

// fallback tab (Sites-safe)
$("#openTab").onclick=()=>{
  draw("download");
  try{
    const url = canvasToJpegURL(0.95);
    const w = window.open();
    if(!w){ alert("Pop-up blocked. Use Preview and long-press save."); draw("screen"); return; }
    w.document.write(`<title>PBIS JPEG</title><img src="${url}" style="max-width:100%;height:auto;display:block;margin:0 auto"/>`);
    w.document.close();
  }catch(e){
    alert("Open tab failed.");
  }
  setTimeout(()=>draw("screen"), 80);
};

// clear
$("#clear").onclick=()=>{
  f.name.value=""; f.group.value="";
  f.a1.value=""; f.b1.value=""; f.g1.value="";
  f.c1.checked=f.c2.checked=f.c3.checked=f.c4.checked=f.c5.checked=false;
  S.check=S.reflect=S.goal=false;
  Object.values(btns).forEach(b=>b.classList.remove("on"));
  hideJpeg();
  draw("screen");
};

// init
setTimeout(()=>{ fit(); draw("screen"); }, 80);
</script>
</body>
</html>
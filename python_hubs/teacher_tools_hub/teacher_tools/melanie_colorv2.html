<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ms. Melanie‚Äôs Coloring Studio</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:'Comic Sans MS','Chalkboard SE','Comic Neue',cursive,sans-serif;
  background:linear-gradient(135deg,#ffd6e8,#f9a8d4);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
}

.container{
  width:100%;
  max-width:1200px;
  background:#fff;
  border-radius:24px;
  padding:32px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
  border:6px solid #f472b6;
}

h1{text-align:center;font-size:3em;color:#db2777;margin-bottom:10px}
.subtitle{text-align:center;color:#9d174d;font-size:1.3em;margin-bottom:30px}

/* HUB */
.hub{text-align:center}

.start-btn{
  padding:16px 48px;
  font-size:1.4em;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg,#f472b6,#ec4899);
  color:white;
  cursor:pointer;
  font-weight:bold;
}

/* APP */
.app{display:none;margin-top:20px}

.toolbar{
  display:flex;
  gap:12px;
  justify-content:center;
  margin-bottom:14px;
  flex-wrap:wrap;
}

.tool-btn{
  padding:10px 16px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:bold;
}

.spicy{background:linear-gradient(135deg,#ff6b6b,#ff8fab);color:white}
.clear{background:#fde68a;color:#78350f}
.save{background:#34c759;color:white}

canvas{
  display:block;
  margin:0 auto;
  border:4px solid #f472b6;
  border-radius:18px;
  background:transparent; /* drawing layer stays clean */
  touch-action:none;
}

/* SIGNATURE MODAL */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  padding:16px;
}

.modal{
  width:min(520px, 96vw);
  background:#fff;
  border-radius:24px;
  padding:26px;
  text-align:center;
  box-shadow:0 18px 60px rgba(0,0,0,.25);
}

.modal h2{
  font-size:34px;
  color:#7c83ff;
  margin-bottom:6px;
}

.modal p{
  color:#6b7280;
  margin-bottom:14px;
}

.sig-input{
  width:100%;
  padding:14px;
  font-size:22px;
  border-radius:12px;
  border:3px solid #7c83ff;
  margin-top:8px;
  font-family:'Comic Sans MS','Chalkboard SE','Comic Neue',cursive,sans-serif;
}

.big-btn{
  margin-top:14px;
  padding:12px 18px;
  font-size:20px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  width:100%;
}

.btn-add{background:#34c759;color:white}
.btn-skip{background:#9ca3af;color:white}

.row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}
@media (max-width:520px){
  .row{grid-template-columns:1fr}
}

/* tiny toast */
.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  background:#111827;
  color:#fff;
  padding:10px 12px;
  border-radius:12px;
  font-size:14px;
  opacity:0;
  pointer-events:none;
  transition:opacity .2s ease;
  z-index:10000;
}
.toast.show{opacity:1}
</style>
</head>

<body>
<div class="container">

  <h1>üé® Ms. Melanie‚Äôs Coloring Studio</h1>
  <div class="subtitle">Create ‚Ä¢ Color ‚Ä¢ Rainbow Pepper üåàüå∂Ô∏è</div>

  <div class="hub" id="hub">
    <button class="start-btn" onclick="start()">Start Coloring</button>
  </div>

  <div class="app" id="app">
    <div class="toolbar">
      <button class="tool-btn spicy" id="spicyBtn" onclick="toggleRainbowPepper()">üåàüå∂Ô∏è Rainbow Pepper</button>
      <button class="tool-btn clear" onclick="clearCanvas()">üßº Clear</button>
      <button class="tool-btn save" onclick="openSignature()">‚úÖ Finish & Save</button>
    </div>

    <canvas id="canvas" width="900" height="600"></canvas>
  </div>

</div>

<!-- Signature Modal -->
<div class="modal-backdrop" id="sigBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
    <h2 id="sigTitle">‚úçÔ∏è Sign Your Masterpiece</h2>
    <p>Type your name (used for signature + filename)</p>
    <input class="sig-input" id="studentName" placeholder="Student Name..." autocomplete="off" />

    <div class="row">
      <button class="big-btn btn-add" onclick="saveWithSignature()">Add Signature & Save</button>
      <button class="big-btn btn-skip" onclick="saveWithoutSignature()">Skip & Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const hub = document.getElementById("hub");
const app = document.getElementById("app");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const sigBackdrop = document.getElementById("sigBackdrop");
const studentNameEl = document.getElementById("studentName");
const toastEl = document.getElementById("toast");
const spicyBtn = document.getElementById("spicyBtn");

/* ========= UNIVERSAL FRAME (no external file, Google Sites safe) =========
   This is a compact inline SVG (white base + pink/purple border).
   It's used BOTH as the visible canvas background and baked into the export.
*/
const FRAME_SRC = `data:image/svg+xml;utf8,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 900 600'>
  <defs>
    <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
      <stop offset='0%' stop-color='%23ff5a5f'/>
      <stop offset='100%' stop-color='%237c4dff'/>
    </linearGradient>
  </defs>
  <rect width='900' height='600' fill='white'/>
  <rect x='12' y='12' width='876' height='576'
        fill='none' stroke='url(%23g)' stroke-width='20' rx='40'/>
</svg>`;

const frameImg = new Image();
frameImg.src = FRAME_SRC;

function applyFrameBackground(){
  // visible while drawing (CSS background only; does not affect ink pixels)
  canvas.style.backgroundImage = `url("${FRAME_SRC}")`;
  canvas.style.backgroundSize = "cover";
  canvas.style.backgroundPosition = "center";
  canvas.style.backgroundRepeat = "no-repeat";
}
/* ====================================================================== */

let drawing = false;
let rainbow = false;

// smoother drawing
ctx.lineJoin = "round";
ctx.lineCap = "round";

function showToast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 1300);
}

function start(){
  hub.style.display = "none";
  app.style.display = "block";
  applyFrameBackground();
  canvas.style.cursor = "crosshair";
}

function toggleRainbowPepper(){
  rainbow = !rainbow;
  spicyBtn.classList.toggle("active", rainbow);
}

function clearCanvas(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

function getPoint(e){
  const r = canvas.getBoundingClientRect();
  // robust for embeds / scaling
  const x = (e.clientX - r.left) * (canvas.width / r.width);
  const y = (e.clientY - r.top)  * (canvas.height / r.height);
  return {x,y};
}

canvas.addEventListener("pointerdown", (e)=>{
  drawing = true;
  canvas.setPointerCapture(e.pointerId);
  const p = getPoint(e);
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
});

canvas.addEventListener("pointermove", (e)=>{
  if(!drawing) return;
  const p = getPoint(e);
  ctx.lineWidth = 6;
  ctx.strokeStyle = rainbow ? `hsl(${Math.random()*360},100%,50%)` : "#db2777";
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
});

function endStroke(){
  drawing = false;
  ctx.beginPath();
}
canvas.addEventListener("pointerup", endStroke);
canvas.addEventListener("pointercancel", endStroke);

/* ===== SIGNATURE MODAL ===== */
function openSignature(){
  sigBackdrop.style.display = "flex";
  sigBackdrop.setAttribute("aria-hidden","false");
  setTimeout(()=>studentNameEl.focus(), 50);
}
function closeSignature(){
  sigBackdrop.style.display = "none";
  sigBackdrop.setAttribute("aria-hidden","true");
}

// click outside closes
sigBackdrop.addEventListener("click", (e)=>{
  if(e.target === sigBackdrop) closeSignature();
});
// escape closes
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" && sigBackdrop.style.display === "flex") closeSignature();
});

function safeSlug(name){
  const cleaned = (name || "")
    .toString()
    .trim()
    .toLowerCase()
    .replace(/['"]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/-+/g,"-")
    .replace(/^-|-$/g,"");
  return cleaned || "student-name";
}

function saveWithSignature(){
  const name = studentNameEl.value.trim();
  if(!name){
    showToast("Type a name first.");
    studentNameEl.focus();
    return;
  }
  exportImage(name, true);
  closeSignature();
}

function saveWithoutSignature(){
  const name = studentNameEl.value.trim() || "student-name";
  exportImage(name, false);
  closeSignature();
}

/* ===== EXPORT (stable, non-transparent, downloads reliably) ===== */
function exportImage(name, withSignature){
  const finish = () => {
    const out = document.createElement("canvas");
    out.width = canvas.width;
    out.height = canvas.height;
    const octx = out.getContext("2d");

    // stable stack: white base ‚Üí frame ‚Üí ink
    octx.fillStyle = "#ffffff";
    octx.fillRect(0,0,out.width,out.height);

    // bake the frame into the export
    octx.drawImage(frameImg, 0, 0, out.width, out.height);

    // draw the student's ink layer (transparent canvas content)
    octx.drawImage(canvas, 0, 0);

    // one-line signature, bottom-right
    if(withSignature){
      const pad = 24;
      octx.save();
      octx.textAlign = "right";
      octx.textBaseline = "alphabetic";
      octx.fillStyle = "rgba(0,0,0,0.85)";
      octx.font = "italic 36px 'Comic Sans MS','Chalkboard SE','Comic Neue',cursive,sans-serif";
      octx.fillText(name, out.width - pad, out.height - pad);
      octx.restore();
    }

    // toBlob is more reliable in some embedded contexts than huge data URLs
    out.toBlob((blob)=>{
      if(!blob){
        // fallback
        const a = document.createElement("a");
        a.href = out.toDataURL("image/png");
        a.download = `masterpiece-${safeSlug(name)}-0.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        return;
      }

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `masterpiece-${safeSlug(name)}-0.png`; // always -0
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }, "image/png");
  };

  // ensure frame is ready (first time only)
  if(frameImg.complete && frameImg.naturalWidth > 0){
    finish();
  } else {
    frameImg.onload = finish;
    frameImg.onerror = () => {
      // still export without frame if something went wrong
      showToast("Frame failed to load ‚Äî exporting anyway.");
      // make a minimal frame-less export
      const out = document.createElement("canvas");
      out.width = canvas.width;
      out.height = canvas.height;
      const octx = out.getContext("2d");
      octx.fillStyle="#ffffff";
      octx.fillRect(0,0,out.width,out.height);
      octx.drawImage(canvas,0,0);
      const a = document.createElement("a");
      a.href = out.toDataURL("image/png");
      a.download = `masterpiece-${safeSlug(name)}-0.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    };
  }
}
</script>

</body>
</html>

